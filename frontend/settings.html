<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>âš™ï¸ ç³»çµ±è¨­å®š | LumiTrack</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f1115;                      /* ä¸»è¦èƒŒæ™¯è‰² (æœ€æ·±) */
            --bg-secondary: #1e1e1e;                 /* æ¬¡è¦èƒŒæ™¯è‰² (ç”¨æ–¼å¡ç‰‡/è¡¨å–®) */
            --neon-blue: #9be4ff;                    /* éœ“è™¹è— (æ”¶å…¥/ä¸»è‰²) */
            --neon-pink: #ff9ccf;                    /* éœ“è™¹ç²‰ (æ”¯å‡º/å‰¯è‰²) */
            --neon-green: #7df2a8;                   /* å„²å­˜æŒ‰éˆ• */
            --neon-yellow: #fff1a6;                  /* å¼·èª¿è‰² */
            --text-light: #e9f7ff;                   /* æ–‡å­—æ·ºè‰² */
            --text-dark: #c4d9ee;                    /* æ–‡å­—æ·±è‰² */

            --cat-1: #ff7f7f;
            --cat-2: #ffcc66;
            --cat-3: #a8f0c6;
            --cat-4: #a7d7ff;
            --cat-5: #ffb3cf;
            --cat-6: #cf9cff;
            --cat-7: #66ffcc;
            --cat-8: #ff9c66;
            --cat-9: #99ccff;
            --cat-10: #d4d4d4;
            --cat-11: #ffd1dc;
            --cat-12: #ffe066;
            --cat-13: #8affc1;
            --cat-14: #8ed1ff;
            --cat-15: #c9a7ff;
            --cat-16: #ffb380;
            --cat-17: #b3ffb3;
            --cat-18: #b3d9ff;
            --cat-19: #ffe6b3;
            --cat-20: #ffadad;
        }

        /* é‡å°æ•´å€‹ body å…ƒç´  */
        body::-webkit-scrollbar {
            width: 0px;  /* éš±è—å‚ç›´æ»¾å‹•æ¢ */
            height: 0px; /* éš±è—æ°´å¹³æ»¾å‹•æ¢ */
        }

        body::-webkit-scrollbar,
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        /* é‡å°éœ€è¦æ»¾å‹•çš„ç‰¹å®šå®¹å™¨ (å¦‚ä¸»è¦çš„å…§å®¹å€å¡Š) */
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        /* 1. é‡å°æ‰€æœ‰å…ƒç´ ï¼ˆåŒ…å« body å’Œæ‰€æœ‰ divï¼‰éš±è—æ»¾å‹•æ¢ï¼Œä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ */
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
        }

        *::-webkit-scrollbar {
            display: none;             /* Chrome, Safari, Opera */
            width: 0 !important;
            height: 0 !important;
        }

        /* 2. ç¢ºä¿ html å’Œ body ä¹Ÿå®Œå…¨éš±è— */
        html, body {
            overflow: -moz-scrollbars-none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            margin: 0; padding: 20px;
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: system-ui, -apple-system, sans-serif;
            scrollbar-width: none;
        }
        
        .container { max-width: 720px; margin: auto; }
        .page-title { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); font-size: 1.8em; text-align: center; margin-bottom: 30px; }

        .card {
            background: var(--bg-secondary);
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 22px;
            border: 1px solid var(--border-color);
            box-shadow: 0 12px 28px rgba(0,0,0,0.5);
        }

        .card-title { display: flex; align-items: center; gap: 10px; font-size: 1.25rem; font-weight: bold; margin-bottom: 8px; color: var(--neon-blue); }
        .card-desc { font-size: 0.9rem; color: var(--text-dark); margin-bottom: 16px; }

        /* è²¨å¹£é¸æ“‡æ¨£å¼ */
        .currency-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }

        button, .custom-select {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: #252525;
            color: var(--text-light);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }

        button:hover { border-color: var(--neon-blue); background: #2a2a2a; }

        /* é¸ä¸­ç‹€æ…‹ */
        button.active, .custom-select.active {
            background: var(--neon-blue);
            color: #000;
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px var(--neon-blue);
        }

        /* ä¸‹æ‹‰é¸å–®ç‰¹åˆ¥æ¨£å¼ */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23a7d7ff' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 30px;
            outline: none;
        }
        .custom-select option { background: var(--bg-dark); color: #fff; }

        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn-group button { flex: 1; min-width: 120px; }

        /* --- å¼·åŒ–ç‰ˆå±éšªå€åŸŸæ¨£å¼ --- */
        .danger-card {
            position: relative;
            border: 2px solid var(--neon-red) !important;
            background: rgba(255, 60, 60, 0.05) !important;
            overflow: hidden;
            /* å‘¼å¸é–ƒçˆæ•ˆæœ */
            animation: danger-pulse 2s infinite alternate;
        }

        @keyframes danger-pulse {
            from { box-shadow: 0 0 10px rgba(255, 127, 127, 0.2); }
            to { box-shadow: 0 0 25px rgba(255, 127, 127, 0.5); }
        }

        /* é ‚éƒ¨è­¦ç¤ºæ¢ç´‹ */
        .danger-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: repeating-linear-gradient(
                45deg,
                #ff7f7f,
                #ff7f7f 10px,
                #000 10px,
                #000 20px
            );
        }

        .danger-input-group {
            margin-top: 15px;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
            border: 1px dashed var(--neon-red);
        }

        .danger-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--neon-pink);
            margin-bottom: 8px;
        }

        .danger-input-group input {
            width: 100%;
            background: #151515;
            border: 1px solid #444;
            padding: 10px;
            color: #fff;
            border-radius: 8px;
            font-family: monospace;
            text-align: center;
            letter-spacing: 2px;
            box-sizing: border-box;
        }

        .danger-input-group input:focus {
            border-color: var(--neon-red);
            outline: none;
            box-shadow: 0 0 8px var(--neon-red);
        }

        /* ç¦ç”¨ç‹€æ…‹çš„æŒ‰éˆ• */
        .danger-btn:disabled {
            filter: grayscale(1);
            opacity: 0.3;
            cursor: not-allowed;
            box-shadow: none;
        }
        .danger-btn { background: transparent; border-color: var(--neon-red); color: var(--neon-red); }
        .danger-btn:hover { background: var(--neon-red); color: #fff; box-shadow: 0 0 15px var(--neon-red); }

        .go-btn { background: rgba(167, 215, 255, 0.1); color: var(--neon-blue); border-color: var(--neon-blue); }
        
    </style>
</head>
<body>

<div class="container">
    <h1 class="page-title"><i class="fas fa-microchip"></i> æ ¸å¿ƒç³»çµ±è¨­å®š</h1>

    <div class="card">
        <div class="card-title"><i class="fas fa-sitemap"></i> åˆ†é¡æ¶æ§‹ç®¡ç†</div>
        <div class="card-desc">è‡ªå®šç¾©æ‚¨çš„æ”¶æ”¯é¡åˆ¥ï¼Œç³»çµ±å°‡è‡ªå‹•å¥—ç”¨è‡³æ‰€æœ‰å ±è¡¨ã€‚</div>
        <button class="go-btn" style="width:100%" onclick="location.href='category.html'">
            <i class="fas fa-external-link-alt"></i> é€²å…¥åˆ†é¡ç·¨è¼¯å™¨
        </button>
    </div>

    <div class="card">
        <div class="card-title"><i class="fas fa-globe"></i> åŸºæº–è²¨å¹£è¨­å®š</div>
        <div class="card-desc">é¸æ“‡ç³»çµ±çš„ä¸»è²¨å¹£ï¼Œé€™å°‡å½±éŸ¿åŒ¯ç¸½å ±è¡¨çš„é¡¯ç¤ºã€‚</div>
        <div class="currency-container" id="currencyArea">
            <button data-currency="TWD">TWD å°å¹£</button>
            <button data-currency="USD">USD ç¾é‡‘</button>
            <button data-currency="JPY">JPY æ—¥å¹£</button>
            <button data-currency="EUR">EUR æ­å…ƒ</button>
            <select id="otherCurrency" class="custom-select">
                <option value="" disabled selected>å…¶ä»–è²¨å¹£</option>
                <option value="HKD">HKD æ¸¯å¹£</option>
                <option value="CNY">CNY äººæ°‘å¹£</option>
                <option value="GBP">GBP è‹±éŠ</option>
                <option value="AUD">AUD æ¾³å¹£</option>
                <option value="KRW">KRW éŸ“å…ƒ</option>
                <option value="SGD">SGD æ–°å¹£</option>
            </select>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fas fa-cloud-download-alt"></i> æ•¸æ“šå‚™ä»½èˆ‡å°å‡º</div>
        <div class="card-desc">åŒ¯å‡ºå« Excel çµ±è¨ˆè¡¨èˆ‡å®Œæ•´æ•¸æ“šçš„ ZIP å£“ç¸®åŒ…ã€‚</div>
        <div class="btn-group">
            <button onclick="exportFullBackup()"><i class="fas fa-file-export"></i> å®Œæ•´åŒ¯å‡º (ZIP)</button>
            <button onclick="document.getElementById('importZipFile').click()"><i class="fas fa-file-import"></i> é‚„åŸå‚™ä»½</button>
            <input type="file" id="importZipFile" style="display:none" accept=".zip" />
        </div>
    </div>

    <div class="card danger-card">
        <div class="card-title" style="color:var(--neon-red)">
            <i class="fas fa-biohazard"></i>  å±éšªå€åŸŸ
        </div>
        <div class="card-desc">
            åˆå§‹åŒ–å°‡æœƒæŠ¹é™¤æ‰€æœ‰äº¤æ˜“ã€è‡ªå®šç¾©åˆ†é¡ä»¥åŠé ç®—è¨­å®šã€‚æ­¤æ“ä½œä¸€æ—¦åŸ·è¡Œï¼Œå­˜å„²æ–¼ç€è¦½å™¨å…§çš„æ•¸æ“šå°‡æ¶ˆæ•£ã€‚
        </div>

        <div class="danger-input-group">
            <label>è«‹åœ¨ä¸‹æ–¹è¼¸å…¥ <b style="color:var(--text-light)">RESET</b> ä»¥è§£é™¤æŒ‰éˆ•é–å®šï¼š</label>
            <input type="text" id="confirmResetInput" placeholder="åœ¨æ­¤è¼¸å…¥..." autocomplete="off" oninput="checkResetLock()">
        </div>

        <button id="finalDeleteBtn" class="danger-btn" style="width:100%; margin-top:15px;" onclick="clearAllData()" disabled>
            <i class="fas fa-skull-crossbones"></i> åŸ·è¡Œç³»çµ±é‡ç½®
        </button>
    </div>

    <script>
        
        const STORAGE_KEYS = {
            TX: 'transactions',
            CAT: 'categoryData',
            BUD: 'budget_settings',
            IMGS: 'receiptImages',
            CUR: 'app_currency'
        };

        // ç³»çµ±é è¨­è³‡æ–™ (é˜²æ­¢åŒ¯å‡ºç©ºè³‡æ–™)
        const DEFAULT_DATA = {
            categories: {
                expense: [
                    { id: 1, name: "é¤é£²", icon: "fas fa-utensils", color: "var(--cat-1)", sub: [
                        { id: 101, name: "å¤–é£Ÿ", icon: "fas fa-burger", color: "var(--cat-1)" },
                        { id: 102, name: "é£²å“", icon: "fas fa-coffee", color: "var(--cat-1)" },
                        { id: 103, name: "é›¶é£Ÿ", icon: "fas fa-cookie-bite", color: "var(--cat-1)" },
                    ]},
                    { id: 2, name: "äº¤é€š", icon: "fas fa-bus", color: "var(--cat-2)", sub: [
                        { id: 201, name: "æ²¹è³‡/å……é›»", icon: "fas fa-gas-pump", color: "var(--cat-2)" },
                        { id: 202, name: "å…¬è»Š/æ·é‹", icon: "fas fa-subway", color: "var(--cat-2)" },
                        { id: 203, name: "è¨ˆç¨‹è»Š", icon: "fas fa-taxi", color: "var(--cat-2)" },
                    ]},
                    { id: 3, name: "è³¼ç‰©", icon: "fas fa-shopping-bag", color: "var(--cat-3)", sub: [
                        { id: 301, name: "æœé£¾", icon: "fas fa-shirt", color: "var(--cat-3)" },
                        { id: 302, name: "æ—¥ç”¨å“", icon: "fas fa-toilet-paper", color: "var(--cat-3)" },
                        { id: 303, name: "3C ç”¢å“", icon: "fas fa-mobile-screen-button", color: "var(--cat-3)" },
                    ]},
                    { id: 4, name: "å¨›æ¨‚", icon: "fas fa-gamepad", color: "var(--cat-4)", sub: [
                        { id: 401, name: "é›»å½±/å±•è¦½", icon: "fas fa-ticket", color: "var(--cat-4)" },
                        { id: 402, name: "éŠæˆ²", icon: "fas fa-dice", color: "var(--cat-4)" },
                        { id: 403, name: "æ—…éŠ", icon: "fas fa-plane", color: "var(--cat-4)" },
                    ]},
                    { id: 5, name: "å±…ä½", icon: "fas fa-home", color: "var(--cat-5)", sub: [
                        { id: 501, name: "æˆ¿ç§Ÿ/æˆ¿è²¸", icon: "fas fa-building-columns", color: "var(--cat-5)" },
                        { id: 502, name: "æ°´é›»ç“¦æ–¯", icon: "fas fa-lightbulb", color: "var(--cat-5)" },
                        { id: 503, name: "ç¶²è·¯/é›»ä¿¡", icon: "fas fa-signal", color: "var(--cat-5)" },
                    ]}
                ],
                income: [
                    { id: 6, name: "è–ªè³‡", icon: "fas fa-money-check-alt", color: "var(--cat-6)", sub: [
                        { id: 601, name: "æœˆè–ª", icon: "fas fa-money-bill-wave", color: "var(--cat-6)" },
                        { id: 602, name: "çé‡‘", icon: "fas fa-hand-holding-dollar", color: "var(--cat-6)" },
                        { id: 603, name: "å…¼è·", icon: "fas fa-briefcase", color: "var(--cat-6)" },
                    ]},
                    { id: 7, name: "æŠ•è³‡", icon: "fas fa-chart-line", color: "var(--cat-7)", sub: [
                        { id: 701, name: "è‚¡æ¯", icon: "fas fa-arrow-trend-up", color: "var(--cat-7)" },
                        { id: 702, name: "åŸºé‡‘æ”¶ç›Š", icon: "fas fa-vault", color: "var(--cat-7)" },
                        { id: 703, name: "æˆ¿ç”¢ç§Ÿé‡‘", icon: "fas fa-house-chimney-crack", color: "var(--cat-7)" },
                    ]},
                    { id: 8, name: "ç¦®é‡‘", icon: "fas fa-gift", color: "var(--cat-8)", sub: [
                        { id: 801, name: "ç´…åŒ…", icon: "fas fa-envelope", color: "var(--cat-8)" },
                        { id: 802, name: "ç”Ÿæ—¥ç¦®ç‰©", icon: "fas fa-cake-candles", color: "var(--cat-8)" },
                        { id: 803, name: "è´ŠåŠ©", icon: "fas fa-heart", color: "var(--cat-8)" },
                    ]},
                    { id: 9, name: "å‰¯æ¥­", icon: "fas fa-laptop-code", color: "var(--cat-9)", sub: [
                        { id: 901, name: "ç¨¿è²»", icon: "fas fa-pen-nib", color: "var(--cat-9)" },
                        { id: 902, name: "éŠ·å”®", icon: "fas fa-store", color: "var(--cat-9)" },
                        { id: 903, name: "æœå‹™è²»", icon: "fas fa-handshake", color: "var(--cat-9)" },
                    ]},
                    { id: 10, name: "å…¶ä»–", icon: "fas fa-ellipsis-h", color: "var(--cat-10)", sub: [
                        { id: 1101, name: "é€€æ¬¾", icon: "fas fa-undo", color: "var(--cat-10)" },
                        { id: 1102, name: "æ„å¤–æ”¶å…¥", icon: "fas fa-meteor", color: "var(--cat-10)" },
                        { id: 1103, name: "åˆ©æ¯", icon: "fas fa-percent", color: "var(--cat-10)" },
                    ]}
                ]
            },
            currency: { base: 'TWD', symbol: 'NT$' }
        };

        const SYMBOL_MAP = { TWD: 'NT$', USD: '$', JPY: 'Â¥', EUR: 'â‚¬', HKD: 'HK$', CNY: 'Â¥', GBP: 'Â£', AUD: 'A$', KRW: 'â‚©', SGD: 'S$' };

        document.addEventListener('DOMContentLoaded', () => {
            initCurrencyUI();
        });

        /* ===============================
        è²¨å¹£è™•ç†é‚è¼¯
        =============================== */
        function initCurrencyUI() {
            const current = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUR)) || DEFAULT_DATA.currency;
            const btns = document.querySelectorAll('#currencyArea button');
            const select = document.getElementById('otherCurrency');

            function updateUI(base) {
                btns.forEach(b => b.classList.toggle('active', b.dataset.currency === base));
                
                const isOther = Array.from(select.options).some(opt => opt.value === base);
                select.classList.toggle('active', isOther);
                if(isOther) select.value = base;
                else select.value = "";
            }

            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    saveCurrency(btn.dataset.currency);
                    updateUI(btn.dataset.currency);
                });
            });

            select.addEventListener('change', () => {
                saveCurrency(select.value);
                updateUI(select.value);
            });

            updateUI(current.base);
        }

        function saveCurrency(base) {
            const setting = { base, symbol: SYMBOL_MAP[base] || base };
            localStorage.setItem(STORAGE_KEYS.CUR, JSON.stringify(setting));
            window.dispatchEvent(new StorageEvent('storage', { key: STORAGE_KEYS.CUR }));
        }

        /* ===============================
        å¼·åŒ–ç‰ˆ åŒ¯å‡ºé‚è¼¯
        =============================== */
        async function exportFullBackup() {
            const zip = new JSZip();
            
            // å–å¾—è³‡æ–™ï¼Œè‹¥ç‚ºç©ºå‰‡æŠ“é è¨­
            const txData = JSON.parse(localStorage.getItem(STORAGE_KEYS.TX) || '[]');
            const catData = JSON.parse(localStorage.getItem(STORAGE_KEYS.CAT)) || DEFAULT_DATA.categories;
            const budData = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUD)) || {};
            const curData = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUR)) || DEFAULT_DATA.currency;
            const imgData = JSON.parse(localStorage.getItem(STORAGE_KEYS.IMGS) || '{}');

            const payload = {
                meta: { app: 'LumiTrack', version: '1.2', exportedAt: new Date().toISOString() },
                transactions: txData,
                categories: catData,
                budgets: budData,
                currency: curData,
                images: imgData
            };

            // 1. JSON åŸå§‹æª”
            zip.file('lumi_data_backup.json', JSON.stringify(payload, null, 2));

            // 2. Excel å ±è¡¨
            const wb = XLSX.utils.book_new();
            
            // Sheet A: äº¤æ˜“æ˜ç´°æ¸…å–®
            const detailRows = txData.map(t => ({
                æ—¥æœŸ: t.date || '',
                é¡å‹: t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                ä¸»åˆ†é¡: t.categoryObject?.primary?.name || 'æœªåˆ†é¡',
                å­åˆ†é¡: t.categoryObject?.sub?.name || '-',
                é‡‘é¡: Number(t.amount || 0),
                åŸå§‹è²¨å¹£: t.currency || curData.base,
                å‚™è¨»: t.note || ''
            }));
            const wsDetails = XLSX.utils.json_to_sheet(detailRows);
            XLSX.utils.book_append_sheet(wb, wsDetails, 'äº¤æ˜“æ˜ç´°');

            // Sheet B: åˆ†é¡çµ±è¨ˆ (ç”¨æ–¼åœ–è¡¨)
            const summaryMap = {};
            txData.forEach(t => {
                const key = `${t.type}|${t.categoryObject?.primary?.name || 'æœªåˆ†é¡'}`;
                if(!summaryMap[key]) summaryMap[key] = { é¡å‹: t.type==='income'?'æ”¶å…¥':'æ”¯å‡º', åˆ†é¡: t.categoryObject?.primary?.name || 'æœªåˆ†é¡', ç¸½é¡: 0, ç­†æ•¸: 0 };
                summaryMap[key].ç¸½é¡ += Number(t.baseAmount || t.amount || 0);
                summaryMap[key].ç­†æ•¸ += 1;
            });
            const wsSummary = XLSX.utils.json_to_sheet(Object.values(summaryMap));
            XLSX.utils.book_append_sheet(wb, wsSummary, 'åˆ†é¡çµ±è¨ˆåœ–è¡¨æ•¸æ“š');

            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            zip.file('æ•¸æ“šåˆ†æå ±è¡¨.xlsx', excelBuffer);

            // ä¸‹è¼‰ ZIP
            const content = await zip.generateAsync({ type: 'blob' });
            saveAs(content, `LumiTrack_Backup_${new Date().toISOString().slice(0,10)}.zip`);
        }

        /* ===============================
        åŒ¯å…¥èˆ‡æ¸…é™¤
        =============================== */
        document.getElementById('importZipFile').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file || !confirm('âš ï¸ åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰æ‰€æœ‰è¨­å®šèˆ‡ç´€éŒ„ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) return;

            try {
                const zip = await JSZip.loadAsync(file);
                const jsonFile = zip.file('lumi_data_backup.json');
                if(!jsonFile) throw new Error('æ‰¾ä¸åˆ°å‚™ä»½æ•¸æ“šæª”æ¡ˆ');

                const data = JSON.parse(await jsonFile.async('string'));

                localStorage.setItem(STORAGE_KEYS.TX, JSON.stringify(data.transactions || []));
                localStorage.setItem(STORAGE_KEYS.CAT, JSON.stringify(data.categories || DEFAULT_DATA.categories));
                localStorage.setItem(STORAGE_KEYS.BUD, JSON.stringify(data.budgets || {}));
                localStorage.setItem(STORAGE_KEYS.CUR, JSON.stringify(data.currency || DEFAULT_DATA.currency));
                localStorage.setItem(STORAGE_KEYS.IMGS, JSON.stringify(data.images || {}));

                alert('âœ… æ•¸æ“šé‚„åŸæˆåŠŸï¼');
                location.reload();
            } catch (err) {
                alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
            }
        });

        // 1. æª¢æŸ¥è§£é–å­—ä¸²
        function checkResetLock() {
            const input = document.getElementById('confirmResetInput').value;
            const btn = document.getElementById('finalDeleteBtn');
            
            if (input.trim().toUpperCase() === 'RESET') {
                btn.disabled = false;
                btn.style.boxShadow = '0 0 20px var(--neon-red)';
            } else {
                btn.disabled = true;
                btn.style.boxShadow = 'none';
            }
        }

        // 2. å¼·åŒ–ç‰ˆæ¸…é™¤é‚è¼¯
        window.clearAllData = function() {
            // é›–ç„¶å·²ç¶“è¼¸å…¥ RESETï¼Œä½†ç‚ºäº†ä¿éšªèµ·è¦‹å†åšä¸€æ¬¡æœ€å¾Œç¢ºèª
            const finalWarning = confirm('ğŸš¨ æœ€å¾Œè­¦å‘Šï¼šæ•¸æ“šå³å°‡æ°¸ä¹…åˆªé™¤ï¼\n\næ‚¨ç¢ºå®šçœŸçš„è¦åŸ·è¡Œå—ï¼Ÿé€™ä¸å¯é‚„åŸã€‚');
            
            if(finalWarning) {
                // åŠ å…¥ä¸€å€‹ã€Œæ¯€æ»…ä¸­ã€çš„è¦–è¦ºå›é¥‹
                const btn = document.getElementById('finalDeleteBtn');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æŠ¹é™¤æ•¸æ“šæ ¸å¿ƒ...';
                btn.disabled = true;

                setTimeout(() => {
                    Object.values(STORAGE_KEYS).forEach(k => localStorage.removeItem(k));
                    alert('ğŸ›‘ ç³»çµ±å·²åˆå§‹åŒ–ã€‚æ‰€æœ‰æ•¸æ“šå·²æ­¸é›¶ã€‚');
                    location.reload();
                }, 1500); // å¢åŠ ä¸€é»å»¶é²æ„Ÿï¼Œè®“æ“ä½œé¡¯å¾—æ›´æ²ˆé‡
            }
        };
    </script>

</body>
</html>