<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡️ 新增交易紀錄與分類管理 | 量子記帳系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --------------------------- 全域與霓虹變數 --------------------------- */
        :root {
            --bg-dark: #0f1115;                      /* 主要背景色 (最深) */
            --bg-secondary: #1e1e1e;                 /* 次要背景色 (用於卡片/表單) */
            --neon-blue: #9be4ff;                    /* 霓虹藍 (收入/主色) */
            --neon-pink: #ff9ccf;                    /* 霓虹粉 (支出/副色) */
            --neon-green: #7df2a8;                   /* 儲存按鈕 */
            --neon-yellow: #fff1a6;                  /* 強調色 */
            --text-light: #e9f7ff;                   /* 文字淺色 */
            --text-dark: #c4d9ee;                    /* 文字深色 */

            --cat-1: #ff7f7f;
            --cat-2: #ffcc66;
            --cat-3: #a8f0c6;
            --cat-4: #a7d7ff;
            --cat-5: #ffb3cf;
            --cat-6: #cf9cff;
            --cat-7: #66ffcc;
            --cat-8: #ff9c66;
            --cat-9: #99ccff;
            --cat-10: #d4d4d4;
            --cat-11: #ffd1dc;
            --cat-12: #ffe066;
            --cat-13: #8affc1;
            --cat-14: #8ed1ff;
            --cat-15: #c9a7ff;
            --cat-16: #ffb380;
            --cat-17: #b3ffb3;
            --cat-18: #b3d9ff;
            --cat-19: #ffe6b3;
            --cat-20: #ffadad;
        }

        /* 統一的霓虹樣式 */
        .neon-text {
            text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue);
            transition: text-shadow 0.3s;
        }
        
        .neon-pink-text {
            text-shadow: 0 0 5px var(--neon-pink), 0 0 10px var(--neon-pink);
            transition: text-shadow 0.3s;
        }

        .neon-shadow {
            box-shadow: 0 0 10px rgba(167, 215, 255, 0.3), 0 0 20px rgba(167, 215, 255, 0.1);
            transition: box-shadow 0.3s;
        }

        /* Active 狀態按鈕的霓虹光暈 */
        .active-neon-glow {
            box-shadow: 0 0 8px var(--neon-blue), 0 0 15px var(--neon-blue)50;
            border-color: var(--neon-blue) !important;
        }

        /* 統一 Font-Awesome 圖標樣式 */
        .fa, .fas, .far, .fab {
            margin-right: 5px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Noto Sans TC', 'Poppins', '微軟正黑體', sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox (雖然您主要使用的是 Webkit/MS，但統一加上) */
        }

        /* --------------------------- 隱藏滾動條：Webkit 核心瀏覽器 (Chrome, Safari) --------------------------- */
        /* 針對整個 body 元素 */
        body::-webkit-scrollbar {
            width: 0px;  /* 隱藏垂直滾動條 */
            height: 0px; /* 隱藏水平滾動條 */
        }

        body::-webkit-scrollbar,
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        /* 1. 針對所有元素（包含 body 和所有 div）隱藏滾動條，但保留滾動功能 */
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
        }

        *::-webkit-scrollbar {
            display: none;             /* Chrome, Safari, Opera */
            width: 0 !important;
            height: 0 !important;
        }

        /* 2. 確保 html 和 body 也完全隱藏 */
        html, body {
            overflow: -moz-scrollbars-none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        /* 針對需要滾動的特定容器 (如主要的內容區塊) */
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        .record-container {
            max-width: 1000px;
            margin: 20px auto;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 0 20px rgba(155,228,255,0.05);
        }

        h2 {
            color: var(--neon-blue);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }

        .page-title {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue); /* 統一標題霓虹效果 */
            font-size: 1.8em;
            margin-bottom: 25px;
        }

        /* --------------------------- 表單樣式 --------------------------- */
        .form-group {
            margin-bottom: 25px; /* 統一間距 */
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 1rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        /* 基礎 input 樣式 */
        input:not([type="radio"]):not([type="checkbox"]):not([type="file"]):not([type="color"]),
        select, textarea {
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--bg-secondary);
            color: var(--text-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 8px rgba(155, 228, 255, 0.4);
            outline: none;
            background: #252525;
        }

        input[type="date"] {
            padding-right: 45px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        input[type="date"]::-moz-calendar-picker-indicator {
            color: #ffffff;
            cursor: pointer;
        }

        /* --------------------------- 貨幣輸入組 --------------------------- */
        .input-group {
            display: flex;
            align-items: center;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .input-group:focus-within {
            border-color: var(--neon-blue);
            box-shadow: 0 0 8px rgba(155, 228, 255, 0.4);
        }

        .input-group input {
            border: none !important;
            background: transparent !important;
            padding: 14px 16px !important;
            flex-grow: 1;
            box-shadow: none !important;
        }

        .input-currency {
            padding: 14px 0 14px 18px;
            color: var(--neon-yellow);
            font-weight: bold;
            font-size: 0.95rem;
            border-right: 1px solid rgba(255,255,255,0.08);
            user-select: none;
            min-width: 60px;
            text-align: center;
        }

        /* --------------------------- 圖片上傳優化 (非新增分類用) --------------------------- */
        .file-upload-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .file-control-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 8px;
        }

        .file-upload-label {
            display: inline-block;
            padding: 12px 20px;
            cursor: pointer;
            background: var(--neon-blue);
            color: var(--neon-yellow) !important;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            user-select: none;
            white-space: nowrap;
            border: 2px solid transparent;
        }

        .file-upload-label:hover {
            background: #c7eeff;
            box-shadow: 0 0 15px rgba(155, 228, 255, 0.5);
            transform: translateY(-1px);
        }

        .file-name-display-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .file-name-display {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-dark);
            min-height: 1.2em;
            flex-grow: 1;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .clear-image-btn {
            border: none;
            background: transparent;
            color: var(--neon-pink);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
            margin: 0;
            transition: all 0.2s ease;
            border-radius: 5px;
        }

        .clear-image-btn:hover {
            color: var(--cat-red);
            background: rgba(255, 127, 127, 0.1);
            transform: scale(1.1);
        }

        #imagePreviewContainer {
            margin-top: 20px;
            padding: 0;
            background: var(--bg-dark);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #imagePreview {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        /* --------------------------- 分類按鈕 --------------------------- */
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .cat-btn {
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            font-weight: 500;
        }

        .cat-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .cat-btn.active {
            border-color: var(--cat-color);
            background: rgba(var(--cat-color-rgb), 0.15);
            box-shadow: 0 0 15px rgba(var(--cat-color-rgb), 0.5);
            color: var(--cat-color);
            transform: translateY(-2px);
        }

        .cat-btn .cat-icon {
            color: var(--cat-color);
            font-size: 1.1em;
        }

        .cat-btn.add-cat-btn {
            color: var(--neon-blue);
            border: 2px dashed var(--neon-blue);
            background: transparent;
            font-weight: bold;
        }

        .cat-btn.add-cat-btn:hover {
            background: rgba(155, 228, 255, 0.1);
            border-style: solid;
        }

        /* 子分類按鈕區 */
        .sub-category-group {
            /* ⭐️ 核心修正：讓子分類群組有行高過渡效果 */
            display: grid;
            /* 讓子分類按鈕能像主分類一樣自動排列 */
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 8px; 
            
            overflow: hidden;
            max-height: var(--sub-category-height); 
            opacity: var(--sub-category-opacity);
            pointer-events: var(--sub-category-pointer-events);
            transition: 
                max-height 0.4s cubic-bezier(0.25, 0.1, 0.25, 1), 
                opacity 0.3s ease;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.05);
        }
        
        /* ⭐️ 核心修正：子分類的 Label 樣式 */
        .sub-category-label {
            grid-column: 1 / -1; /* 佔滿整行 */
            color: var(--text-dark);
            font-size: 0.9em;
            margin: 0 0 5px 0;
            padding-top: 5px;
        }

        /* --------------------------- 分類排版強制修正 --------------------------- */
        /* 確保分類群組 (Primary/Sub) 內的元素是垂直堆疊的 */
        .category-group {
            /* 如果你的主分類沒有用 flex，請不要加 display: flex; */
            /* 如果主分類用了 flex，請確保 flex-direction 是 column */
            display: flex;
            flex-direction: column; 
            /* 讓裡面的元素 (Label 和 Buttons) 垂直排列 */
            
            /* 確保有足夠的間距和背景 */
            padding: 10px;
            margin-bottom: 20px;
            background-color: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1); /* 保持霓虹卡片樣式 */
        }

        /* 確保 Label 擁有自己的空間，並跟下方按鈕有間隔 */
        .category-label {
            display: flex;
            align-items: center;
            color: var(--text-light);
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px; /* 關鍵：標籤與按鈕之間的間距 */
            padding-left: 5px;
        }

        /* --------------------------- 類型選擇器 (非新增分類用) --------------------------- */
        .type-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 35px;
        }

        .type-btn {
            flex: 1;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .type-btn[data-type="expense"] {
            background: rgba(255, 156, 207, 0.1);
            color: var(--neon-pink);
        }

        .type-btn[data-type="income"] {
            background: rgba(155, 228, 255, 0.1);
            color: var(--neon-blue);
        }

        .type-btn.active[data-type="expense"] {
            border-color: var(--neon-pink);
            box-shadow: 0 0 20px rgba(255, 156, 207, 0.5);
            background: rgba(255, 156, 207, 0.2);
        }

        .type-btn.active[data-type="income"] {
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(155, 228, 255, 0.5);
            background: rgba(155, 228, 255, 0.2);
        }

        .type-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .type-btn:hover::before {
            left: 100%;
        }

        .form-item label {
            font-size: 1em; /* 統一標籤字體大小 */
            color: var(--text-dark);
        }
        .type-btn {
            /* ... 保持原本的樣式 ... */
            font-size: 1.1em; /* 統一按鈕字體大小 */
            transition: all 0.3s;
        }
        .type-btn.active {
            /* 使用統一的 active-neon-glow */
            box-shadow: 0 0 10px rgba(167, 215, 255, 0.5); 
            /* ... 其他顏色設定 ... */
        }

        /* --------------------------- 提交按鈕 --------------------------- */
        .submit-btn {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--neon-blue), #7fbfff);
            color: var(--bg-dark);
            font-weight: bold;
            cursor: pointer;
            margin-top: 35px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 1.2em;
            /* 儲存按鈕使用更強烈的霓虹效果 */
            box-shadow: 0 0 15px var(--neon-green), 0 0 25px var(--neon-green)50;
        }
        
        .full-width-btn {
            margin-top: auto; /* 確保提交按鈕在左側底部 */
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #c7eeff, var(--neon-blue));
            box-shadow: 0 0 25px var(--neon-blue);
            transform: translateY(-2px);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .submit-btn:hover::before {
            left: 100%;
        }

        /* --------------------------- 結果顯示 --------------------------- */
        #resultDisplay {
            margin-top: 30px;
            padding: 18px 20px;
            border-left: 5px solid var(--neon-green);
            background: rgba(125, 242, 168, 0.05);
            border-radius: 8px;
            white-space: pre-wrap;
            color: var(--text-light);
            font-weight: 500;
        }

        /* --------------------------- Modal 樣式 --------------------------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* 移除滾動，讓modal-content處理滾動 */
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 0;
            border: 2px solid var(--neon-blue);
            width: 90%;
            max-width: 950px;
            border-radius: 16px;
            box-shadow: 0 0 30px var(--neon-blue);
            animation: fadeIn 0.4s ease-out;
            overflow: auto; /* 讓滑動條出現在modal內容內部 */
            scrollbar-width: thin;
            scrollbar-color: rgba(155, 228, 255, 0.3) transparent;
            max-height: 90vh; /* 確保modal不會超過視窗高度 */
        }

        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(155, 228, 255, 0.3);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(155, 228, 255, 0.5);
        }
        
        /* 移除舊版 .modal-body, .modal-left, .modal-right 的設定，改用新版 */
        
        .modal-header {
            text-align: center;
            padding: 25px 30px;
            background-color: var(--bg-secondary); /* 統一背景色 */
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .modal-header-center {
            text-align: center;
            justify-content: center;
            padding: 25px 30px;
            background-color: var(--bg-secondary); /* 統一背景色 */
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .modal-header-center h2 {
            margin: 0;
            color: var(--neon-blue);
            font-size: 1.6rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(155,228,255,0.3);
            text-align: center; /* 確保標題文字置中 */
            width: 100%; /* 確保佔滿寬度 */
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            color: var(--text-dark);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            transition: all 0.2s ease;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--neon-pink);
            background: rgba(255, 156, 207, 0.1);
            transform: scale(1.1);
        }


        /* --------------------------- Modal 新佈局設定 (左右分欄與置中標題) --------------------------- */
        .modal-body-split {
            display: flex;
            gap: 30px;
            padding: 30px;
            align-items: stretch;
            background-color: var(--bg-secondary); /* 統一modal內部背景色 */
        }

        .modal-left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            /* 確保內容不會被切斷 */
            min-height: 500px; 
        }
        
        .modal-right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --------------------------- 左側：名稱/顏色/預覽 垂直堆疊 --------------------------- */

        /* 顏色選擇區塊整理 */
        .color-selection-area {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            overflow-x: visible; /* 允許內容溢出 */
        }

        /* 預覽卡片樣式 - ⭐ 確保垂直堆疊時佔滿左欄 (Name -> Color -> Preview) */
        .preview-card {
            background-color: var(--bg-dark); 
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 0;
            
            border-left: 6px solid var(--cat-red); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            
            min-height: 140px;
            transition: all 0.3s ease;
            border-right: 1px solid rgba(255,255,255,0.05); 
            border-top: 1px solid rgba(255,255,255,0.05); 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            
            /* 關鍵：讓預覽卡片佔滿左欄寬度 */
            width: 100%;
            max-width: none;
        }

        .preview-header {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 15px;
            width: 100%;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px dashed rgba(255,255,255,0.1); 
        }

        .preview-content {
            font-size: 3.5rem; 
            color: var(--text-light); 
            transition: transform 0.2s;
        }
        
        /* 推薦色票 (一行顯示，可滑動) */
        .color-grid {
            display: flex;
            flex-wrap: nowrap;
            white-space: nowrap;
            gap: 3px; /* 更小的間隔 */
            margin-bottom: 15px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            scrollbar-width: none; /* 隱藏滾動條 */
            -ms-overflow-style: none; /* IE 和 Edge */
            width: 100%;
            justify-content: center; /* 居中對齊 */
        }

        .color-grid::-webkit-scrollbar {
            display: none; /* 隱藏滾動條 */
        }

        .color-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .color-grid::-webkit-scrollbar-thumb {
            background: rgba(155, 228, 255, 0.3);
            border-radius: 3px;
        }

        .centered-label {
            text-align: center;
            margin-bottom: 15px;
        }

        .color-swatch {
            width: 32px;         /* 增加寬度讓它們更好地填滿空間 */
            height: 32px;        /* 增加高度 */
            border-radius: 8px;  /* 稍微增加圓角 */
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
            position: relative;
            flex-shrink: 0; /* 確保不會被壓縮 */
        }
        
        .color-swatch:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* 修正 active 樣式，移除文字內容 */
        .color-swatch.active {
            border: 2px solid var(--text-light); 
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            transform: scale(1.05); 
        }

        .custom-color-row {
            display: flex; 
            align-items: center; 
            gap: 10px;
        }

        .custom-color-row input[type="color"] {
            width: 55px; /* 統一尺寸 */
            height: 35px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* --------------------------- 右側：Icon 選擇器 (移除滑動) --------------------------- */
        
        .icon-selector-container {
            /* ⭐ 關鍵：移除高度限制與滑動設定，讓內容完全展開 (符合不要滑動的需求) */
            max-height: none; 
            overflow-y: visible;
            
            padding: 5px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            
            flex-grow: 1; /* 讓它佔滿右側高度 */
        }

        .icon-category {
            margin-bottom: 5px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s;
        }

        .icon-category-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.9em; /* 稍微縮小字體更精緻 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--neon-yellow);
            font-weight: bolder;
        }

        .icon-category-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
            color: var(--text-dark);
            flex-shrink: 0; 
            margin-left: 10px;
        }

        .icon-category-content {
            display: flex;        /* 使用 Flex 佈局 */
            flex-wrap: wrap;     /* 自動換行 */
            gap: 10px;           /* 圖示之間的間距 */
            padding: 10px;
            transition: all 0.3s ease;
        }

        .icon-category.collapsed .icon-category-content {
            display: none;
        }

        .icon-category.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        /* 4. 控制圖示的大小 (防止圖示失控變大) */
        .icon-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem; /* 控制圖示符號的大小 */
            transition: 0.2s;
        }

        .icon-item:hover {
            background: var(--neon-blue);
            color: var(--bg-dark);
            transform: scale(1.1);
        }

        .icon-option {
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 20px;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            flex-basis: calc(20% - 8px); /* 讓它在一行顯示 5 個 */
            min-width: 45px;
        }
        
        @media (max-width: 500px) {
            .icon-option {
                flex-basis: calc(25% - 7.5px); /* 手機版顯示 4 個 */
            }
        }


        .icon-option:hover {
            border-color: var(--neon-blue);
            background: rgba(155, 228, 255, 0.1);
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(155, 228, 255, 0.2);
        }

        .icon-option input[type="radio"] {
            display: none;
        }

        .icon-option:has(input[type="radio"]:checked) {
            border-color: var(--neon-pink);
            background: rgba(255, 156, 207, 0.15);
            box-shadow: 0 0 12px rgba(255, 156, 207, 0.4);
        }

        .icon-option:has(input[type="radio"]:checked) i {
            color: var(--neon-yellow);
            text-shadow: 0 0 12px var(--neon-yellow);
            transform: scale(1.1);
        }

        /* 箭頭旋轉動畫 */
        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .icon-category.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        /* 展開/收合按鈕容器 */
        .toggle-all-btns {
            display: flex;
            gap: 15px;
        }

        /* 基礎按鈕樣式 */
        .toggle-btn {
            cursor: pointer;
            font-size: 0.85em;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid transparent;
        }

        /* 滑鼠滑過效果 */
        .toggle-btn:hover {
            color: var(--text-light);
        }

        /* ✨ Active 霓虹效果 */
        .toggle-btn.active {
            color: var(--neon-blue);
            border-color: rgba(155, 228, 255, 0.3);
            background: rgba(155, 228, 255, 0.1);
            text-shadow: 0 0 8px var(--neon-blue);
            box-shadow: inset 0 0 5px rgba(155, 228, 255, 0.2);
        }
        
        /* --------------------------- 動畫 --------------------------- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* --------------------------- 響應式設計 --------------------------- */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .record-container {
                padding: 20px;
                margin: 10px auto;
            }

            .modal-body-split {
                flex-direction: column; /* 改為上下堆疊 */
                padding: 20px;
                gap: 20px;
            }
            
            /* 手機版：移除左側面板的最小高度限制 */
            .modal-left-panel {
                min-height: auto;
            }

            .type-selector {
                flex-direction: column;
                gap: 15px;
            }

            /* 手機版圖示區，仍保持不捲動，讓類別收合功能發揮作用 */
            .icon-selector-container {
                max-height: none; 
                overflow-y: visible;
            }
        }
    </style>
</head>
<body>
    <div class="record-container">
        <h1 class="page-title neon-text">⚡️ 新增交易紀錄</h1>
        <form id="recordForm">

            <div class="type-selector">
                <div class="type-btn active" data-type="expense">
                    <i class="fas fa-minus-circle"></i> 支出
                </div>
                <div class="type-btn" data-type="income">
                    <i class="fas fa-plus-circle"></i> 收入
                </div>
                <input type="hidden" name="transactionType" value="expense">
            </div>

            <div class="form-group">
                <label for="date"><i class="fas fa-calendar-alt"></i> 交易日期</label>
                <input type="date" id="date" name="date" class="white-date-input" required>
            </div>

            <div class="form-group">
                <label for="amount"><i class="fas fa-dollar-sign"></i> 交易金額</label>
                <div class="input-group">
                    <span class="input-currency" id="currencyLabel">TWD</span>
                    <input type="number" id="amount" name="amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <div class="form-group">
                <label><i class="fas fa-coins"></i> 使用貨幣</label>
                <select id="currencySelect" class="white-select">
                    <option value="TWD">TWD</option>
                    <option value="USD">USD</option>
                    <option value="JPY">JPY</option>
                    <option value="EUR">EUR</option>
                    <option value="HKD">HKD</option>
                    <option value="CNY">CNY</option>
                    <option value="GBP">GBP</option>
                    <option value="AUD">AUD</option>
                    <option value="KRW">KRW</option>
                    <option value="SGD">SGD</option>
                </select>
            </div>


            <div class="form-group">
                <label><i class="fas fa-list-alt"></i> 主分類</label>
                <div id="primaryCategoryButtons" class="category-buttons">
                </div>
            </div>

            <div id="subCategoryGroup" class="category-group" style="display: none;">
                <div class="category-label">
                    <i class="fas fa-sitemap"></i> 
                    <span>選擇子分類：</span>
                </div>
                <div id="subCategoryButtons" class="category-buttons">
                    </div>
            </div>

            <div class="form-group">
                <label for="receiptImage"><i class="fas fa-camera"></i> 上傳憑證圖片 (選填)</label>
                <input type="file" id="receiptImage" name="receiptImage" accept="image/*" class="file-upload-input">

                <div class="file-control-area">
                    <label for="receiptImage" class="file-upload-label">
                        <i class="fas fa-upload"></i> 選擇圖片
                    </label>

                    <div class="file-name-display-group">
                        <span id="fileNameDisplay" class="file-name-display">未選擇檔案</span>

                        <button type="button" id="clearImageBtn" class="clear-image-btn" style="display:none;" title="清除圖片">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div id="imagePreviewContainer" style="display: none;">
                    <img id="imagePreview" src="#" alt="圖片預覽">
                </div>
            </div>

            <div class="form-group">
                <label for="description"><i class="fas fa-pencil-alt"></i> 備註 (選填)</label>
                <textarea id="description" name="description" placeholder="輸入備註或說明..." rows="3"></textarea>
            </div>

            <button type="submit" id="submitBtn" class="submit-btn">
                <i class="fas fa-save"></i> 儲存交易
            </button>

            <div id="resultDisplay" style="display: none;"></div>

        </form>
    </div>

    <!-- Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content custom-modal-layout">
            
            <div class="modal-header-center">
                <h2>✨ 新增自訂分類</h2>
                <span class="close-btn" id="modalCloseBtn">&times;</span>
            </div>

            <form id="addCategoryForm" class="modal-body-split">
                
                <div class="modal-left-panel">
                    
                    <div class="form-group">
                        <label for="newCategoryName"><i class="fas fa-tag"></i> 分類名稱</label>
                        <input type="text" id="newCategoryName" name="categoryName" placeholder="例如：早餐、遊戲..." required autocomplete="off">
                    </div>

                    <div class="form-group" id="categoryColorGroup" style="margin-top: 20px;">
                        <label class="centered-label"><i class="fas fa-palette"></i> 分類顏色</label>
                        
                        <div class="color-selection-area">
                            <div class="color-grid">
                                <div class="color-swatch active" data-color="#ff7f7f" style="background: #ff7f7f;"></div>
                                <div class="color-swatch" data-color="#ffbf7f" style="background: #ffbf7f;"></div>
                                <div class="color-swatch" data-color="#ffff7f" style="background: #ffff7f;"></div>
                                <div class="color-swatch" data-color="#7fff7f" style="background: #7fff7f;"></div>
                                <div class="color-swatch" data-color="#7fbfff" style="background: #7fbfff;"></div>
                                <div class="color-swatch" data-color="#bf7fff" style="background: #bf7fff;"></div>
                                <div class="color-swatch" data-color="#ff85ee" style="background: #ff85ee;"></div>
                                <div class="color-swatch" data-color="#b6ffb6" style="background: #b6ffb6;"></div>
                                <div class="color-swatch" data-color="#ffcc66" style="background: #ffcc66;"></div>
                                <div class="color-swatch" data-color="#99e6e6" style="background: #99e6e6;"></div>
                                <div class="color-swatch" data-color="#ffb3ba" style="background: #ffb3ba;"></div>
                                <div class="color-swatch" data-color="#bae1ff" style="background: #bae1ff;"></div>
                                <div class="color-swatch" data-color="#ffffba" style="background: #ffffba;"></div>
                            </div>
                            
                            <div class="custom-color-row">
                                <label>自訂：</label>
                                <input type="color" id="customColorPicker" value="#ff7f7f">
                            </div>
                            <input type="hidden" id="selectedColorValue" name="color" value="#ff7f7f">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label><i class="fas fa-eye"></i> 效果預覽</label>
                        <div id="categoryPreviewCard" class="preview-card full-width-preview">
                            <div class="preview-header" id="previewNameText">分類名稱</div>
                            <div class="preview-content">
                                <i id="previewIcon" class="fas fa-utensils"></i>
                            </div>
                        </div>

                        <br>
                        <button type="submit" class="submit-btn full-width-btn" style="margin-top: auto;">
                            <i class="fas fa-check"></i> 確認新增
                        </button>
                    </div>
                    
                </div>

                <div class="modal-right-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label style="margin-bottom: 0;"><i class="fas fa-icons"></i> 選擇圖示</label>
                        <div class="toggle-all-btns">
                            <span id="btn-expand-all"  class="toggle-btn active"  onclick="toggleAllIconCategories(true, this)">
                                <i class="fas fa-expand-alt"></i> 全部展開
                            </span>
                            <span id="btn-collapse-all"  class="toggle-btn"  onclick="toggleAllIconCategories(false, this)">
                                <i class="fas fa-compress-alt"></i> 全部收合
                            </span>
                        </div>
                    </div>
                    
                    <div id="iconSelector" class="icon-selector-container">
                        
                        <div class="icon-category" id="cat-food-drink">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-food-drink')">飲食 / 飲品 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-utensils" checked><i class="fas fa-utensils"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-hamburger"><i class="fas fa-hamburger"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-pizza-slice"><i class="fas fa-pizza-slice"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-bread-slice"><i class="fas fa-bread-slice"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-drumstick-bite"><i class="fas fa-drumstick-bite"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-fish"><i class="fas fa-fish"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-carrot"><i class="fas fa-carrot"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-apple-alt"><i class="fas fa-apple-alt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-egg"><i class="fas fa-egg"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-cookie-bite"><i class="fas fa-cookie-bite"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-ice-cream"><i class="fas fa-ice-cream"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-birthday-cake"><i class="fas fa-birthday-cake"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-coffee"><i class="fas fa-coffee"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-beer"><i class="fas fa-beer"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-wine-glass"><i class="fas fa-wine-glass"></i></label>
                            </div>
                        </div>
                        
                        <div class="icon-category" id="cat-traffic-trip">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-traffic-trip')">交通 / 旅行 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-bus"><i class="fas fa-bus"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-car"><i class="fas fa-car"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-plane"><i class="fas fa-plane"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-train"><i class="fas fa-train"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-bicycle"><i class="fas fa-bicycle"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-gas-pump"><i class="fas fa-gas-pump"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-motorcycle"><i class="fas fa-motorcycle"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-taxi"><i class="fas fa-taxi"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-subway"><i class="fas fa-subway"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-truck"><i class="fas fa-truck"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-shuttle-van"><i class="fas fa-shuttle-van"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-rocket"><i class="fas fa-rocket"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-helicopter"><i class="fas fa-helicopter"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-parking"><i class="fas fa-parking"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-route"><i class="fas fa-route"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-shopping">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-shopping')">購物 / 消費 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-shopping-bag"><i class="fas fa-shopping-bag"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-cart-shopping"><i class="fas fa-cart-shopping"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-tshirt"><i class="fas fa-tshirt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-mobile-alt"><i class="fas fa-mobile-alt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-laptop"><i class="fas fa-laptop"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-tools"><i class="fas fa-tools"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-couch"><i class="fas fa-couch"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-home"><i class="fas fa-home"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-book"><i class="fas fa-book"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-shoe-prints"><i class="fas fa-shoe-prints"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-gift"><i class="fas fa-gift"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-tag"><i class="fas fa-tag"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-store"><i class="fas fa-store"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-gem"><i class="fas fa-gem"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-credit-card"><i class="fas fa-credit-card"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-fun-sport">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-fun-sport')">娛樂 / 運動 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-gamepad"><i class="fas fa-gamepad"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-film"><i class="fas fa-film"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-music"><i class="fas fa-music"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-ticket-alt"><i class="fas fa-ticket-alt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-theater-masks"><i class="fas fa-theater-masks"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-camera"><i class="fas fa-camera"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-palette"><i class="fas fa-palette"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-headphones"><i class="fas fa-headphones"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-video"><i class="fas fa-video"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-dumbbell"><i class="fas fa-dumbbell"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-futbol"><i class="fas fa-futbol"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-basketball-ball"><i class="fas fa-basketball-ball"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-swimmer"><i class="fas fa-swimmer"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-dice"><i class="fas fa-dice"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-puzzle-piece"><i class="fas fa-puzzle-piece"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-finance-invest">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-finance-invest')">財務 / 投資 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-money-bill-wave"><i class="fas fa-money-bill-wave"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-piggy-bank"><i class="fas fa-piggy-bank"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-hand-holding-dollar"><i class="fas fa-hand-holding-dollar"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-money-check"><i class="fas fa-money-check"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-wallet"><i class="fas fa-wallet"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-chart-line"><i class="fas fa-chart-line"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-chart-pie"><i class="fas fa-chart-pie"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-coins"><i class="fas fa-coins"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-dollar-sign"><i class="fas fa-dollar-sign"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-euro-sign"><i class="fas fa-euro-sign"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-yen-sign"><i class="fas fa-yen-sign"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-pound-sign"><i class="fas fa-pound-sign"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-bank"><i class="fas fa-bank"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-landmark"><i class="fas fa-landmark"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-file-invoice-dollar"><i class="fas fa-file-invoice-dollar"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-medical-edu">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-medical-edu')">醫療 / 教育 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-clinic-medical"><i class="fas fa-clinic-medical"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-user-md"><i class="fas fa-user-md"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-pills"><i class="fas fa-pills"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-thermometer-half"><i class="fas fa-thermometer-half"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-heartbeat"><i class="fas fa-heartbeat"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-brain"><i class="fas fa-brain"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-graduation-cap"><i class="fas fa-graduation-cap"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-book"><i class="fas fa-book"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-child"><i class="fas fa-child"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-baby"><i class="fas fa-baby"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-users"><i class="fas fa-users"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-user-friends"><i class="fas fa-user-friends"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-handshake"><i class="fas fa-handshake"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-building"><i class="fas fa-building"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-briefcase"><i class="fas fa-briefcase"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-life-home">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-life-home')">日常 / 居家 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-home"><i class="fas fa-home"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-mobile-alt"><i class="fas fa-mobile-alt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-paw"><i class="fas fa-paw"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-plug"><i class="fas fa-plug"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-wifi"><i class="fas fa-wifi"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-lightbulb"><i class="fas fa-lightbulb"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-shower"><i class="fas fa-shower"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-toilet"><i class="fas fa-toilet"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-broom"><i class="fas fa-broom"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-soap"><i class="fas fa-soap"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-recycle"><i class="fas fa-recycle"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-leaf"><i class="fas fa-leaf"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-seedling"><i class="fas fa-seedling"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-gift"><i class="fas fa-gift"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-birthday-cake"><i class="fas fa-birthday-cake"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-work-office">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-work-office')">工作 / 辦公 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-laptop"><i class="fas fa-laptop"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-desktop"><i class="fas fa-desktop"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-keyboard"><i class="fas fa-keyboard"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-mouse"><i class="fas fa-mouse"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-print"><i class="fas fa-print"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-file-alt"><i class="fas fa-file-alt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-folder"><i class="fas fa-folder"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-clipboard"><i class="fas fa-clipboard"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-calendar-alt"><i class="fas fa-calendar-alt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-clock"><i class="fas fa-clock"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-tasks"><i class="fas fa-tasks"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-users-cog"><i class="fas fa-users-cog"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-chart-bar"><i class="fas fa-chart-bar"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-project-diagram"><i class="fas fa-project-diagram"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-cogs"><i class="fas fa-cogs"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-tech-tools">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-tech-tools')">科技 / 工具 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-tools"><i class="fas fa-tools"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-wrench"><i class="fas fa-wrench"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-hammer"><i class="fas fa-hammer"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-screwdriver"><i class="fas fa-screwdriver"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-code"><i class="fas fa-code"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-terminal"><i class="fas fa-terminal"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-server"><i class="fas fa-server"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-database"><i class="fas fa-database"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-cloud"><i class="fas fa-cloud"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-globe"><i class="fas fa-globe"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-envelope"><i class="fas fa-envelope"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-phone"><i class="fas fa-phone"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-headset"><i class="fas fa-headset"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-video"><i class="fas fa-video"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-microphone"><i class="fas fa-microphone"></i></label>
                            </div>
                        </div>

                        <div class="icon-category" id="cat-misc">
                            <div class="icon-category-header" onclick="toggleIconCategory('cat-misc')">其他 / 符號 <i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="icon-category-content">
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-star"><i class="fas fa-star"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-heart"><i class="fas fa-heart"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-smile"><i class="fas fa-smile"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-thumbs-up"><i class="fas fa-thumbs-up"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-bolt"><i class="fas fa-bolt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-fire"><i class="fas fa-fire"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-sun"><i class="fas fa-sun"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-moon"><i class="fas fa-moon"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-umbrella"><i class="fas fa-umbrella"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-snowflake"><i class="fas fa-snowflake"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-tree"><i class="fas fa-tree"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-key"><i class="fas fa-key"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-lock"><i class="fas fa-lock"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-shield-alt"><i class="fas fa-shield-alt"></i></label>
                                <label class="icon-option"><input type="radio" name="icon-selector" value="fas fa-trophy"><i class="fas fa-trophy"></i></label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</body>

    <script>
        
        (function() {
            // ---------- Keys ----------
            const TRANSACTIONS_KEY = 'transactions';
            const CATEGORY_KEY = 'categoryData';

            const CATEGORY_COLORS = [
                '#ff7f7f','#ffcc66','#a8f0c6','#a7d7ff','#ffb3cf',
                '#cf9cff','#66ffcc','#ff9c66','#99ccff','#d4d4d4',
                '#ffd1dc','#ffe066','#8affc1','#8ed1ff','#c9a7ff',
                '#ffb380','#b3ffb3','#b3d9ff','#ffe6b3','#ffadad'
            ];

            const DEFAULT_CATEGORY_DATA = {
                expense: [
                    { id: 1, name: "餐飲", icon: "fas fa-utensils", color: "var(--cat-1)", sub: [
                        { id: 101, name: "外食", icon: "fas fa-burger", color: "var(--cat-1)" },
                        { id: 102, name: "飲品", icon: "fas fa-coffee", color: "var(--cat-1)" },
                        { id: 103, name: "零食", icon: "fas fa-cookie-bite", color: "var(--cat-1)" },
                    ]},
                    { id: 2, name: "交通", icon: "fas fa-bus", color: "var(--cat-2)", sub: [
                        { id: 201, name: "油資/充電", icon: "fas fa-gas-pump", color: "var(--cat-2)" },
                        { id: 202, name: "公車/捷運", icon: "fas fa-subway", color: "var(--cat-2)" },
                        { id: 203, name: "計程車", icon: "fas fa-taxi", color: "var(--cat-2)" },
                    ]},
                    { id: 3, name: "購物", icon: "fas fa-shopping-bag", color: "var(--cat-3)", sub: [
                        { id: 301, name: "服飾", icon: "fas fa-shirt", color: "var(--cat-3)" },
                        { id: 302, name: "日用品", icon: "fas fa-toilet-paper", color: "var(--cat-3)" },
                        { id: 303, name: "3C 產品", icon: "fas fa-mobile-screen-button", color: "var(--cat-3)" },
                    ]},
                    { id: 4, name: "娛樂", icon: "fas fa-gamepad", color: "var(--cat-4)", sub: [
                        { id: 401, name: "電影/展覽", icon: "fas fa-ticket", color: "var(--cat-4)" },
                        { id: 402, name: "遊戲", icon: "fas fa-dice", color: "var(--cat-4)" },
                        { id: 403, name: "旅遊", icon: "fas fa-plane", color: "var(--cat-4)" },
                    ]},
                    { id: 5, name: "居住", icon: "fas fa-home", color: "var(--cat-5)", sub: [
                        { id: 501, name: "房租/房貸", icon: "fas fa-building-columns", color: "var(--cat-5)" },
                        { id: 502, name: "水電瓦斯", icon: "fas fa-lightbulb", color: "var(--cat-5)" },
                        { id: 503, name: "網路/電信", icon: "fas fa-signal", color: "var(--cat-5)" },
                    ]}
                ],
                income: [
                    { id: 6, name: "薪資", icon: "fas fa-money-check-alt", color: "var(--cat-6)", sub: [
                        { id: 601, name: "月薪", icon: "fas fa-money-bill-wave", color: "var(--cat-6)" },
                        { id: 602, name: "獎金", icon: "fas fa-hand-holding-dollar", color: "var(--cat-6)" },
                        { id: 603, name: "兼職", icon: "fas fa-briefcase", color: "var(--cat-6)" },
                    ]},
                    { id: 7, name: "投資", icon: "fas fa-chart-line", color: "var(--cat-7)", sub: [
                        { id: 701, name: "股息", icon: "fas fa-arrow-trend-up", color: "var(--cat-7)" },
                        { id: 702, name: "基金收益", icon: "fas fa-vault", color: "var(--cat-7)" },
                        { id: 703, name: "房產租金", icon: "fas fa-house-chimney-crack", color: "var(--cat-7)" },
                    ]},
                    { id: 8, name: "禮金", icon: "fas fa-gift", color: "var(--cat-8)", sub: [
                        { id: 801, name: "紅包", icon: "fas fa-envelope", color: "var(--cat-8)" },
                        { id: 802, name: "生日禮物", icon: "fas fa-cake-candles", color: "var(--cat-8)" },
                        { id: 803, name: "贊助", icon: "fas fa-heart", color: "var(--cat-8)" },
                    ]},
                    { id: 9, name: "副業", icon: "fas fa-laptop-code", color: "var(--cat-9)", sub: [
                        { id: 901, name: "稿費", icon: "fas fa-pen-nib", color: "var(--cat-9)" },
                        { id: 902, name: "銷售", icon: "fas fa-store", color: "var(--cat-9)" },
                        { id: 903, name: "服務費", icon: "fas fa-handshake", color: "var(--cat-9)" },
                    ]},
                    { id: 10, name: "其他", icon: "fas fa-ellipsis-h", color: "var(--cat-10)", sub: [
                        { id: 1101, name: "退款", icon: "fas fa-undo", color: "var(--cat-10)" },
                        { id: 1102, name: "意外收入", icon: "fas fa-meteor", color: "var(--cat-10)" },
                        { id: 1103, name: "利息", icon: "fas fa-percent", color: "var(--cat-10)" },
                    ]}
                ]
            };

            const CURRENCIES = [
                { code: 'TWD', rate: 1.0 },
                { code: 'USD', rate: 0.032 },
                { code: 'JPY', rate: 4.6 },
                { code: 'EUR', rate: 0.029 },
                { code: 'HKD', rate: 0.24 },
                { code: 'CNY', rate: 0.22 },
                { code: 'GBP', rate: 0.024 },
                { code: 'AUD', rate: 0.046 },
                { code: 'KRW', rate: 41.5 },
                { code: 'SGD', rate: 0.041 },
            ];

            function getCurrencySetting() {
                const saved = JSON.parse(localStorage.getItem('app_currency')) || {};

                return {
                    base: saved.base || 'TWD',
                    symbol: saved.symbol || 'NT$',
                    rates: {
                        TWD:1,
                        USD:0.032,
                        JPY:4.6,
                        EUR:0.029,
                        HKD:0.24,
                        CNY:0.22,
                        GBP:0.024,
                        AUD:0.046,
                        KRW:41.5,
                        SGD:0.041,
                        ...(saved.rates || {}) // ⭐️ 不存在也沒關係
                    }
                };
            }


            // ---------- State ----------
            const today = new Date().toISOString().split('T')[0];
            let currentReceiptImageKey = '';

            // ---------- DOM helpers ----------
            const $ = sel => document.querySelector(sel);
            const $$ = sel => Array.from(document.querySelectorAll(sel));

            function getCategoryData() {
                // 假設你的分類資料是存在 'categoryData' 這個 Key 之下
                return JSON.parse(localStorage.getItem('categoryData') || '{"income": [], "expense": []}');
            }

            // ---------- ⭐️ 核心修正 1：統一的分類載入與初始化函數 ----------
            function loadAndInitializeCategoryData() {
                let saved = localStorage.getItem('categoryData');
                if (saved) {
                    try { return JSON.parse(saved); }
                    catch(e) { console.error("Category data parse error:", e); }
                }
                localStorage.setItem('categoryData', JSON.stringify(DEFAULT_CATEGORY_DATA));
                return DEFAULT_CATEGORY_DATA;
            }

            
            // ---------- Storage - Transactions (不變) ----------
            function loadTransactions() {
                try { return JSON.parse(localStorage.getItem(TRANSACTIONS_KEY)) || []; }
                catch { return []; }
            }
            function saveTransactions(list) {
                localStorage.setItem(TRANSACTIONS_KEY, JSON.stringify(list));
            }

            // ---------- ⭐️ 核心修正 2：更新 saveCategoryData 以包含通知機制 ----------
            function saveCategoryData(obj) {
                localStorage.setItem(CATEGORY_KEY, JSON.stringify(obj));
                
                // 通知其他頁面（如 budget.html）數據已變動
                window.dispatchEvent(new Event('category-updated'));
            }

            function getNextId(list) {
                return list && list.length ? Math.max(...list.map(i => i.id || 0)) + 1 : 1;
            }
            
            // ---------- State 初始化 (使用新的統一載入函數) ----------
            let categoryData = loadAndInitializeCategoryData(); // 用於 handleAddCategorySubmit
            let APP_CATEGORIES = categoryData; // 直接指向已載入/初始化的數據
            let selectedType = 'expense';
            let selectedPrimary = null;
            let selectedSub = null;
            
            // ---------- DOM elements ----------
            let recordForm, dateInput, amountInput, descriptionInput;
            let receiptImageInput, fileNameDisplay, imagePreviewContainer, imagePreview, clearImageBtn;
            let primaryCategoryButtons, subCategoryButtons, subCategoryGroup, resultDisplay;
            let typeButtons;
            let addCategoryModal, addCategoryForm, addCategoryNameInput, addCategoryIconInputs, modalCloseBtn;

            const CATEGORY_STORAGE_KEY = 'categoryData'; // 保持這個變數名稱

            document.addEventListener('DOMContentLoaded', () => {
                // ---------- Resolve DOM ----------
                recordForm = $('#recordForm');
                dateInput = $('#date');
                amountInput = $('#amount');
                descriptionInput = $('#description');
                receiptImageInput = $('#receiptImage');
                fileNameDisplay = $('#fileNameDisplay');
                imagePreviewContainer = $('#imagePreviewContainer');
                imagePreview = $('#imagePreview');
                clearImageBtn = $('#clearImageBtn');
                primaryCategoryButtons = $('#primaryCategoryButtons');
                subCategoryButtons = $('#subCategoryButtons');
                subCategoryGroup = $('#subCategoryGroup');
                resultDisplay = $('#resultDisplay');
                typeButtons = $$('.type-btn');
                addCategoryModal = $('#addCategoryModal');
                addCategoryForm = $('#addCategoryForm');
                addCategoryNameInput = $('#newCategoryName');
                addCategoryIconInputs = $$('input[name="icon-selector"]');
                modalCloseBtn = $('#modalCloseBtn');

                // default date
                if(dateInput) dateInput.value = today;

                // ---------- Type switch ----------
                typeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        typeButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedType = btn.dataset.type || selectedType;
                        renderPrimaryCategories();
                        selectedPrimary = null;
                        selectedSub = null;
                        if(subCategoryGroup) subCategoryGroup.style.display = 'none';
                    });
                });

                function initCurrencySelect() {
                    const select = document.getElementById('currencySelect');
                    const label = document.getElementById('currencyLabel');
                    const setting = JSON.parse(localStorage.getItem('app_currency'));

                    if (!select || !setting) return;

                    select.value = setting.base;
                    label.textContent = setting.base;

                    select.addEventListener('change', () => {
                        label.textContent = select.value;
                    });
                }


                // ---------- 監聽資料同步 ----------
                function reloadAndRenderCategories() {
                    try {
                        const saved = JSON.parse(localStorage.getItem(CATEGORY_KEY)) || {};
                        // 安全合併：保持原本收入/支出分類
                        APP_CATEGORIES.expense = saved.expense || APP_CATEGORIES.expense;
                        APP_CATEGORIES.income = saved.income || APP_CATEGORIES.income;
                        categoryData = APP_CATEGORIES;
                    } catch(e) {
                        console.error('Failed to parse categoryData:', e);
                    }
                    selectedPrimary = null;
                    selectedSub = null;
                    renderPrimaryCategories();
                    if(subCategoryGroup) subCategoryGroup.style.display = 'none';
                }
                
                function syncCurrencyFromSetting() {
                    const setting = JSON.parse(localStorage.getItem('app_currency'));
                    if (!setting) return;
                    const label = document.getElementById('currencyLabel');
                    if (label) label.textContent = setting.base;
                }

                // 初始同步
                syncCurrencyFromSetting();

                // 當設定頁改幣別
                window.addEventListener('storage', e => {
                    if (e.key === 'app_currency') {
                        syncCurrencyFromSetting();
                    }
                });
                
                // 1. 監聽 Storage 事件 (接收來自其他分頁的變更，如 category.html)
                window.addEventListener('storage', (e) => {
                    if (e.key === 'categoryData') reloadAndRenderCategories();
                });

                window.addEventListener('category-updated', () => {
                    reloadAndRenderCategories();
                });

                bindImageUpload();
                renderPrimaryCategories();
                bindPreviewEvents();
                checkURLTypeAndSetDefault();

                if(recordForm) recordForm.addEventListener('submit', onRecordFormSubmit);
                if(addCategoryForm) addCategoryForm.addEventListener('submit', handleAddCategorySubmit);
                if(modalCloseBtn) modalCloseBtn.addEventListener('click', closeAddCategoryModal);

                initCurrencySelect();

            });

            function syncCurrencyDisplay() {
                const setting = JSON.parse(localStorage.getItem('app_currency'));
                if (!setting) return;

                document.querySelectorAll('.amount[data-currency]').forEach(el => {
                    const currency = el.dataset.currency;
                    const symbolMap = {
                        TWD:'NT$',
                        USD:'$',
                        JPY:'¥',
                        EUR:'€',
                        HKD:'HK$',
                        CNY:'¥',
                        GBP:'£',
                        AUD:'A$',
                        KRW:'₩',
                        SGD:'S$'
                    };
                    el.querySelector('.currency-symbol').textContent =
                        symbolMap[currency] || currency;
                });
            }

            window.addEventListener('storage', e => {
                if (e.key === 'app_currency') {
                    syncCurrencyDisplay();
                }
            });


            // ---------- Categories ----------
            function renderPrimaryCategories() {
                primaryCategoryButtons.innerHTML = '';
                const mainCats = APP_CATEGORIES[selectedType] || [];
                mainCats.forEach(cat => {
                    const btn = document.createElement('div');
                    btn.className = 'cat-btn';
                    btn.dataset.id = cat.id;
                    btn.style.setProperty('--cat-color', cat.color);
                    btn.innerHTML = `<i class="${cat.icon} cat-icon"></i> ${escapeHtml(cat.name)}`;
                    btn.addEventListener('click', () => selectPrimaryById(cat.id));
                    primaryCategoryButtons.appendChild(btn);
                });

                // 新增按鈕
                const addBtn = document.createElement('div');
                addBtn.className = 'cat-btn add-cat-btn';
                addBtn.innerHTML = `<i class="fas fa-plus"></i> 新增`;
                addBtn.addEventListener('click', ()=>openAddCategoryModal({kind:'primary', type:selectedType}));
                primaryCategoryButtons.appendChild(addBtn);
            }

            function renderSubCategoriesForSelected() {
                subCategoryButtons.innerHTML = '';
                if (!selectedPrimary) { subCategoryGroup.style.display='none'; return; }
                subCategoryGroup.style.display='flex';

                // 確保選中的主分類是最新的數據（從 APP_CATEGORIES 重新查找）
                const latestPrimary = APP_CATEGORIES[selectedType].find(c => c.id === selectedPrimary.id);
                if (!latestPrimary) { subCategoryGroup.style.display='none'; return; } // 如果主分類被刪除
                selectedPrimary = latestPrimary; // 更新 selectedPrimary
                
                const subs = selectedPrimary.sub || [];
                if(subs.length === 0){
                    const addBtn = document.createElement('div');
                    addBtn.className='cat-btn add-cat-btn';
                    addBtn.innerHTML=`<i class="fas fa-plus"></i> 新增子分類`;
                    addBtn.addEventListener('click', ()=>openAddCategoryModal({kind:'sub', type:selectedType, primaryId:selectedPrimary.id}));
                    subCategoryButtons.appendChild(addBtn);
                    return;
                }

                subs.forEach(sub => {
                    const btn = document.createElement('div');
                    btn.className = 'cat-btn';
                    btn.dataset.id = sub.id;
                    btn.style.setProperty('--cat-color', sub.color || selectedPrimary.color);
                    const colorToUse = selectedPrimary.color;
                    btn.style.setProperty('--cat-color', colorToUse);
                    btn.innerHTML = `<i class="${sub.icon || selectedPrimary.icon} cat-icon"></i> ${escapeHtml(sub.name)}`;
                    btn.addEventListener('click', ()=>selectSubById(sub.id));
                    subCategoryButtons.appendChild(btn);
                });

                // 新增子分類按鈕
                const addBtn = document.createElement('div');
                addBtn.className='cat-btn add-cat-btn';
                addBtn.innerHTML=`<i class="fas fa-plus"></i> 新增`;
                addBtn.addEventListener('click', ()=>openAddCategoryModal({kind:'sub', type:selectedType, primaryId:selectedPrimary.id}));
                subCategoryButtons.appendChild(addBtn);
            }

            function selectPrimaryById(id){
                const cat = APP_CATEGORIES[selectedType].find(c=>c.id==id);
                if(!cat) return;
                selectedPrimary = cat;
                selectedSub = null;
                primaryCategoryButtons.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
                const btn = primaryCategoryButtons.querySelector(`.cat-btn[data-id="${id}"]`);
                if(btn) btn.classList.add('active');
                renderSubCategoriesForSelected();
            }

            function selectSubById(id) {
                if (!selectedPrimary) return;
                const sub = (selectedPrimary.sub || []).find(s => s.id == id);
                if (!sub) return;

                selectedSub = sub;
                subCategoryButtons
                    .querySelectorAll('.cat-btn')
                    .forEach(b => b.classList.remove('active'));

                const btn = subCategoryButtons.querySelector(`.cat-btn[data-id="${id}"]`);
                if (btn) btn.classList.add('active');
            }


            // ---------- Image (不變) ----------
            function bindImageUpload(){
                if(!receiptImageInput) return;
                receiptImageInput.addEventListener('change', e=>{
                    const f=e.target.files?.[0];
                    if(f){
                        fileNameDisplay.textContent=`已選擇檔案: ${f.name}`;
                        fileNameDisplay.style.color='var(--neon-yellow)';
                        clearImageBtn.style.display='inline-block';
                        const reader=new FileReader();

                        reader.onload = ev => {
                            const base64 = ev.target.result;

                            // ✅ 存 base64 → 換 key
                            currentReceiptImageKey = saveReceiptImage(base64);

                            // 預覽還是用 base64（不用 key）
                            imagePreview.src = base64;
                            imagePreviewContainer.style.display = 'block';
                        };


                        reader.readAsDataURL(f);
                    } else resetImageInputUI();
                });
                if(clearImageBtn) clearImageBtn.addEventListener('click', resetImageInputUI);
            }
            function resetImageInputUI(){
                if(!receiptImageInput) return;
                receiptImageInput.value='';
                fileNameDisplay.textContent='未選擇檔案';
                fileNameDisplay.style.color='var(--text-dark)';
                imagePreview.src='#';
                if(imagePreviewContainer) imagePreviewContainer.style.display='none';
                if(clearImageBtn) clearImageBtn.style.display='none';
                currentReceiptImageKey = '';
            }

            // ---------- Modal (修正了 loadCategoryData() 的呼叫) ----------
            let pendingModalContext=null;
            function openAddCategoryModal(ctx) { 
                pendingModalContext = ctx;
                addCategoryModal.style.display = 'block';

                const colorGroup = document.getElementById('categoryColorGroup');
                if (colorGroup) {
                    colorGroup.style.display = ctx.kind === 'sub' ? 'none' : 'block';
                }

                if(addCategoryNameInput) addCategoryNameInput.focus();

                // ---------- 預覽區初始化 ----------
                const previewCard = document.getElementById('categoryPreviewCard');
                const previewName = document.getElementById('previewNameText');
                const previewIcon = document.getElementById('previewIcon');
                const colorHiddenInput = document.getElementById('selectedColorValue');
                const colorPicker = document.getElementById('customColorPicker');

                // 預設值
                const defaultColor = '#ff7f7f';
                const defaultIcon = 'fas fa-utensils';

                if(previewCard) previewCard.style.borderLeftColor = defaultColor; // 左邊顏色條
                if(previewName) previewName.textContent = '分類名稱'; // 預設文字
                if(previewIcon) previewIcon.className = defaultIcon; // 預設圖示
                if(colorHiddenInput) colorHiddenInput.value = defaultColor;
                if(colorPicker) colorPicker.value = defaultColor;

                // color swatches 初始化
                const colorSwatches = document.querySelectorAll('.color-swatch');
                if(colorSwatches.length){
                    colorSwatches.forEach(s => s.classList.remove('active'));
                    colorSwatches[0].classList.add('active'); // 預設選第一個顏色
                }
            }


            function closeAddCategoryModal(){
                if(addCategoryModal) addCategoryModal.style.display='none';
                pendingModalContext=null;
                if(addCategoryForm) addCategoryForm.reset();
            }
            function handleAddCategorySubmit(e){
                e.preventDefault();
                if(!pendingModalContext) return alert('Modal context error');
                const name=(addCategoryNameInput?.value||'').trim();
                const icon=(document.querySelector('input[name="icon-selector"]:checked')||{}).value||'fas fa-folder';
                if(!name) return alert('請輸入分類名稱');

                categoryData=loadAndInitializeCategoryData(); // 確保使用最新的數據
                if(pendingModalContext.kind==='primary'){
                    const arr=categoryData[pendingModalContext.type]||[];
                    if(arr.find(c=>c.name===name)) return alert('分類已存在！');
                    const newId=getNextId(arr);

                    // ⭐️ 抓使用者選的顏色
                    const colorHex = document.getElementById('selectedColorValue')?.value || '#ff7f7f';
                    const rgb = hexToRgb(colorHex);

                    arr.push({
                        id: newId,
                        name,
                        icon,
                        color: colorHex,           // 儲存使用者選的顏色
                        colorRgb: `${rgb.r},${rgb.g},${rgb.b}`,
                        sub: []
                    });

                    categoryData[pendingModalContext.type] = arr;
                    saveCategoryData(categoryData);
                    APP_CATEGORIES = categoryData; // 更新全局變數
                    renderPrimaryCategories();
                    selectPrimaryById(newId);
                }
                else if(pendingModalContext.kind==='sub'){
                    const arr=categoryData[pendingModalContext.type]||[];
                    const prim=arr.find(p=>p.id==pendingModalContext.primaryId);
                    if(!prim) return alert('找不到主分類');
                    const newId = prim.sub.length ? Math.max(...prim.sub.map(s=>s.id))+1:prim.id*100+1;
                    
                    // 檢查子分類是否已存在
                    if(prim.sub.find(s=>s.name===name)) return alert('子分類已存在！');
                    
                    prim.sub = prim.sub || [];
                    prim.sub.push({
                        id: newId,
                        name,
                        icon,
                        color: prim.color
                    });

                    saveCategoryData(categoryData);
                    
                    // APP_CATEGORIES 已經是 categoryData 的引用，不用再重新載入
                    selectedPrimary=prim;
                    renderSubCategoriesForSelected();
                    selectSubById(newId);
                }
                closeAddCategoryModal();
            }

            // ---------- Form submit (不變) ----------
            function onRecordFormSubmit(e){
                e.preventDefault();
                const amountInputValue = Number(amountInput?.value || 0);
                if (!amountInputValue || amountInputValue <= 0) return alert('請輸入有效金額！');
                if(!selectedPrimary) return alert('請選擇主分類！');

                // ---------- ✅ 使用者選擇的幣別 ----------
                const currency = document.getElementById('currencySelect')?.value || 'TWD';

                // 取得匯率
                const currencySetting = getCurrencySetting();
                const rates = currencySetting.rates || {};

                // 計算 baseAmount (TWD)
                let baseAmount = amountInputValue;
                if(currency !== 'TWD' && rates[currency]){
                    baseAmount = amountInputValue / rates[currency];
                }

                const categoryIconToUse = selectedSub ? (selectedSub.icon || selectedPrimary.icon) : selectedPrimary.icon;
                const categoryObject = {
                    primary: { id:selectedPrimary.id, name:selectedPrimary.name, icon:selectedPrimary.icon, color:selectedPrimary.color },
                    sub: selectedSub ? { id:selectedSub.id, name:selectedSub.name, icon: categoryIconToUse } : null
                };
                const categoryText = selectedSub ? `${selectedPrimary.name} / ${selectedSub.name}` : selectedPrimary.name;
                const description = (descriptionInput?.value?.trim()) || '無備註';

                const transactions = loadTransactions();
                const newId = getNextId(transactions);
                const newTransaction = {
                    id: newId,
                    type: selectedType,
                    amount: amountInputValue,     // 使用者輸入金額
                    currency,                     // 使用者選擇的幣別
                    baseAmount,                   // 換算成 TWD
                    date: dateInput?.value || today,
                    categoryText,
                    categoryObject,
                    description,
                    receiptImageKey: currentReceiptImageKey || '',
                    icon: categoryIconToUse
                };

                transactions.unshift(newTransaction);
                saveTransactions(transactions);
                localStorage.setItem('lastTransactionUpdate', Date.now());

                // 顯示提示
                if(resultDisplay){
                    resultDisplay.innerHTML=`<h3>🎉 新增成功</h3> 分類: ${escapeHtml(categoryText)} 金額: ${amountInputValue} ${currency}`;
                    resultDisplay.style.display='block';
                    setTimeout(()=>{resultDisplay.style.display='none'},1200);
                }

                // 重置表單
                recordForm.reset();
                if(dateInput) dateInput.value=today;
                resetImageInputUI();
                selectedPrimary=null;
                selectedSub=null;
                primaryCategoryButtons.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
                if(subCategoryButtons) subCategoryButtons.innerHTML='';
                if(subCategoryGroup) subCategoryGroup.style.display='none';

                if(window.parent?.switchPage) window.parent.switchPage(null,'transaction.html');
                else window.location.href='transaction.html';
            }

            // ---------- Helpers (不變) ----------
            function escapeHtml(s=''){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
            function hexToRgb(hex){const bigint=parseInt(hex.replace('#',''),16);return {r:(bigint>>16)&255,g:(bigint>>8)&255,b:bigint&255};}

            // ---------- Preview bind (不變) ----------
            function bindPreviewEvents(){
                const nameInput=$('#newCategoryName'), previewName=$('#previewNameText'), previewIcon=$('#previewIcon'), previewCard=$('#categoryPreviewCard');
                const colorSwatches=$$('.color-swatch'), colorPicker=$('#customColorPicker'), colorHiddenInput=$('#selectedColorValue'), iconRadios=$$('input[name="icon-selector"]');
                if(!nameInput||!previewCard) return;
                nameInput.addEventListener('input',e=>{previewName.textContent=e.target.value.trim()||'分類名稱';});
                function updatePreviewColor(color){previewCard.style.borderLeftColor=color;if(colorHiddenInput) colorHiddenInput.value=color;if(colorPicker) colorPicker.value=color;}
                colorSwatches.forEach(s=>s.addEventListener('click',()=>{colorSwatches.forEach(x=>x.classList.remove('active'));s.classList.add('active');updatePreviewColor(s.dataset.color);})); 
                if(colorPicker) colorPicker.addEventListener('input',e=>{colorSwatches.forEach(x=>x.classList.remove('active'));updatePreviewColor(e.target.value);});
                iconRadios.forEach(r=>r.addEventListener('change',e=>{if(e.target.checked) previewIcon.className=e.target.value;}));
                updatePreviewColor('#ff7f7f');

                colorSwatches.forEach(s => s.addEventListener('click', ()=>{
                    colorSwatches.forEach(x => x.classList.remove('active'));
                    s.classList.add('active');
                    const color = s.dataset.color;
                    if(previewCard) previewCard.style.borderLeftColor = color;
                    if(colorHiddenInput) colorHiddenInput.value = color;
                    if(colorPicker) colorPicker.value = color;
                }));
                if(colorPicker) colorPicker.addEventListener('input', e=>{
                    colorSwatches.forEach(x=>x.classList.remove('active'));
                    const color = e.target.value;
                    if(previewCard) previewCard.style.borderLeftColor = color;
                    if(colorHiddenInput) colorHiddenInput.value = color;
                });
            }

            // ---------- URL type (不變) ----------
            function checkURLTypeAndSetDefault(){
                const urlParams=new URLSearchParams(window.location.search);
                const type=urlParams.get('type');
                if(type==='income'||type==='expense'){
                    const btn=document.querySelector(`.type-btn[data-type="${type}"]`);
                    if(btn&&!btn.classList.contains('active')) btn.click();
                }
            }

        })();

        function saveReceiptImage(base64) {
            const key = 'receipt_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
            const map = JSON.parse(localStorage.getItem('receiptImages') || '{}');
            map[key] = base64;
            localStorage.setItem('receiptImages', JSON.stringify(map));
            return key;
        }
    </script>

    <script>
        /**
         * 切換單一圖示類別收合狀態
         */
        function toggleIconCategory(catId) {
            const catElement = document.getElementById(catId);
            if (catElement) {
                catElement.classList.toggle('collapsed');
            }
        }

        /**
         * 批次展開或收合所有類別，並處理按鈕 Active 效果
         * @param {boolean} isOpen - true 為展開, false 為收合
         * @param {HTMLElement} element - 被點擊的按鈕元素
         */
        function toggleAllIconCategories(isOpen, element) {
            // 1. 切換所有分類的收合狀態
            const categories = document.querySelectorAll('.icon-category');
            categories.forEach(cat => {
                if (isOpen) {
                    cat.classList.remove('collapsed');
                } else {
                    cat.classList.add('collapsed');
                }
            });

            // 2. 切換按鈕的 Active 效果
            // 先移除同容器內所有按鈕的 active
            const parent = element.parentElement;
            parent.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            
            // 給當前點擊的按鈕加上 active
            element.classList.add('active');
        }

        // 選擇性：如果你希望每次打開 Modal 時預設是收合的，可以加在 openAddCategoryModal 裡
        // function openAddCategoryModal(ctx) {
        //     toggleAllIconCategories(false); // 打開時預設收合
        //     ...
            // }
    </script>

</html>