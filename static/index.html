<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè¨˜å¸³ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-4">ğŸ’° å€‹äººè¨˜å¸³ç®¡ç†ç³»çµ±</h1>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card p-4">
                    <h4 class="mb-3">â• æ–°å¢æ¶ˆè²»</h4>
                    <form id="expenseForm">
                        <div class="mb-3">
                            <label class="form-label">æ¶ˆè²»é …ç›®</label>
                            <input type="text" class="form-control" id="itemName" placeholder="ä¾‹å¦‚ï¼šç‰›è‚‰éºµ" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é‡‘é¡</label>
                            <input type="number" class="form-control" id="amount" placeholder="100" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é¡åˆ¥</label>
                            <select class="form-select" id="category">
                                <option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option>
                                <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                                <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                                <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å‚™è¨» (é¸å¡«)</label>
                            <input type="text" class="form-control" id="note">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">æ–°å¢ç´€éŒ„</button>
                    </form>
                </div>

                <div class="card p-4 mt-3 bg-light">
                    <h5 class="mb-3">ğŸ“Š è²¡å‹™åˆ†æ (ç­–ç•¥æ¨¡å¼)</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <button onclick="fetchStats('total')" class="btn btn-sm btn-outline-success">è¨ˆç®—ç¸½å’Œ</button>
                        <button onclick="fetchStats('average')" class="btn btn-sm btn-outline-info">è¨ˆç®—å¹³å‡</button>
                    </div>
                    <div class="alert alert-secondary text-center mb-0" id="statsResult">
                        é»æ“ŠæŒ‰éˆ•æŸ¥çœ‹åˆ†æ
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>ğŸ“‹ æ¶ˆè²»ç´€éŒ„åˆ—è¡¨</h4>
                        <button onclick="loadExpenses()" class="btn btn-sm btn-outline-secondary">ğŸ”„ é‡æ–°æ•´ç†</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>é …ç›®</th>
                                    <th>é¡åˆ¥</th>
                                    <th>é‡‘é¡</th>
                                    <th>æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_URL = "/api/v1/expenses";

        // 1. è¼‰å…¥æ‰€æœ‰è¨˜å¸³è³‡æ–™
        async function loadExpenses() {
            try {
                const response = await fetch(API_URL + "/");
                const data = await response.json();
                const tbody = document.getElementById("expenseTableBody");
                tbody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼

                data.forEach(expense => {
                    const row = `
                        <tr>
                            <td>${expense.item_name} <small class="text-muted d-block">${expense.note || ''}</small></td>
                            <td><span class="badge bg-secondary">${expense.category}</span></td>
                            <td class="fw-bold text-danger">$${expense.amount}</td>
                            <td class="small text-muted">${new Date(expense.created_at).toLocaleString()}</td>
                            <td>
                                <button onclick="deleteExpense(${expense.id})" class="btn btn-sm btn-outline-danger">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                alert("è¼‰å…¥å¤±æ•—ï¼š" + error);
            }
        }

        // 2. æ–°å¢è¨˜å¸³ (è¡¨å–®é€å‡º)
        document.getElementById("expenseForm").addEventListener("submit", async (e) => {
            e.preventDefault(); // é˜²æ­¢ç¶²é é‡æ–°æ•´ç†
            
            const payload = {
                item_name: document.getElementById("itemName").value,
                amount: parseInt(document.getElementById("amount").value),
                category: document.getElementById("category").value,
                note: document.getElementById("note").value
            };

            try {
                const response = await fetch(API_URL + "/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    document.getElementById("expenseForm").reset(); // æ¸…ç©ºè¡¨å–®
                    loadExpenses(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                } else {
                    alert("æ–°å¢å¤±æ•—");
                }
            } catch (error) {
                alert("éŒ¯èª¤ï¼š" + error);
            }
        });

        // 3. åˆªé™¤è¨˜å¸³
        async function deleteExpense(id) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;

            try {
                await fetch(`${API_URL}/${id}`, { method: "DELETE" });
                loadExpenses(); // é‡æ–°è¼‰å…¥
            } catch (error) {
                alert("åˆªé™¤å¤±æ•—");
            }
        }

        // 4. å–å¾—çµ±è¨ˆ (å±•ç¤ºç­–ç•¥æ¨¡å¼)
        async function fetchStats(type) {
            const resultBox = document.getElementById("statsResult");
            resultBox.textContent = "è¨ˆç®—ä¸­...";
            
            try {
                const response = await fetch(`${API_URL}/stats?type=${type}`);
                const data = await response.json();
                
                let text = type === 'total' ? 'ç¸½èŠ±è²»' : 'å¹³å‡æ¯ç­†';
                resultBox.innerHTML = `<strong>${text}ï¼š$${data.result}</strong>`;
                resultBox.className = type === 'total' ? "alert alert-success text-center mb-0" : "alert alert-info text-center mb-0";
            } catch (error) {
                resultBox.textContent = "åˆ†æå¤±æ•—";
            }
        }

        // ç¶²é è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œä¸€æ¬¡
        loadExpenses();
    </script>
</body>
</html>