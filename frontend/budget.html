<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ é ç®—æ§åˆ¶ä¸­å¿ƒ | LumiTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-secondary: #1e1e1e;
            --neon-blue: #a7d7ff;
            --neon-pink: #ffb3cf;
            --neon-green: #a8f0c6;
            --neon-yellow: #fff1a6;
            --neon-red: #ff7f7f;
            --text-light: #e6e6e6;
            --text-dark: #b8b8b8;
            --border-color: #2a2a2a;

            
            --cat-1: #ff7f7f;
            --cat-2: #ffcc66;
            --cat-3: #a8f0c6;
            --cat-4: #a7d7ff;
            --cat-5: #ffb3cf;
            --cat-6: #cf9cff;
            --cat-7: #66ffcc;
            --cat-8: #ff9c66;
            --cat-9: #99ccff;
            --cat-10: #d4d4d4;
            --cat-11: #ffd1dc;
            --cat-12: #ffe066;
            --cat-13: #8affc1;
            --cat-14: #8ed1ff;
            --cat-15: #c9a7ff;
            --cat-16: #ffb380;
            --cat-17: #b3ffb3;
            --cat-18: #b3d9ff;
            --cat-19: #ffe6b3;
            --cat-20: #ffadad;
        }

        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        body { margin:0; padding:20px; background:var(--bg-dark); font-family:'Segoe UI', sans-serif; color:var(--text-light); }
        .container { max-width: 900px; margin:auto; padding-bottom:80px; }

        .page-title { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); font-size:1.8em; margin-bottom:25px; display:flex; align-items:center; gap:12px; }

        .total-budget-card { background: linear-gradient(145deg,#1e1e1e,#252525); padding:25px; border-radius:20px; margin-bottom:30px; text-align:center; border:1px solid var(--border-color); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .total-title { color: var(--text-dark); font-size:1rem; }
        .total-amount { font-size:2.6rem; font-weight:bold; margin:15px 0; transition: color 0.3s; }

        .progress-container { background: rgba(255,255,255,0.1); height:18px; border-radius:9px; overflow:hidden; margin:10px 0; }
        .progress-fill { height:100%; width:0%; transition: width 0.8s cubic-bezier(0.34,1.56,0.64,1), background-color 0.3s; }
        .progress-text { display:flex; justify-content:space-between; color: var(--text-dark); font-size:0.9em; }

        .budget-list { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); gap:20px; }
        .budget-card { background: var(--bg-secondary); padding:20px; border-radius:16px; border:1px solid var(--border-color); transition: transform 0.2s, background 0.2s; }
        .main-budget-card { cursor:pointer; }
        .main-budget-card:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); }

        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .cat-info { display:flex; gap:12px; align-items:center; }
        .cat-icon { width:40px; height:40px; border-radius:50%; background: rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; font-size:1.2rem; }
        .cat-name { font-weight:bold; }
        .expand-icon { transition: transform 0.3s; font-size:0.8em; margin-left:5px; color: var(--text-dark); }
        .expanded .expand-icon { transform: rotate(180deg); }

        .budget-setter { text-align:right; }
        .budget-label { font-size:0.75rem; color: var(--text-dark); margin-bottom:2px; }
        .budget-display { font-size:1.1rem; cursor:pointer; transition: color 0.2s; font-weight:500; }
        .budget-display:hover { color: var(--neon-yellow); text-decoration:underline; }
        .budget-input { display:none; width:90px; background:#000; color:#fff; border:1px solid var(--neon-blue); padding:5px; border-radius:6px; text-align:right; font-size:1rem; outline:none; box-shadow:0 0 10px rgba(167,215,255,0.3); }

        .card-stats { display:flex; justify-content:space-between; margin-top:10px; font-size:0.85em; color: var(--text-dark); }
        .sub-category-container { display:none; margin-left:15px; padding-left:15px; border-left:1px dashed #444; margin-top:10px; }
        .sub-category-container.active { display:block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-5px);} to { opacity:1; transform:translateY(0);} }

        .toast { position: fixed; bottom:30px; left:50%; transform:translateX(-50%); background: var(--neon-green); color:#000; padding:10px 25px; border-radius:30px; font-weight:bold; opacity:0; transition:0.3s; z-index:1000; box-shadow:0 5px 15px rgba(0,0,0,0.3);}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title"><i class="fas fa-shield-alt"></i> é ç®—æ§åˆ¶ä¸­å¿ƒ</h1>

        <div class="total-budget-card">
            <div class="total-title" id="monthTitle">æœ¬æœˆå‰©é¤˜é ç®—</div>
            <div class="total-amount" id="totalRemaining">---</div>
            <div class="progress-container"><div class="progress-fill" id="totalBar"></div></div>
            <div class="progress-text"><span id="totalSpentText">å·²èŠ± ---</span><span id="totalBudgetText">ç¸½é ç®— ---</span></div>
        </div>

        <div class="budget-list" id="budgetList"></div>
        <div id="noBudgetMsg" style="text-align:center;color:var(--text-dark);padding:50px 0;display:none;">
            <i class="fas fa-receipt fa-3x" style="color:var(--neon-pink);margin-bottom:15px;"></i>
            <h3>å°šæœªè¨­å®šåˆ†é¡æˆ–é ç®—</h3>
            <p>é»æ“Šä¸Šæ–¹åˆ†é¡é‡‘é¡å³å¯é–‹å§‹è¨­å®šé ç®—</p>
        </div>
    </div>

    <div class="toast" id="toast">âœ… é ç®—å·²æ›´æ–°</div>

    <script>
        // -------------------------- å›ºå®šåŒ¯ç‡ --------------------------
        const FIXED_RATES={TWD:1,USD:0.032,JPY:4.6,EUR:0.029,HKD:0.24,CNY:0.22,GBP:0.024,AUD:0.046,KRW:41.5,SGD:0.041};
        const SYMBOL_MAP={TWD:'NT$',USD:'$',JPY:'JPÂ¥',EUR:'â‚¬',HKD:'HK$',CNY:'CNÂ¥',GBP:'Â£',AUD:'A$',KRW:'â‚©',SGD:'S$'};

        function getCurrencyInfo(){
            const cur=JSON.parse(localStorage.getItem('app_currency'))||{base:'TWD'};
            const base=cur.base||'TWD';
            const symbol=SYMBOL_MAP[base]||'$';
            const rate=FIXED_RATES[base]||1;
            return {base,symbol,rate};
        }

        function convertAmount(amountTWD){
            const {rate}=getCurrencyInfo();
            return amountTWD*rate;
        }

        // -------------------------- æ¸²æŸ“é ç®— --------------------------
        function renderBudget(){
            const budgetSettings=JSON.parse(localStorage.getItem('budget_settings'))||{};
            const transactions=JSON.parse(localStorage.getItem('transactions'))||[];
            const categoryData=JSON.parse(localStorage.getItem('categoryData'))||getDefaultCategories();
            const {symbol}=getCurrencyInfo();

            const now=new Date();
            const currentMonth=now.getMonth();
            const currentYear=now.getFullYear();
            document.getElementById('monthTitle').textContent=`${currentMonth+1} æœˆå‰©é¤˜é ç®—`;

            let totalBudget=0,totalSpent=0;
            const container=document.getElementById('budgetList');
            container.innerHTML='';

            categoryData.expense.forEach((mainCat,idx)=>{
                const budgetBase=budgetSettings[mainCat.name]||0;
                const budgetConverted=convertAmount(budgetBase);

                const spent=transactions
                    .filter(t=>{
                        const d=new Date(t.date); 
                        return d.getMonth()===currentMonth && d.getFullYear()===currentYear && t.type==='expense' && t.category===mainCat.name;
                    })
                    .reduce((a,t)=>a+convertAmount(t.baseAmount||t.amount||0),0);

                totalBudget+=budgetConverted;
                totalSpent+=spent;

                let subHtml='';
                if(mainCat.sub?.length>0){
                    mainCat.sub.forEach(sub=>{
                        const subKey=`${mainCat.name} / ${sub.name}`;
                        const subBudget=convertAmount(budgetSettings[subKey]||0);
                        const subSpent=transactions
                            .filter(t=>t.category===subKey)
                            .reduce((a,t)=>a+convertAmount(t.baseAmount||t.amount||0),0);
                        subHtml+=createCardHtml(subKey,sub.name,subBudget,subSpent,sub.color,sub.icon,true,false,0,symbol);
                    });
                }

                container.insertAdjacentHTML('beforeend',`
                    <div class="category-group">
                        ${createCardHtml(mainCat.name,mainCat.name,budgetConverted,spent,mainCat.color,mainCat.icon,false,mainCat.sub?.length>0,idx,symbol)}
                        <div id="sub-container-${idx}" class="sub-category-container">${subHtml}</div>
                    </div>
                `);
            });

            updateTotalDisplay(totalBudget,totalSpent,symbol);
            document.getElementById('noBudgetMsg').style.display=categoryData.expense.length?'none':'block';
        }

        function createCardHtml(key,name,budget,spent,color,icon,isSub,hasSubs,idx,symbol){
            const progress=budget>0?Math.min(100,(spent/budget)*100):(spent>0?100:0);
            const barColor=progress>=100?'var(--neon-red)':(progress>80?'var(--neon-yellow)':(isSub?color:'var(--neon-green)'));
            const formattedBudget=budget>0?`${symbol}${Math.round(budget).toLocaleString()}`:'é»æ“Šè¨­å®š';
            const formattedSpent=`${symbol}${Math.round(spent).toLocaleString()}`;

            return `
                <div id="${!isSub?'main-card-'+idx:''}" class="budget-card ${!isSub?'main-budget-card':''}" ${!isSub && hasSubs?`onclick="toggleSub(${idx})"`:''} style="margin-bottom:10px; border-left:4px solid ${color}">
                    <div class="card-header">
                        <div class="cat-info">
                            <span class="cat-icon" style="color:${color};"><i class="${icon}"></i></span>
                            <span class="cat-name" style="color:${color}; font-size:${isSub?'0.9em':'1.1em'};">
                                ${name} ${!isSub && hasSubs?'<i class="fas fa-chevron-down expand-icon"></i>':''}
                            </span>
                        </div>
                        <div class="budget-setter" onclick="event.stopPropagation();">
                            <div class="budget-label">é ç®— (${symbol})</div>
                            <div class="budget-display" onclick="editBudget(this)" style="color:${budget>0?'var(--text-light)':'var(--text-dark)'}">
                                ${formattedBudget}
                            </div>
                            <input type="number" class="budget-input" value="${budget>0?Math.round(budget):''}" 
                                onblur="saveBudget(this,'${key}')"
                                onkeydown="if(event.key==='Enter') this.blur()">
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" style="width:${progress}%; background-color:${barColor}; box-shadow:0 0 10px ${barColor}66;"></div>
                    </div>
                    <div class="card-stats">
                        <span>å·²èŠ± ${formattedSpent}</span>
                        <span style="color:${progress>=100?'var(--neon-red)':'inherit'}">${progress.toFixed(0)}%</span>
                    </div>
                </div>
            `;
        }

        function updateTotalDisplay(budget,spent,symbol){
            const remain=budget-spent;
            const remainEl=document.getElementById('totalRemaining');
            const bar=document.getElementById('totalBar');
            const p=budget>0?Math.min(100,(spent/budget)*100):0;

            remainEl.textContent=`${symbol}${Math.round(remain).toLocaleString()}`;
            remainEl.style.color=remain>=0?'var(--neon-green)':'var(--neon-red)';
            remainEl.style.textShadow=remain>=0?'0 0 15px rgba(168,240,198,0.5)':'0 0 15px rgba(255,127,127,0.5)';

            document.getElementById('totalSpentText').textContent=`å·²èŠ± ${symbol}${Math.round(spent).toLocaleString()}`;
            document.getElementById('totalBudgetText').textContent=`ç¸½é ç®— ${symbol}${Math.round(budget).toLocaleString()}`;

            bar.style.width=`${p}%`;
            bar.style.backgroundColor=p>=100?'var(--neon-red)':(p>80?'var(--neon-yellow)':'var(--neon-green)');
        }

        function toggleSub(id){
            const container=document.getElementById(`sub-container-${id}`);
            const card=document.getElementById(`main-card-${id}`);
            if(container) container.classList.toggle('active');
            if(card) card.classList.toggle('expanded');
        }

        function editBudget(el){
            el.style.display='none';
            const input=el.nextElementSibling;
            input.style.display='block';
            input.focus();
            input.select();
        }

        function saveBudget(input,key){
            const val=parseFloat(input.value);
            const settings=JSON.parse(localStorage.getItem('budget_settings'))||{};
            const {rate}=getCurrencyInfo();
            if(isNaN(val)||val<=0) delete settings[key];
            else settings[key]=val/rate;
            localStorage.setItem('budget_settings',JSON.stringify(settings));
            renderBudget();
            const t=document.getElementById('toast');
            t.style.opacity=1;
            setTimeout(()=>t.style.opacity=0,1500);
        }

        function getDefaultCategories(){ return {expense:[
            {id:1,name:"é¤é£²",icon:"fas fa-utensils",color:"var(--cat-1)",sub:[
                {id:101,name:"å¤–é£Ÿ",icon:"fas fa-burger",color:"var(--cat-1)"},
                {id:102,name:"é£²å“",icon:"fas fa-coffee",color:"var(--cat-1)"},
                {id:103,name:"é›¶é£Ÿ",icon:"fas fa-cookie-bite",color:"var(--cat-1)"}
            ]},
            {id:2,name:"äº¤é€š",icon:"fas fa-bus",color:"var(--cat-2)",sub:[
                {id:201,name:"æ²¹è³‡/å……é›»",icon:"fas fa-gas-pump",color:"var(--cat-2)"},
                {id:202,name:"å…¬è»Š/æ·é‹",icon:"fas fa-subway",color:"var(--cat-2)"},
                {id:203,name:"è¨ˆç¨‹è»Š",icon:"fas fa-taxi",color:"var(--cat-2)"}
            ]},
            {id:3,name:"è³¼ç‰©",icon:"fas fa-shopping-bag",color:"var(--cat-3)",sub:[
                {id:301,name:"æœé£¾",icon:"fas fa-shirt",color:"var(--cat-3)"},
                {id:302,name:"æ—¥ç”¨å“",icon:"fas fa-toilet-paper",color:"var(--cat-3)"},
                {id:303,name:"3C ç”¢å“",icon:"fas fa-mobile-screen-button",color:"var(--cat-3)"}
            ]},
            {id:4,name:"å¨›æ¨‚",icon:"fas fa-gamepad",color:"var(--cat-4)",sub:[
                {id:401,name:"é›»å½±/å±•è¦½",icon:"fas fa-ticket",color:"var(--cat-4)"},
                {id:402,name:"éŠæˆ²",icon:"fas fa-dice",color:"var(--cat-4)"},
                {id:403,name:"æ—…éŠ",icon:"fas fa-plane",color:"var(--cat-4)"}
            ]},
            {id:5,name:"å±…ä½",icon:"fas fa-home",color:"var(--cat-5)",sub:[
                {id:501,name:"æˆ¿ç§Ÿ/æˆ¿è²¸",icon:"fas fa-building-columns",color:"var(--cat-5)"},
                {id:502,name:"æ°´é›»ç“¦æ–¯",icon:"fas fa-lightbulb",color:"var(--cat-5)"},
                {id:503,name:"ç¶²è·¯/é›»ä¿¡",icon:"fas fa-signal",color:"var(--cat-5)"}
            ]}
        ]};}

        window.addEventListener('storage',(e)=>{
            if(['transactions','budget_settings','categoryData','app_currency'].includes(e.key)) renderBudget();
        });

        document.addEventListener('DOMContentLoaded',renderBudget);
    </script>
</body>
</html>
