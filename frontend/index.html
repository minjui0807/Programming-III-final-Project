<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ æ•¸æ“šæ ¸å¿ƒï¼šLumiTrackç³»çµ±</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --------------------------- å…¨åŸŸè®Šæ•¸ --------------------------- */
        :root{
            --bg-dark: #0f1115;
            --bg-secondary: #1e1e1e;
            --neon-blue: #a7d7ff;
            --neon-pink: #ffb3cf;
            --neon-green: #a8f0c6;
            --neon-yellow: #fff1a6;
            --text-light: #e6e6e6;
            --text-dark: #b8b8b8;
            --gray-default: #d8d8d8;
            --sidebar-width: 200px;
            --sidebar-collapsed-width: 72px;
            --border-color: #2a2a2a;
        }

        /* éš±è—æ‰€æœ‰æ²è»¸ä½†ä¿ç•™æ²å‹•åŠŸèƒ½ */
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        *::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        body{
            margin:0;
            padding:0;
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Noto Sans TC', 'Poppins', sans-serif;
            display:flex;
            min-height: 100vh;
            overflow: hidden;
        }

        /* --------------------------- å´é‚Šæ¬„ --------------------------- */
        .app-sidebar{
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: rgba(10,12,18,0.7);
            backdrop-filter: blur(8px);
            padding: 16px 12px;
            display:flex;
            flex-direction: column;
            gap: 12px;
            border-right: 1px solid rgba(255,255,255,0.04);
            transition: width .28s ease;
            height: 100vh;
            position: sticky;
            top:0;
            z-index: 100;
        }

        .app-sidebar.collapsed{
            width: var(--sidebar-collapsed-width);
            min-width: var(--sidebar-collapsed-width);
        }

        .sidebar-toggle{
            background: transparent;
            border: none;
            color: var(--text-light);
            padding: 8px;
            cursor: pointer;
            align-self: flex-end;
            transition: color 0.3s;
        }
        .sidebar-toggle:hover { color: var(--neon-blue); }

        .sidebar-brand{
            display:flex;
            align-items:center;
            gap:10px;
            padding: 6px 8px;
        }

        .brand-mark{
            width:36px; height:36px;
            display:flex;
            align-items:center;
            justify-content:center;
            background: linear-gradient(90deg, var(--neon-blue), #7ee0ff20);
            border-radius:8px;
            font-weight: bold;
        }

        .brand-text{
            font-size: 1rem;
            color: var(--neon-blue);
            font-weight:700;
            text-shadow: 0 0 20px #8fd3ff;
        }

        .sidebar-menu{
            list-style:none;
            padding:8px 4px;
            margin:0;
            display:flex;
            flex-direction:column;
            gap:6px;
        }

        .nav-item{
            display:flex;
            align-items:center;
            gap:12px;
            border-radius:10px;
            cursor:pointer;
            border:none;
            background:transparent;
            color: var(--text-dark);
            padding: 10px 12px;
            font-size: 1.05em;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover{
            background: rgba(155,228,255,0.05);
            transform: translateX(4px);
            color: var(--text-light);
        }

        .nav-item.active{
            color: var(--neon-blue);
            background: rgba(155,228,255,0.15);
            box-shadow: 0 0 10px rgba(155,228,255,0.3);
            text-shadow: 0 0 5px var(--neon-blue);
        }

        .nav-icon{
            width:25px;
            text-align:center;
            font-size: 1.3em;
        }

        .app-sidebar.collapsed .nav-label,
        .app-sidebar.collapsed .brand-text{
            display:none;
        }

        /* --------------------------- ä¸»å…§å®¹å€ (Iframe) --------------------------- */
        #content-frame {
            flex-grow: 1;
            border: none;
            width: 100%;
            height: 100vh;
            background-color: var(--bg-dark);
        }
    </style>
</head>

<body>

    <nav class="app-sidebar">
        <button id="sidebarToggle" class="sidebar-toggle">
            <i class="fas fa-bars"></i>
        </button>

        <div class="sidebar-brand">
            <span class="brand-mark">âš¡</span>
            <span class="brand-text">LumiTrack</span>
        </div>

        <ul id="sidebarMenu" class="sidebar-menu">
            <li>
                <button class="nav-item active" data-page="list" onclick="switchPage(this, 'transaction.html')">
                    <span class="nav-icon"><i class="fas fa-list"></i></span>
                    <span class="nav-label">äº¤æ˜“è¨˜éŒ„</span>
                </button>
            </li>
            <li>
                <button class="nav-item" data-page="record" onclick="switchPage(this, 'recordpage.html')">
                    <span class="nav-icon"><i class="fas fa-edit"></i></span>
                    <span class="nav-label">è¨˜å¸³é é¢</span>
                </button>
            </li>
            <li>
                <button class="nav-item" data-page="report" onclick="switchPage(this, 'report.html')">
                    <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                    <span class="nav-label">å ±å‘Šåˆ†æ</span>
                </button>
            </li>
            <li>
                <button class="nav-item" data-page="budget" onclick="switchPage(this, 'budget.html')">
                    <span class="nav-icon"><i class="fas fa-wallet"></i></span>
                    <span class="nav-label">ç®¡ç†é ç®—</span>
                </button>
            </li>
            <li>
                <button class="nav-item" data-page="settings" onclick="switchPage(this, 'settings.html')">
                    <span class="nav-icon"><i class="fas fa-cog"></i></span>
                    <span class="nav-label">ç³»çµ±è¨­å®š</span>
                </button>
            </li>
        </ul>
    </nav>

    <iframe id="content-frame" name="content-frame" src="transaction.html"></iframe>

    <script>
        /* ==============================
           å´é‚Šæ¬„æ§åˆ¶
        ================================ */
        document.getElementById("sidebarToggle").addEventListener("click", () => {
            document.querySelector(".app-sidebar").classList.toggle("collapsed");
        });

        function switchPage(element, url) {
            document.getElementById('content-frame').src = url;
            document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
            if (element) element.classList.add("active");
        }
        window.switchPage = switchPage;

        /* ==============================
           ğŸŒ åŒ¯ç‡æ ¸å¿ƒç³»çµ± (LumiTrack Brain)
        ================================ */
        const CURRENCY_KEY = 'app_currency';
        
        // ä¹–ä¹–è¦æ±‚çš„å¹£åˆ¥å°ç…§è¡¨
        const SYMBOL_MAP = { 
            TWD: 'NT$', USD: '$', JPY: 'Â¥', EUR: 'â‚¬', HKD: 'HK$', 
            CNY: 'Â¥', GBP: 'Â£', AUD: 'A$', KRW: 'â‚©', SGD: 'S$' 
        };

        // 1. å–å¾—è²¨å¹£è¨­å®š
        function getCurrencySetting() {
            const defaultData = {
                base: 'TWD',
                rates: { TWD: 1, USD: 0.031, JPY: 4.6, HKD: 0.24, CNY: 0.22, EUR: 0.028, GBP: 0.024, AUD: 0.046, KRW: 41.5, SGD: 0.041 },
                updatedAt: null
            };
            try {
                const stored = localStorage.getItem(CURRENCY_KEY);
                return stored ? JSON.parse(stored) : defaultData;
            } catch (e) { return defaultData; }
        }

        // 2. æŠ“å–å³æ™‚åŒ¯ç‡
        async function fetchLiveRates() {
            try {
                console.log("ğŸŒ æ­£åœ¨ç²å–æœ€æ–°åŒ¯ç‡...");
                // ä»¥ TWD ç‚ºåŸºæº–æŠ“å–
                const res = await fetch('https://open.er-api.com/v6/latest/TWD');
                const data = await res.json();
                
                if (data.result === "success") {
                    const currentSetting = getCurrencySetting();
                    const filteredRates = {};
                    
                    // åªä¿ç•™ SYMBOL_MAP ä¸­å®šç¾©çš„å¹£åˆ¥
                    Object.keys(SYMBOL_MAP).forEach(code => {
                        if (data.rates[code]) filteredRates[code] = data.rates[code];
                    });

                    const newSetting = {
                        ...currentSetting,
                        rates: filteredRates,
                        updatedAt: new Date().toISOString()
                    };

                    localStorage.setItem(CURRENCY_KEY, JSON.stringify(newSetting));
                    
                    // è§¸ç™¼ storage äº‹ä»¶è®“å…¶ä»–é é¢åŒæ­¥
                    window.dispatchEvent(new StorageEvent('storage', { key: CURRENCY_KEY }));
                    console.log("âœ… åŒ¯ç‡æ›´æ–°æˆåŠŸ:", filteredRates);
                    return newSetting;
                }
            } catch (err) {
                console.error("âŒ åŒ¯ç‡æ›´æ–°å¤±æ•— (ä½¿ç”¨ç·©å­˜):", err);
            }
            return getCurrencySetting();
        }

        // 3. å…¨åŸŸåŒ¯ç‡è½‰æ›å·¥å…· (ä¾›å­é é¢ window.parent.convertAmount èª¿ç”¨)
        // é‚è¼¯ï¼šæ‰€æœ‰äº¤æ˜“æ•¸æ“šåœ¨åº•å±¤é è¨­å­˜ç‚º TWDï¼Œé¡¯ç¤ºæ™‚æ‰è½‰ç‚ºç•¶å‰å¹£åˆ¥
        window.convertAmount = function(amountInTWD, toTarget = true) {
            const { base, rates } = getCurrencySetting();
            const rate = rates[base] || 1;
            // toTarget=true: TWD -> å¤–å¹£, false: å¤–å¹£ -> TWD
            return toTarget ? amountInTWD * rate : amountInTWD / rate;
        };

        // 4. å–å¾—ç•¶å‰å¹£åˆ¥ç¬¦è™Ÿ (ä¾›å­é é¢èª¿ç”¨)
        window.getCurrencySymbol = function() {
            const { base } = getCurrencySetting();
            return SYMBOL_MAP[base] || '$';
        };

        /* ==============================
           åˆå§‹åŒ–
        ================================ */
        document.addEventListener('DOMContentLoaded', () => {
            const setting = getCurrencySetting();
            // å¦‚æœè¶…é 6 å°æ™‚æ²’æœ‰æ›´æ–°ï¼Œå‰‡é‡æ–°æŠ“å–
            const lastUpdate = setting.updatedAt ? new Date(setting.updatedAt) : new Date(0);
            if (Date.now() - lastUpdate.getTime() > 6 * 60 * 60 * 1000) {
                fetchLiveRates();
            }
        });
    </script>
</body>
</html>