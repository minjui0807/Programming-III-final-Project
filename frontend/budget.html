<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›¡ï¸ é ç®—æ§åˆ¶ä¸­å¿ƒ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root{
    --bg-dark:#0f1115;
    --bg-secondary:#1e1e1e;
    --neon-green:#a8f0c6;
    --neon-yellow:#fff1a6;
    --neon-red:#ff7f7f;
    --text-light:#e6e6e6;
    --text-dark:#b8b8b8;
}

body{
    margin:0;
    padding:20px;
    background:var(--bg-dark);
    font-family:'Segoe UI',sans-serif;
    color:var(--text-light);
}

.container{max-width:900px;margin:auto;padding-bottom:80px;}

h2{
    color:var(--neon-green);
    border-bottom:2px solid var(--bg-secondary);
    padding-bottom:12px;
    margin-bottom:25px;
    display:flex;
    align-items:center;
    gap:12px;
}

/* -------- ç¸½è¦½ -------- */
.total-budget-card{
    background:linear-gradient(145deg,#1e1e1e,#252525);
    padding:25px;
    border-radius:20px;
    margin-bottom:30px;
    text-align:center;
}
.total-title{color:var(--text-dark);}
.total-amount{font-size:2.6rem;font-weight:bold;margin:15px 0;}

.progress-container{
    background:rgba(255,255,255,0.1);
    height:22px;
    border-radius:11px;
    overflow:hidden;
}
.progress-fill{
    height:100%;
    width:0%;
    transition:.5s;
}
.progress-text{
    display:flex;
    justify-content:space-between;
    margin-top:8px;
    color:var(--text-dark);
}

/* ç‹€æ…‹ */
.status-safe{background:var(--neon-green);}
.status-warning{background:var(--neon-yellow);}
.status-danger{background:var(--neon-red);}
.text-safe{color:var(--neon-green);}
.text-warning{color:var(--neon-yellow);}
.text-danger{color:var(--neon-red);}

/* -------- åˆ†é¡å¡ç‰‡ -------- */
.budget-list{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:20px;
}
.budget-card{
    background:var(--bg-secondary);
    padding:20px;
    border-radius:16px;
}
.card-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
}
.cat-info{display:flex;gap:12px;align-items:center;}
.cat-icon{
    width:42px;height:42px;
    border-radius:50%;
    background:rgba(255,255,255,0.1);
    display:flex;
    align-items:center;
    justify-content:center;
}
.cat-name{font-size:1.25rem;font-weight:bold;}

.budget-setter{
    text-align:right;
    cursor:pointer;
}
.budget-label{font-size:.8rem;color:var(--text-dark);}
.budget-display{font-size:1.1rem;color:var(--neon-yellow);}
.budget-input{
    display:none;
    width:90px;
    background:#000;
    color:#fff;
    border:1px solid #555;
    padding:4px;
    text-align:right;
}

.card-stats{
    display:flex;
    justify-content:space-between;
    margin-bottom:6px;
}

.toast{
    position:fixed;
    bottom:30px;
    left:50%;
    transform:translateX(-50%);
    background:var(--neon-green);
    color:#000;
    padding:10px 20px;
    border-radius:20px;
    font-weight:bold;
    opacity:0;
    transition:.3s;
}
</style>
</head>

<body>
<div class="container">
<h2><i class="fas fa-shield-alt"></i> é ç®—æ§åˆ¶ä¸­å¿ƒ</h2>

<div class="total-budget-card">
    <div class="total-title">æœ¬æœˆç¸½é ç®—å‰©é¤˜</div>
    <div class="total-amount" id="totalRemaining">$0</div>
    <div class="progress-container">
        <div class="progress-fill status-safe" id="totalBar"></div>
    </div>
    <div class="progress-text">
        <span id="totalSpentText">å·²èŠ± $0</span>
        <span id="totalBudgetText">ç¸½é ç®— $0</span>
    </div>
</div>

<div class="budget-list" id="budgetList"></div>
</div>

<div class="toast" id="toast">å·²æ›´æ–°é ç®—</div>

</body>

    <script>
        function getExpenseCategories(){
        let raw = localStorage.getItem('categoryData');
        if(!raw){
            const DEFAULT_CATEGORY_DATA = {
                expense: [
                    { id: 1, name: 'é¤é£²', icon:'fas fa-utensils', color:'#ff7f7f', colorRgb:'255,127,127', subs:[] },
                    { id: 2, name: 'äº¤é€š', icon:'fas fa-bus', color:'#7fbfff', colorRgb:'127,191,255', subs:[] },
                    { id: 3, name: 'è³¼ç‰©', icon:'fas fa-shopping-bag', color:'#bf7fff', colorRgb:'191,127,255', subs:[] },
                    { id: 4, name: 'å¨›æ¨‚', icon:'fas fa-film', color:'#ffff7f', colorRgb:'255,255,127', subs:[] }
                ],
                income: []
            };
            localStorage.setItem('categoryData', JSON.stringify(DEFAULT_CATEGORY_DATA));
            raw = JSON.stringify(DEFAULT_CATEGORY_DATA);
        }

        try {
            const data = JSON.parse(raw);
            // â­ è¿”å›å®Œæ•´è³‡æ–™
            return (data.expense || []).map(c => ({
                id: c.id,
                name: c.name,
                icon: c.icon || 'fas fa-tag',
                color: c.color || '#ff7f7f',
                colorRgb: c.colorRgb || '255,127,127',
                subs: c.subs || []
            }));
        } catch {
            return [];
        }
    }

        /* ========= è¨ˆç®—èŠ±è²» ========= */
        function calculateSpending(){
            const trans = JSON.parse(localStorage.getItem('transactions')) || [];
            const map = {};

            trans.forEach(t=>{
                if(t.type === 'expense'){
                    let catName = '';
                    if (t.categoryObject && t.categoryObject.primary) {
                        catName = t.categoryObject.primary.name;
                    } else if (t.categoryText) {
                        catName = t.categoryText.split(' / ')[0];
                    } else if (t.category) {
                        catName = t.category.split(' / ')[0];
                    }
                    if (catName) {
                        map[catName] = (map[catName] || 0) + Number(t.amount);
                    }
                }
            });

            return map;
        }

        /* ========= ä¸»æ¸²æŸ“ ========= */
        function renderBudget(){
            const cats = getExpenseCategories();
            const spendMap = calculateSpending();
            const settings = JSON.parse(localStorage.getItem('budget_settings'))||{};
            const list = document.getElementById('budgetList');
            if(!list) return;
            list.innerHTML='';

            let totalBudget=0,totalSpent=0;

            cats.forEach(c=>{
                const spent = spendMap[c.name]||0;
                const budget = settings[c.name] ?? 0;
                totalSpent += spent;
                totalBudget += budget;

                const percent = budget ? (spent / budget * 100) : 0;
                let status='safe';
                if(percent >= 100) status='danger';
                else if(percent >= 80) status='warning';
                else if(budget === 0 && spent > 0) status='warning';

                const card=document.createElement('div');
                card.className='budget-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="cat-info">
                            <div class="cat-icon text-${status}"><i class="${c.icon}"></i></div>
                            <div class="cat-name">${c.name}</div>
                        </div>
                        <div class="budget-setter" onclick="editBudget(this)">
                            <div class="budget-label">ç›®æ¨™é ç®—</div>
                            <div class="budget-display">
                                ${settings[c.name] !== undefined ? `$${budget}` : 'æœªè¨­å®š'}
                            </div>
                            <input class="budget-input" type="number"
                                value="${settings[c.name] !== undefined ? budget : ''}"
                                onblur="saveBudget(this,'${c.name}')">
                        </div>
                    </div>
                    <div class="card-stats">
                        <span class="text-${status}">å·²èŠ± $${spent}</span>
                        <span>${percent.toFixed(0)}%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill status-${status}" style="width:${Math.min(percent,100)}%"></div>
                    </div>`;
                list.appendChild(card);
            });

            updateTotal(totalBudget,totalSpent);
        }

        /* ========= ç¸½è¦½ ========= */
        function updateTotal(budget,spent){
            const spentEl = document.getElementById('totalSpentText');
            const budgetEl = document.getElementById('totalBudgetText');
            const remainEl = document.getElementById('totalRemaining');
            const bar = document.getElementById('totalBar');
            if(spentEl) spentEl.textContent=`å·²èŠ± $${spent}`;
            if(budgetEl) budgetEl.textContent=`ç¸½é ç®— $${budget}`;
            if(remainEl) remainEl.textContent=`$${budget - spent}`;
            if(bar) bar.style.width = budget ? `${Math.min(spent/budget*100,100)}%` : '0%';
        }

        /* ========= ç·¨è¼¯é ç®— ========= */
        function editBudget(el){
            el.querySelector('.budget-display').style.display='none';
            const input=el.querySelector('.budget-input');
            input.style.display='block';
            input.focus();
        }

        function saveBudget(input, cat){
            const cardEl = input.closest('.budget-setter');
            const settings = JSON.parse(localStorage.getItem('budget_settings'))||{};
            if(input.value.trim()===''){
                delete settings[cat];
            } else {
                settings[cat] = Number(input.value);
            }
            localStorage.setItem('budget_settings',JSON.stringify(settings));

            cardEl.querySelector('.budget-display').style.display='block';
            cardEl.querySelector('.budget-input').style.display='none';

            showToast();
            renderBudget();
        }

        function showToast(){
            const t=document.getElementById('toast');
            if(!t) return;
            t.style.opacity=1;
            setTimeout(()=>t.style.opacity=0,1200);
        }

        /* ========= ç›£è½è³‡æ–™è®Šå‹•ï¼Œç«‹å³åŒæ­¥åˆ†é¡ ========= */
        window.addEventListener('storage', (e)=>{
            if(e.key === 'categoryData' || e.key==='lastTransactionUpdate'){
                renderBudget();
            }
        });

        document.addEventListener('visibilitychange', ()=>{
            if(!document.hidden){
                renderBudget();
            }
        });

        // åˆå§‹æ¸²æŸ“
        renderBudget();
    </script>


</html>
