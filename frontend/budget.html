<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ é ç®—æ§åˆ¶ä¸­å¿ƒ | LumiTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --------------------------- å…¨åŸŸè®Šæ•¸èˆ‡éœ“è™¹æ¨£å¼ --------------------------- */
        :root {
            --bg-dark: #0f1115;
            --bg-secondary: #1e1e1e;
            --neon-blue: #a7d7ff;
            --neon-pink: #ffb3cf;
            --neon-green: #a8f0c6;
            --neon-yellow: #fff1a6;
            --neon-red: #ff7f7f;
            --text-light: #e6e6e6;
            --text-dark: #b8b8b8;
            --border-color: #2a2a2a;

            /* åˆ†é¡é¡è‰² */
            --cat-1: #ff7f7f; --cat-2: #ffcc66; --cat-3: #a8f0c6; --cat-4: #a7d7ff;
            --cat-5: #ffb3cf; --cat-6: #cf9cff; --cat-12: #ffe066;
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        *::-webkit-scrollbar { display: none; }

        body {
            margin: 0;
            padding: 20px;
            background: var(--bg-dark);
            font-family: 'Segoe UI', sans-serif;
            color: var(--text-light);
        }

        .container { max-width: 900px; margin: auto; padding-bottom: 80px; }

        .page-title {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            font-size: 1.8em;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* --------------------------- ç¸½è¦½å¡ç‰‡ --------------------------- */
        .total-budget-card {
            background: linear-gradient(145deg, #1e1e1e, #252525);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .total-title { color: var(--text-dark); font-size: 1rem; }
        .total-amount { font-size: 2.6rem; font-weight: bold; margin: 15px 0; }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            height: 18px;
            border-radius: 9px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s ease-in-out, background-color 0.3s;
        }
        .progress-text {
            display: flex;
            justify-content: space-between;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        /* --------------------------- åˆ†é¡åˆ—è¡¨ --------------------------- */
        .budget-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        .budget-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }
        .main-budget-card { cursor: pointer; }
        .main-budget-card:hover { background: rgba(255, 255, 255, 0.05); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .cat-info { display: flex; gap: 12px; align-items: center; }
        .cat-icon {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .cat-name { font-weight: bold; }

        .expand-icon { transition: transform 0.3s; font-size: 0.8em; margin-left: 5px; }
        .expanded .expand-icon { transform: rotate(180deg); }

        .budget-setter { text-align: right; }
        .budget-label { font-size: 0.75rem; color: var(--text-dark); }
        .budget-display { font-size: 1rem; cursor: pointer; transition: color 0.2s; }
        .budget-display:hover { color: var(--neon-yellow); }
        .budget-input {
            display: none; width: 80px;
            background: #000; color: #fff;
            border: 1px solid var(--neon-blue);
            padding: 4px; border-radius: 4px; text-align: right;
        }

        .card-stats {
            display: flex; justify-content: space-between;
            margin-top: 10px; font-size: 0.85em; color: var(--text-dark);
        }

        /* å­åˆ†é¡å®¹å™¨ */
        .sub-category-container {
            display: none;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 1px dashed #444;
            margin-top: 10px;
        }
        .sub-category-container.active { display: block; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--neon-green); color: #000;
            padding: 10px 25px; border-radius: 30px;
            font-weight: bold; opacity: 0; transition: 0.3s; z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="page-title"><i class="fas fa-shield-alt"></i> é ç®—æ§åˆ¶ä¸­å¿ƒ</h1>

        <div class="total-budget-card">
            <div class="total-title">æœ¬æœˆå‰©é¤˜é ç®—</div>
            <div class="total-amount" id="totalRemaining">$0</div>
            <div class="progress-container">
                <div class="progress-fill" id="totalBar"></div> 
            </div>
            <div class="progress-text">
                <span id="totalSpentText">å·²èŠ± $0</span>
                <span id="totalBudgetText">ç¸½é ç®— $0</span>
            </div>
        </div>

        <div class="budget-list" id="budgetList"></div>

        <div id="noBudgetMsg" style="text-align: center; color: var(--text-dark); padding: 50px 0; display: none;">
            <i class="fas fa-receipt fa-3x" style="color: var(--neon-pink); margin-bottom: 15px;"></i>
            <h3>å°šæœªè¨­å®šåˆ†é¡æˆ–é ç®—</h3>
            <p>é»æ“Šä¸‹æ–¹åˆ†é¡é‡‘é¡å³å¯é–‹å§‹è¨­å®šé ç®—</p>
        </div>
    </div>

    <div class="toast" id="toast">âœ… é ç®—å·²æ›´æ–°</div>

    <script>
        /* ===============================
            é…ç½®èˆ‡è³‡æ–™å·¥å…·
        =============================== */
        const STORAGE_KEYS = {
            TRANSACTIONS: 'transactions',
            BUDGET: 'budget_settings',
            CATEGORY: 'categoryData',
            CURRENCY: 'app_currency'
        };

        const SYMBOL_MAP = { 
            TWD: 'NT$', USD: '$', JPY: 'Â¥', EUR: 'â‚¬', 
            HKD: 'HK$', CNY: 'Â¥', GBP: 'Â£', AUD: 'A$', 
            KRW: 'â‚©', SGD: 'S$' 
        };

        const getJSON = (key, defaultVal = {}) => {
            try { return JSON.parse(localStorage.getItem(key)) || defaultVal; } 
            catch { return defaultVal; }
        };

        // å–å¾—å¹£åˆ¥è³‡è¨Šèˆ‡åŒ¯ç‡
        function getCurrencyInfo() {
            const config = getJSON(STORAGE_KEYS.CURRENCY, { base: 'TWD', symbol: 'NT$', rates: { TWD: 1 } });
            const base = config.base || 'TWD';
            return {
                base: base,
                symbol: SYMBOL_MAP[base] || config.symbol || '$',
                rate: config.rates?.[base] || 1 // é€™æ˜¯ 1å°å¹£ å…Œæ›å¤šå°‘ å¤–å¹£
            };
        }

        /* ===============================
            æ ¸å¿ƒæ¸²æŸ“é‚è¼¯
        =============================== */
        function renderBudget() {
            const transactions = getJSON(STORAGE_KEYS.TRANSACTIONS, []);
            const budgetSettings = getJSON(STORAGE_KEYS.BUDGET, {}); // é€™è£¡å­˜çš„æ˜¯å°å¹£åŸºæº–
            const categoryData = getJSON(STORAGE_KEYS.CATEGORY, getDefaultCategories());
            const { symbol, rate } = getCurrencyInfo();

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // 1. è¨ˆç®—æœ¬æœˆå„åˆ†é¡æ”¯å‡º (å¾äº¤æ˜“ç´€éŒ„çš„ baseAmount æ›ç®—æˆç›®å‰å¹£åˆ¥)
            const expenseMap = transactions.reduce((acc, t) => {
                const tDate = new Date(t.date);
                if (tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear && t.type === 'expense') {
                    const fullName = t.category || t.categoryText || 'æœªåˆ†é¡';
                    // ä½¿ç”¨ baseAmount (å°å¹£) ä¹˜ä¸Š ç›®å‰åŒ¯ç‡
                    const amount = (parseFloat(t.baseAmount) || parseFloat(t.amount) || 0) * rate;
                    
                    acc[fullName] = (acc[fullName] || 0) + amount;
                    if (fullName.includes(' / ')) {
                        const mainName = fullName.split(' / ')[0];
                        acc[mainName] = (acc[mainName] || 0) + amount;
                    }
                }
                return acc;
            }, {});

            const container = document.getElementById('budgetList');
            container.innerHTML = '';

            let totalBudgetConverted = 0;
            let totalSpentConverted = 0;

            // 2. æ¸²æŸ“åˆ†é¡å¡ç‰‡
            categoryData.expense.forEach((mainCat, idx) => {
                const spent = expenseMap[mainCat.name] || 0;
                // â­ï¸ é—œéµä¿®æ­£ï¼šå°‡å„²å­˜çš„å°å¹£é ç®—ä¹˜ä¸ŠåŒ¯ç‡
                const budgetBase = budgetSettings[mainCat.name] || 0;
                const budgetConverted = budgetBase * rate;

                totalBudgetConverted += budgetConverted;
                totalSpentConverted += spent;

                const hasSubs = mainCat.sub && mainCat.sub.length > 0;
                let subHtml = '';

                if (hasSubs) {
                    mainCat.sub.forEach(sub => {
                        const subFullName = `${mainCat.name} / ${sub.name}`;
                        const subSpent = expenseMap[subFullName] || 0;
                        const subBudgetBase = budgetSettings[subFullName] || 0;
                        const subBudgetConverted = subBudgetBase * rate;
                        
                        subHtml += createCardHtml(subFullName, sub.name, subBudgetConverted, subSpent, mainCat.color, sub.icon, true, false, 0, symbol);
                    });
                }

                container.insertAdjacentHTML('beforeend', `
                    <div class="category-group">
                        ${createCardHtml(mainCat.name, mainCat.name, budgetConverted, spent, mainCat.color, mainCat.icon, false, hasSubs, idx, symbol)}
                        <div id="sub-container-${idx}" class="sub-category-container">
                            ${subHtml}
                        </div>
                    </div>
                `);
            });

            // 3. æ›´æ–°ç¸½è¦½
            updateTotalDisplay(totalBudgetConverted, totalSpentConverted, symbol);
            document.getElementById('noBudgetMsg').style.display = categoryData.expense.length ? 'none' : 'block';
        }

        function createCardHtml(key, name, budget, spent, color, icon, isSub, hasSubs, idx, symbol) {
            const progress = budget > 0 ? Math.min(100, (spent / budget) * 100) : (spent > 0 ? 100 : 0);
            const barColor = progress >= 100 ? 'var(--neon-red)' : (progress > 80 ? 'var(--neon-yellow)' : (isSub ? color : 'var(--neon-green)'));
            
            // é¡¯ç¤ºæ™‚å–æ•´æ•¸æ¯”è¼ƒç¾è§€
            const budgetLabel = budget > 0 ? `${symbol}${Math.round(budget).toLocaleString()}` : 'é»æ“Šè¨­å®š';

            return `
                <div id="${!isSub ? 'main-card-'+idx : ''}" class="budget-card ${!isSub ? 'main-budget-card' : ''}" 
                    ${!isSub && hasSubs ? `onclick="toggleSub(${idx})"` : ''} style="margin-bottom: 10px;">
                    <div class="card-header">
                        <div class="cat-info">
                            <span class="cat-icon" style="color: ${color};"><i class="${icon}"></i></span>
                            <span class="cat-name" style="color: ${color}; font-size: ${isSub ? '0.9em' : '1.1em'};">
                                ${name} ${!isSub && hasSubs ? '<i class="fas fa-chevron-down expand-icon"></i>' : ''}
                            </span>
                        </div>
                        <div class="budget-setter" onclick="event.stopPropagation();">
                            <div class="budget-label">é ç®— (${symbol})</div>
                            <div class="budget-display" onclick="editBudget(this)" style="color: ${budget > 0 ? 'var(--text-light)' : 'var(--text-dark)'}">
                                ${budgetLabel}
                            </div>
                            <input type="number" class="budget-input" value="${budget > 0 ? Math.round(budget) : ''}" 
                                onblur="saveBudget(this, '${key}')"
                                onkeydown="if(event.key==='Enter') this.blur()">
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" style="width:${progress}%; background-color:${barColor};"></div>
                    </div>
                    <div class="card-stats">
                        <span>å·²èŠ± ${symbol}${Math.round(spent).toLocaleString()}</span>
                        <span>${progress.toFixed(0)}%</span>
                    </div>
                </div>
            `;
        }

        /* ===============================
            UI äº’å‹•åŠŸèƒ½
        =============================== */
        function updateTotalDisplay(budget, spent, symbol) {
            const remain = budget - spent;
            const remainEl = document.getElementById('totalRemaining');
            const bar = document.getElementById('totalBar');
            const p = budget > 0 ? Math.min(100, (spent/budget)*100) : 0;

            remainEl.textContent = `${symbol}${Math.round(remain).toLocaleString()}`;
            remainEl.style.color = remain >= 0 ? 'var(--neon-green)' : 'var(--neon-red)';
            
            document.getElementById('totalSpentText').textContent = `å·²èŠ± ${symbol}${Math.round(spent).toLocaleString()}`;
            document.getElementById('totalBudgetText').textContent = `ç¸½é ç®— ${symbol}${Math.round(budget).toLocaleString()}`;
            
            bar.style.width = `${p}%`;
            bar.style.backgroundColor = p >= 100 ? 'var(--neon-red)' : (p > 80 ? 'var(--neon-yellow)' : 'var(--neon-green)');
        }

        function toggleSub(id) {
            document.getElementById(`sub-container-${id}`)?.classList.toggle('active');
            document.getElementById(`main-card-${id}`)?.classList.toggle('expanded');
        }

        function editBudget(el) {
            el.style.display = 'none';
            const input = el.nextElementSibling;
            input.style.display = 'block';
            input.focus();
            input.select();
        }

        function saveBudget(input, key) {
            const { rate } = getCurrencyInfo();
            const settings = getJSON(STORAGE_KEYS.BUDGET, {});
            const val = parseFloat(input.value); // ä½¿ç”¨è€…è¼¸å…¥çš„ç•¶å‰è²¨å¹£é‡‘é¡
            
            if (isNaN(val) || val <= 0) {
                delete settings[key];
            } else {
                // â­ï¸ é—œéµä¿®æ­£ï¼šå­˜é€² localStorage ä¹‹å‰ï¼Œå…ˆé™¤ä»¥åŒ¯ç‡è½‰å›å°å¹£
                settings[key] = val / rate;
            }

            localStorage.setItem(STORAGE_KEYS.BUDGET, JSON.stringify(settings));
            renderBudget();
            
            const t = document.getElementById('toast');
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 1500);
        }

        function getDefaultCategories() {
            return {
                expense: [
                    { id: 1, name: "é¤é£²", icon: "fas fa-utensils", color: "var(--cat-1)", sub: [
                        { id: 101, name: "å¤–é£Ÿ", icon: "fas fa-burger", color: "var(--cat-1)" },
                        { id: 102, name: "é£²å“", icon: "fas fa-coffee", color: "var(--cat-1)" },
                        { id: 103, name: "é›¶é£Ÿ", icon: "fas fa-cookie-bite", color: "var(--cat-1)" },
                    ]},
                    { id: 2, name: "äº¤é€š", icon: "fas fa-bus", color: "var(--cat-2)", sub: [
                        { id: 201, name: "æ²¹è³‡/å……é›»", icon: "fas fa-gas-pump", color: "var(--cat-2)" },
                        { id: 202, name: "å…¬è»Š/æ·é‹", icon: "fas fa-subway", color: "var(--cat-2)" },
                        { id: 203, name: "è¨ˆç¨‹è»Š", icon: "fas fa-taxi", color: "var(--cat-2)" },
                    ]},
                    { id: 3, name: "è³¼ç‰©", icon: "fas fa-shopping-bag", color: "var(--cat-3)", sub: [
                        { id: 301, name: "æœé£¾", icon: "fas fa-shirt", color: "var(--cat-3)" },
                        { id: 302, name: "æ—¥ç”¨å“", icon: "fas fa-toilet-paper", color: "var(--cat-3)" },
                        { id: 303, name: "3C ç”¢å“", icon: "fas fa-mobile-screen-button", color: "var(--cat-3)" },
                    ]},
                    { id: 4, name: "å¨›æ¨‚", icon: "fas fa-gamepad", color: "var(--cat-4)", sub: [
                        { id: 401, name: "é›»å½±/å±•è¦½", icon: "fas fa-ticket", color: "var(--cat-4)" },
                        { id: 402, name: "éŠæˆ²", icon: "fas fa-dice", color: "var(--cat-4)" },
                        { id: 403, name: "æ—…éŠ", icon: "fas fa-plane", color: "var(--cat-4)" },
                    ]},
                    { id: 5, name: "å±…ä½", icon: "fas fa-home", color: "var(--cat-5)", sub: [
                        { id: 501, name: "æˆ¿ç§Ÿ/æˆ¿è²¸", icon: "fas fa-building-columns", color: "var(--cat-5)" },
                        { id: 502, name: "æ°´é›»ç“¦æ–¯", icon: "fas fa-lightbulb", color: "var(--cat-5)" },
                        { id: 503, name: "ç¶²è·¯/é›»ä¿¡", icon: "fas fa-signal", color: "var(--cat-5)" },
                    ]}
                ],
            };
        }

        // ç›£è½è·¨é é¢è®Šå‹• (å¹£ç¨®åˆ‡æ›ã€äº¤æ˜“å¢åŠ )
        window.addEventListener('storage', (e) => {
            if (Object.values(STORAGE_KEYS).includes(e.key)) renderBudget();
        });

        document.addEventListener('DOMContentLoaded', renderBudget);
    </script>
</body>
</html>