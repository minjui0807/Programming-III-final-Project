<!DOCTYPE html>
<html lang="zh-TW">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>âš¡ï¸ æ•¸æ“šæ ¸å¿ƒï¼šé‡å­è¨˜å¸³ç³»çµ±</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <style>
            
            :root{
                  /* æ¡ç”¨æŸ”å’Œçš„è‰²ç³» */
                  --bg-primary: #121212;
                  --bg-secondary: #1e1e1e;
                  --neon-blue: #a7d7ff;      /* æŸ”å’Œè— (ä¸»è‰²/æ”¶å…¥) */
                  --neon-pink: #ffb3cf;      /* æŸ”å’Œç²‰ (å‰¯è‰²/æ”¯å‡º) */
                  --neon-green: #a8f0c6;     /* æŸ”å’Œç¶  (é¤˜é¡/å‰©é¤˜é ç®—) */
                  --neon-yellow: #fff1a6;    /* æŸ”å’Œé»ƒ (å¼·èª¿/æ—¥æœŸ/é ç®—ç‹€æ…‹) */
                  --text-light: #e6e6e6;     /* äº®æ–‡å­— */
                  --text-dark: #b8b8b8;      /* æŸ”å’Œç°æ–‡å­— */
                  --gray-default: #d8d8d8;   /* é è¨­é‚Šæ¡†/ç„¡æ•¸æ“šè‰² */
            }
            body{
                  background-color: var(--bg-primary);
                  color: var(--text-light);
                  font-family: 'Space Mono', monospace;
                  margin: 0;
                  padding: 0;
            }
            .app-container{
                  display: flex;
                  min-height: 100vh;
            }
            .sidebar{
                  width: 250px;
                  background-color: var(--bg-secondary);
                  padding: 20px 0;
                  border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
            .sidebar h1{
                  color: var(--neon-blue);
                  text-align: center;
                  text-shadow: 0 0 5px rgba(167, 215, 255, 0.5); 
                  padding-bottom: 20px;
                  border-bottom: 1px dashed var(--text-dark);
                  margin: 0 20px 20px;
            }
            .sidebar ul{
                  list-style: none;
                  padding: 0;
            }
            .sidebar li{
                  padding: 15px 30px;
                  cursor: pointer;
                  transition: 0.3s;
            }
            .sidebar li:hover, .sidebar li.active{
                  background-color: rgba(167, 215, 255, 0.1); 
                  color: var(--neon-blue);
                  text-shadow: 0 0 8px rgba(167, 215, 255, 0.7);
            }
            main{
                  flex: 1;
                  padding: 30px;
            }
            .page{
                  display: none;
                  opacity: 0;
                  transform: translateY(20px);
                  transition: opacity 0.5s, transform 0.5s;
            }
            .page.active{
                  display: block;
                  opacity: 1;
                  transform: translateY(0);
            }
            .neon-title {
                  text-align: center;
                  font-size: 45px;
                  color: var(--neon-blue); 
                  margin: 20px 0 30px;
                  letter-spacing: 3px;
                  font-weight: 700;
                  animation: glowPulse 2.5s infinite ease-in-out;
            }
            @keyframes glowPulse {
                  0%{
                        text-shadow: 0 0 10px var(--neon-blue);
                  }
                  50%{
                        text-shadow: 0 0 25px var(--neon-blue);
                  }
                  100%{
                        text-shadow: 0 0 10px var(--neon-blue);
                  }
            }
            
            #current-date-display {
                  color: var(--neon-yellow);
                  text-shadow: 0 0 5px rgba(255, 241, 166, 0.5);
                  font-size: 1.2em;
                  text-align: right;
                  margin-bottom: 10px;
            }
            .metrics-bars-grid{
                  display: flex; 
                  flex-direction: row; 
                  gap: 20px; 
                  margin-bottom: 40px;
                  background-color: var(--bg-secondary); 
                  padding: 25px;
                  border-radius: 12px;
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  flex-wrap: wrap; 
            }
            .metric-bar{
                  flex: 1 1 200px; 
                  background-color: var(--bg-primary); 
                  padding: 15px 20px;
                  border-radius: 8px;
                  border: 1px solid rgba(255, 255, 255, 0.05);
                  position: relative;
                  overflow: hidden; 
            }
            .metric-bar .bar-label{
                  color: var(--text-dark);
                  font-size: 0.85em;
                  text-transform: uppercase;
                  margin-bottom: 5px;
            }
            .metric-bar .bar-value{
                  font-size: 1.8em; 
                  font-weight: bold;
                  margin-bottom: 15px; 
                  text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); 
            }
            /* é€²åº¦æ¢æ¨£å¼ */
            .progress-line{
                  width: 100%;
                  height: 8px; 
                  background-color: rgba(255, 255, 255, 0.1); 
                  border-radius: 4px;
                  overflow: hidden;
                  position: relative;
            }
            .progress-fill{
                  height: 100%;
                  width: 0%; 
                  border-radius: 4px;
                  transition: width 0.8s ease-out; 
                  position: absolute;
                  left: 0;
                  top: 0;
                  box-shadow: 0 0 10px; 
            }
            /* å„æ¢çš„é¡è‰²å’Œç™¼å…‰ */
            .metric-bar.income .bar-value{
                  color: var(--neon-blue);
            }
            .metric-bar.income .progress-fill{
                  background-color: var(--neon-blue);
                  box-shadow: 0 0 10px var(--neon-blue);
            }
            .metric-bar.expense .bar-value{
                  color: var(--neon-pink);
            }
            .metric-bar.expense .progress-fill{
                  background-color: var(--neon-pink);
                  box-shadow: 0 0 10px var(--neon-pink);
            }
            .metric-bar.balance .bar-value{
                  color: var(--neon-green);
            }
            
            .metric-bar.budget-status .bar-value{
                  color: var(--neon-yellow);
            }
            .metric-bar.budget-status .progress-fill{
                  background-color: var(--neon-yellow);
                  box-shadow: 0 0 10px var(--neon-yellow);
            }
            /* --- äº¤æ˜“å¡ç‰‡æ¨£å¼ --- */
            .transaction-date-card {
                  background-color: var(--bg-secondary); 
                  margin-bottom: 25px;
                  border-radius: 12px;
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  overflow: hidden;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            .date-header {
                  background-color: #2a2a2a; 
                  color: var(--neon-yellow); 
                  padding: 12px 25px;
                  font-size: 1.1em;
                  font-weight: bold;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            .transaction-row {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 15px 25px;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            }
            .transaction-row:last-child {
                  border-bottom: none;
            }
            .transaction-left {
                  display: flex;
                  align-items: center;
                  gap: 15px;
                  flex: 1;
            }
            .transaction-left > div {
                  display: flex;
                  flex-direction: column;
            }
            .icon {
                  width: 35px;
                  height: 35px;
                  border-radius: 50%;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  font-weight: bold;
                  color: var(--bg-primary); 
                  font-size: 1.2em;
                  flex-shrink: 0;
            }
            .category {
                  font-weight: bold;
                  color: var(--text-light); 
                  font-size: 1em;
            }
            .name {
                  color: var(--text-dark); 
                  font-size: 0.85em; 
                  margin-top: 2px;
            }
            .transaction-right {
                  text-align: right;
                  font-weight: bold;
                  min-width: 150px;
                  display: flex;
                  align-items: center;
                  gap: 15px;
                  justify-content: flex-end;
            }
            .transaction-right.income {
                  color: var(--neon-blue); 
            }
            .transaction-right.expense {
                  color: var(--neon-pink); 
            }
            .delete-btn {
                  background: none;
                  color: var(--text-dark);
                  border: 1px solid var(--text-dark);
                  padding: 4px 8px;
                  font-size: 0.8em;
                  cursor: pointer;
                  border-radius: 4px;
                  transition: 0.3s;
            }
            .delete-btn:hover {
                  background-color: rgba(255, 255, 255, 0.1);
                  color: var(--text-light);
            }
            
            /* åœ–è¡¨æ¨£å¼ */
            .chart-container{
                  background-color: var(--bg-secondary);
                  padding: 25px;
                  padding-top: 0;
                  border-radius: 12px;
                  border: 1px solid var(--neon-blue);
                  margin-bottom: 40px;
                  height: 500px; 
                  position: relative; 
            }
            /* åœ“é¤…åœ–åˆ‡æ›æŒ‰éˆ•ç¾¤çµ„ */
            .chart-controls {
                  display: flex;
                  gap: 10px;
                  margin-bottom: 20px;
                  padding: 10px 0;
                  border-bottom: 1px dashed var(--text-dark);
                  flex-wrap: wrap; 
            }
            
            .chart-controls button {
                  background: rgba(167, 215, 255, 0.1);
                  color: var(--neon-blue);
                  border: 1px solid var(--neon-blue);
                  padding: 8px 15px;
                  border-radius: 5px;
                  cursor: pointer;
                  transition: 0.3s;
                  white-space: nowrap; 
            }
            .chart-controls button.active,
            .chart-controls button:hover {
                  background: var(--neon-blue);
                  color: var(--bg-primary);
                  box-shadow: 0 0 10px rgba(167, 215, 255, 0.7);
            }
            /* è¼¸å…¥èˆ‡è¨­å®šå€å¡Š */
            .input-group{
                  background-color: var(--bg-secondary); 
                  padding: 25px;
                  border-radius: 12px;
                  border: 1px solid var(--neon-blue);
                  display:flex;
                  flex-direction: column;
                  gap:15px;
                  margin-bottom:20px;
            }
            .add-transaction, 
            .balance-setting{
                  display: flex;
                  gap: 10px;
                  flex-wrap: wrap;
            }
            .add-transaction input, 
            .add-transaction select, 
            .add-transaction button,
            .balance-setting input, 
            .balance-setting button{
                  padding: 10px;
                  border: 1px solid rgba(167, 215, 255, 0.3); 
                  border-radius: 5px;
                  font-size: 14px;
                  background: rgba(255,255,255,0.05); 
                  color: var(--text-light);
            }
            
            .add-transaction input, 
            .add-transaction select {
                  flex: 1;
                  min-width: 120px;
            }
            
            .add-transaction button {
                  min-width: 120px;
            }
            
            /* ç¢ºä¿ä¸‹æ‹‰é¸å–®é¸é …çš„èƒŒæ™¯å’Œæ–‡å­—é¡è‰²å”èª¿ */
            .add-transaction select option {
                  background: var(--bg-secondary);
                  color: var(--text-light); 
            }
            
            .balance-setting input{
                  flex: 1;
            }
            .add-transaction input::placeholder{
                  color: var(--text-dark);
            }
            .action-btn{
                  background: linear-gradient(90deg, var(--neon-blue), #9be4ff); 
                  color: var(--bg-primary); 
                  cursor: pointer; 
                  transition: 0.3s;
                  font-weight: bold;
            }
            .action-btn:hover{
                  opacity: 0.9;
            }
            @media (max-width: 768px){
                  .metrics-bars-grid{
                        flex-direction: column;
                  }
                  .sidebar{
                        width: 100%;
                        border-right: none;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                  }
                  .app-container{
                        flex-direction: column;
                  }
                  .sidebar ul{
                        display: flex;
                        flex-wrap: wrap;
                        justify-content: center;
                  }
                  .sidebar li{
                        padding: 10px 15px;
                  }
                  .add-transaction input, 
                  .add-transaction select,
                  .add-transaction button {
                        flex-grow: 1; 
                        min-width: unset;
                  }
            }
      </style>
</head>
<body>
      <div class="app-container">
            <nav class="sidebar">
                  <h1>è¨˜å¸³ç³»çµ±</h1>
                  <ul>
                        <li class="active" data-page="dashboard">äº¤æ˜“ç´€éŒ„</li>
                        <li data-page="add">æ•¸æ“šéŒ„å…¥</li>
                        <li data-page="report">å ±å‘Šåˆ†æ</li>
                        <li data-page="settings">ç³»çµ±è¨­å®š</li>
                  </ul>
            </nav>
            <main>
                  <div class="page active" id="dashboard">
                        <h2 class="neon-title">æ™ºæ…§è¨˜å¸³ - ç®¡ç†å¹³å°</h2>
                        
                        <div class="metrics-bars-grid">
                              <div class="metric-bar income">
                                    <div class="bar-label">ç¸½æ”¶å…¥</div>
                                    <div class="bar-value" id="total-income-bar">$0</div>
                                    <div class="progress-line">
                                          <div class="progress-fill" id="income-fill"></div>
                                    </div>
                              </div>
                              <div class="metric-bar expense">
                                    <div class="bar-label">ç¸½æ”¯å‡º</div>
                                    <div class="bar-value" id="total-expense-bar">$0</div>
                                    <div class="progress-line">
                                          <div class="progress-fill" id="expense-fill"></div>
                                    </div>
                              </div>
                              <div class="metric-bar balance">
                                    <div class="bar-label">ç¸½é¤˜é¡</div>
                                    <div class="bar-value" id="balance-bar">$0</div>
                                    <div class="progress-line">
                                          <div class="progress-fill" id="balance-fill"></div>
                                    </div>
                              </div>
                                <div class="metric-bar budget-status">
                                    <div class="bar-label">é ç®—ç‹€æ…‹</div>
                                    <div class="bar-value" id="budget-status-bar">0%</div>
                                    <div class="progress-line">
                                          <div class="progress-fill" id="budget-fill"></div>
                                    </div>
                              </div>
                        </div>
                        <h2 class="neon-title" style="font-size: 35px; margin-top: 50px;">æœ€æ–°äº¤æ˜“æ—¥èªŒ</h2>
                        
                        <div id="transaction-cards">
                              </div>
                  </div>

                  <div class="page" id="add">
                        <h2 class="neon-title">æ–°å¢äº¤æ˜“ - æ•¸æ“šéŒ„å…¥</h2>

                        <div id="add-income-group" class="input-flow-group input-group" style="border: 1px solid var(--neon-blue); margin-bottom: 20px;">
                              <p style="color: var(--neon-blue); width: 100%; margin: 0 0 5px; font-weight: bold; font-size: 1.1em;">ğŸš€ æ”¶å…¥æ•¸æ“šæµéŒ„å…¥</p>
                              <div class="add-transaction">
                                    <input type="text" id="item_name_income" placeholder="æ”¶å…¥ä¾†æºåç¨±">
                                    <input type="number" id="amount_income" placeholder="é‡‘é¡ ( è«‹è¼¸å…¥æ­£æ•¸ )">
                                    <select id="category_income">
                                          </select>
                                    <button onclick="addTransaction('income')" class="action-btn" style="background: linear-gradient(90deg, var(--neon-blue), #9be4ff);">ç¢ºèªæ–°å¢æ”¶å…¥</button>
                              </div>
                        </div>

                        <div id="add-expense-group" class="input-flow-group input-group" style="border: 1px solid var(--neon-pink);">
                              <p style="color: var(--neon-pink); width: 100%; margin: 0 0 5px; font-weight: bold; font-size: 1.1em;">âš ï¸ æ”¯å‡ºæ•¸æ“šæµéŒ„å…¥</p>
                              <div class="add-transaction">
                                    <input type="text" id="item_name_expense" placeholder="æ”¯å‡ºé …ç›®åç¨±">
                                    <input type="number" id="amount_expense" placeholder="é‡‘é¡ ( è«‹è¼¸å…¥æ­£æ•¸ )">
                                    <select id="category_expense">
                                          </select>
                                    <button onclick="addTransaction('expense')" class="action-btn" style="background: linear-gradient(90deg, var(--neon-pink), #ff70a6);">ç¢ºèªæ–°å¢æ”¯å‡º</button>
                              </div>
                        </div>
                  </div>
                  
                  <div class="page" id="report">
                        <h2 class="neon-title">å ±å‘Šåˆ†æ - æ•¸æ“šæª¢è¦–</h2>
                        <div class="chart-controls">
                              <button id="show-category-expense-btn" class="active" onclick="renderChart('category', this, 'expense')">æ”¯å‡ºåˆ†é¡åˆ†ä½ˆ</button>
                              <button id="show-category-income-btn" onclick="renderChart('category', this, 'income')">æ”¶å…¥åˆ†é¡åˆ†ä½ˆ</button>
                              <button id="show-flow-btn" onclick="renderChart('flow', this)">ç¸½æµå‹•æ¯”è¼ƒ</button>
                              <button id="show-budget-btn" onclick="renderChart('budget', this)">é ç®—/æ”¯å‡ºæ¯”è¼ƒ</button>
                        </div>
                        <div class="chart-container">
                              <h3>åœ“é¤…åœ–åˆ†æ</h3>
                              <canvas id="flowChart" height="400"></canvas>
                        </div>
                  </div>
                  
                  <div class="page" id="settings">
                        <h2 class="neon-title">ç³»çµ±è¨­å®š - åƒæ•¸èª¿æ•´</h2>
                              <div class="input-group">
                                    <p style="color: var(--neon-blue); width: 100%; margin: 0 0 5px;">è¨­å®šåˆå§‹é¤˜é¡</p>
                                    <div class="balance-setting">
                                          <input type="number" id="initial_balance_input" placeholder="è«‹è¼¸å…¥èµ·å§‹é¤˜é¡ ( ä¾‹å¦‚ 10000 )">
                                          <button onclick="setInitialBalance()" class="action-btn">å„²å­˜é¤˜é¡</button>
                                    </div>
                                    <p style="color: var(--text-dark); font-size: 0.8em; margin: 0;">* ç•¶å‰åˆå§‹é¤˜é¡ï¼š$<span id="current-initial-balance">0</span></p>
                              </div>
                              
                              <div class="input-group" style="border: 1px solid var(--neon-pink);">
                                    <p style="color: var(--neon-pink); width: 100%; margin: 0 0 5px;">è¨­å®šæœˆåº¦æ”¯å‡ºé ç®—</p>
                                    <div class="balance-setting">
                                          <input type="number" id="monthly_budget_input" placeholder="è«‹è¼¸å…¥æœ¬æœˆé ç®— ( ä¾‹å¦‚ 30000 )">
                                          <button onclick="setBudget()" class="action-btn">å„²å­˜é ç®—</button>
                                    </div>
                                    <p style="color: var(--text-dark); font-size: 0.8em; margin: 0;">* ç•¶å‰æœˆåº¦é ç®—ï¼š$<span id="current-monthly-budget">0</span></p>
                              </div>
                  </div>
            </main>
      </div>
      <script>
            // å¾ LocalStorage è¼‰å…¥æ•¸æ“š
            let initialBalance = parseInt( localStorage.getItem( 'initialBalance' ) ) || 0;
            let monthlyBudget = parseInt( localStorage.getItem( 'monthlyBudget' ) ) || 0; 
            let transactions = JSON.parse( localStorage.getItem( 'transactions' ) ) || [];
            
            const ctx = document.getElementById( 'flowChart' ).getContext( '2d' );
            const currentInitialBalanceEl = document.getElementById( 'current-initial-balance' );
            const currentMonthlyBudgetEl = document.getElementById( 'current-monthly-budget' );
            const transactionCardsContainer = document.getElementById('transaction-cards'); 
            
            // å¼•ç”¨æ¢ç‹€é¡¯ç¤ºå…ƒç´ çš„ ID
            const totalIncomeBarEl = document.getElementById( 'total-income-bar' );
            const totalExpenseBarEl = document.getElementById( 'total-expense-bar' );
            const balanceBarEl = document.getElementById( 'balance-bar' );
            const budgetStatusBarEl = document.getElementById( 'budget-status-bar' );
            
            const incomeFillEl = document.getElementById( 'income-fill' );
            const expenseFillEl = document.getElementById( 'expense-fill' );
            const balanceFillEl = document.getElementById( 'balance-fill' );
            const budgetFillEl = document.getElementById( 'budget-fill' );

            // Chart.js å¯¦ä¾‹ï¼ˆä½¿ç”¨æ–°çš„æŸ”å’Œè‰²èª¿è¨­å®šï¼‰
            let flowChart = new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                        labels: ['ç›®å‰ç„¡æ”¯å‡ºè³‡æ–™'],
                        datasets: [
                              {
                                    data: [1],
                                    backgroundColor: ['rgba(167, 215, 255, 0.6)'], 
                                    borderColor: 'var(--neon-blue)',
                                    borderWidth: 2,
                                    hoverOffset: 8
                              }
                        ]
                  },
                  options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                              legend: {
                                    labels: {
                                          color: 'var(--text-light)' 
                                    }
                              },
                              tooltip: {
                                    backgroundColor: 'rgba(30, 30, 30, 0.9)', 
                                    titleColor: 'var(--neon-blue)', 
                                    bodyColor: 'var(--text-light)',
                                    borderColor: 'var(--neon-blue)',
                                    borderWidth: 1
                              }
                        }
                  }
            });
            
            // ***åˆ†é¡é¸é …åˆ—è¡¨ (æ ¹æ“šåˆ†æµéœ€æ±‚é‡æ–°æ•´ç†)***
            const expenseCategories = ['é¤é£²', 'å¨›æ¨‚', 'äº¤é€š', 'è³¼ç‰©', 'é†«ç™‚', 'å­¸ç¿’', 'ç”Ÿæ´»é›œé …', 'æˆ¿ç§Ÿ/è²¸æ¬¾', 'æ•™è‚²', 'å…¶ä»–'];
            const incomeCategories = ['è–ªè³‡', 'æŠ•è³‡', 'çé‡‘', 'ç¦®é‡‘', 'å…¼è·', 'å…¶ä»–'];

            // æŸ”å’Œé…è‰²æ–¹æ¡ˆ - æ”¶å…¥
            const incomeColors = {
                  'è–ªè³‡': '#92caff', 
                  'æŠ•è³‡': '#a2e7c9', 
                  'çé‡‘': '#c9aaff', 
                  'ç¦®é‡‘': '#7CFC00',
                  'å…¼è·': '#17A2B8',
                  'å…¶ä»–': '#ffe4a0', 
                  'æœªåˆ†é¡': '#d0d0d0',
                  'ç¸½æ”¶å…¥': 'var(--neon-blue)'
            };
            // æŸ”å’Œé…è‰²æ–¹æ¡ˆ - æ”¯å‡º
            const expenseColors = {
                  'é¤é£²': '#ffa3a3', 
                  'å¨›æ¨‚': '#ffc88a', 
                  'äº¤é€š': '#9ecaff', 
                  'è³¼ç‰©': '#a8ffb3', 
                  'é†«ç™‚': '#f4b3ff', 
                  'å­¸ç¿’': '#fff1a6', 
                  'ç”Ÿæ´»é›œé …': '#ADB5BD',
                  'æˆ¿ç§Ÿ/è²¸æ¬¾': '#CC66FF',
                  'æ•™è‚²': '#A0522D',
                  'å…¶ä»–': '#dcdcdc', 
                  'æœªåˆ†é¡': '#d0d0d0',
                  'ç¸½æ”¯å‡º': 'var(--neon-pink)'
            };
            // æŸ”å’Œé…è‰²æ–¹æ¡ˆ - é ç®—æµå‘
            const budgetFlowColors = {
                  'å¯¦éš›æ”¯å‡º': '#ffa3a3', 
                  'å‰©é¤˜é ç®—': '#a8f0c6' 
            };
            
            // =========================================================================
            // æ–°å¢ï¼šç²å–æ—¥æœŸåœ¨ YYYY/MM/DD æ ¼å¼çš„è¼”åŠ©å‡½æ•¸ (ç¢ºä¿æ—¥æœŸæ ¼å¼ä¸€è‡´æ€§)
            // =========================================================================
            function getFormattedDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            }

            // ç²å–ç•¶å‰æ—¥æœŸæ™‚é–“çš„æ ¼å¼åŒ–å­—ä¸²
            function getFormattedDateTime() {
                const now = new Date();
                
                const dateStr = getFormattedDate(now); 
                
                // æ˜ŸæœŸX (Weekday)
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekdayStr = `æ˜ŸæœŸ${weekdays[now.getDay()]}`;
                
                return `${dateStr} ${weekdayStr}`;
            }

            // é¡¯ç¤ºç•¶å‰æ—¥æœŸæ™‚é–“åˆ°æŒ‡å®šå…ƒç´ 
            function displayCurrentDateTime() {
                const dateEl = document.getElementById('current-date-display');
                if (dateEl) {
                    dateEl.textContent = getFormattedDateTime();
                }
            }

            // ***æ–°å¢: å¡«å……åˆ†é¡ä¸‹æ‹‰é¸å–®çš„å‡½æ•¸***
            function populateCategoryDropdowns() {
                  const incomeSelect = document.getElementById('category_income');
                  const expenseSelect = document.getElementById('category_expense');
                  
                  // æ”¶å…¥åˆ†é¡
                  const incomeCats = ['æœªåˆ†é¡', ...incomeCategories];
                  incomeSelect.innerHTML = incomeCats.map(cat => 
                        `<option value="${cat}">${cat}</option>`
                  ).join('');

                  // æ”¯å‡ºåˆ†é¡
                  const expenseCats = ['æœªåˆ†é¡', ...expenseCategories];
                  expenseSelect.innerHTML = expenseCats.map(cat => 
                        `<option value="${cat}">${cat}</option>`
                  ).join('');
            }

            // é ç®—è¨­å®šå‡½æ•¸
            function setBudget() {
                  const inputEl = document.getElementById('monthly_budget_input');
                  const newBudget = parseInt(inputEl.value);

                  if (isNaN(newBudget) || newBudget < 0) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„éè² æ•¸ä½œç‚ºæœˆåº¦é ç®—ï¼');
                        return;
                  }
                  
                  monthlyBudget = newBudget;
                  localStorage.setItem('monthlyBudget', monthlyBudget);
                  inputEl.value = '';

                  alert(`æœˆåº¦é ç®—å·²è¨­å®šç‚º $${monthlyBudget.toLocaleString()}ï¼`);
                  updateUI(); 
            }
            
            // è¨­å®šåˆå§‹é¤˜é¡
            function setInitialBalance(){
                  const inputEl = document.getElementById( 'initial_balance_input' );
                  const newBalance = parseInt( inputEl.value );
                  
                  if ( isNaN( newBalance ) ){
                        alert( 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ä½œç‚ºåˆå§‹é¤˜é¡ï¼' );
                        return;
                  }
                  
                  initialBalance = newBalance;
                  localStorage.setItem( 'initialBalance', initialBalance ); 
                  inputEl.value = ''; 
                  
                  alert( `åˆå§‹é¤˜é¡å·²è¨­å®šç‚º $${initialBalance.toLocaleString()}ï¼` );
                  updateUI();
            }
            
            // åœ“é¤…åœ–ç¹ªè£½æ ¸å¿ƒé‚è¼¯
            function renderChart( mode, activeBtn = null, type = 'expense' ) {
                  
                  if (activeBtn) {
                        document.querySelectorAll('.chart-controls button').forEach(btn => btn.classList.remove('active'));
                        activeBtn.classList.add('active');
                  }

                  let chartData = {};

                  const allTimeExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                  const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);


                  if (mode === 'category') {
                        // æ¨¡å¼ 1: æŒ‰åˆ†é¡åˆ†ä½ˆ
                        const filteredTransactions = transactions.filter(t => t.type === type);
                        const colorsMap = type === 'income' ? incomeColors : expenseColors;

                        if (filteredTransactions.length === 0) {
                              chartData = {
                                    labels: [`ç„¡${type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}äº¤æ˜“æ•¸æ“š`],
                                    data: [1],
                                    colors: ['var(--gray-default)']
                              };
                        } else {
                              // æ ¹æ“šåˆ†é¡é€²è¡Œåˆ†çµ„å’Œæ±‚å’Œ
                              const categorySums = filteredTransactions.reduce((acc, t) => {
                                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                                    return acc;
                              }, {});

                              chartData = {
                                    labels: Object.keys(categorySums),
                                    data: Object.values(categorySums),
                                    // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„é¡è‰²æ˜ å°„
                                    colors: Object.keys(categorySums).map(cat => colorsMap[cat] || colorsMap['æœªåˆ†é¡'])
                              };
                        }

                  } else if (mode === 'flow') {
                        // æ¨¡å¼ 2: ç¸½æ”¶å…¥/ç¸½æ”¯å‡ºæµå‹•æ¯”è¼ƒ
                          if (transactions.length === 0 || (totalIncome === 0 && allTimeExpense === 0)) {
                              chartData = {
                                    labels: ['ç„¡æµå‹•æ•¸æ“š'],
                                    data: [1],
                                    colors: ['var(--gray-default)']
                              };
                        } else {
                              chartData = {
                                    labels: ['ç¸½æ”¶å…¥', 'ç¸½æ”¯å‡º'],
                                    data: [totalIncome, allTimeExpense],
                                    colors: [incomeColors['ç¸½æ”¶å…¥'], expenseColors['ç¸½æ”¯å‡º']]
                              };
                        }

                  } else if (mode === 'budget') {
                        // æ¨¡å¼ 3: é ç®—/æ”¯å‡ºåˆ†ä½ˆ
                        if (monthlyBudget === 0 && allTimeExpense === 0) {
                              chartData = {
                                    labels: ['ç„¡é ç®—æˆ–æ”¯å‡ºæ•¸æ“š'],
                                    data: [1],
                                    colors: ['var(--gray-default)']
                              };
                        } else if (monthlyBudget === 0 && allTimeExpense > 0) {
                              // åªæœ‰æ”¯å‡ºï¼Œæ²’æœ‰é ç®—
                              chartData = {
                                    labels: ['å¯¦éš›æ”¯å‡º', 'æœªè¨­é ç®—'],
                                    data: [allTimeExpense, 0.01], 
                                    colors: [budgetFlowColors['å¯¦éš›æ”¯å‡º'], 'var(--gray-default)']
                              };
                        } else {
                              const remainingBudget = Math.max(0, monthlyBudget - allTimeExpense);
                              chartData = {
                                    labels: ['å¯¦éš›æ”¯å‡º', 'å‰©é¤˜é ç®—'],
                                    data: [allTimeExpense, remainingBudget],
                                    colors: [budgetFlowColors['å¯¦éš›æ”¯å‡º'], budgetFlowColors['å‰©é¤˜é ç®—']]
                              };
                        }
                  }
                  
                  // æ›´æ–° Chart.js åœ–è¡¨
                  flowChart.data.labels = chartData.labels;
                  flowChart.data.datasets[0].data = chartData.data;
                  flowChart.data.datasets[0].backgroundColor = chartData.colors;
                  
                  flowChart.update();
            }

            // æ›´æ–°ç•«é¢æ ¸å¿ƒå‡½æ•¸
            function updateUI(){
                  
                  displayCurrentDateTime();

                  let totalIncome=0,totalExpense=0;

                  // 1. ç¢ºä¿æ•¸æ“šè¼‰å…¥
                  if (localStorage.getItem('transactions')) {
                        transactions = JSON.parse(localStorage.getItem('transactions'));
                  }
                  
                  // 2. è¨ˆç®—ç¸½æ•¸
                  transactions.forEach( ( tx ) => {
                        if( tx.type === 'income' ) totalIncome += tx.amount;
                        else totalExpense += tx.amount;
                  } );
                  
                  // 3. è¨ˆç®—ç¸½é¤˜é¡ ( ç´å…¥åˆå§‹é¤˜é¡ )
                  const netFlow = totalIncome - totalExpense;
                  const currentBalance = initialBalance + netFlow;

                  // 4. æ›´æ–°æ¢ç‹€æ•¸æ“šé¡¯ç¤º
                  totalIncomeBarEl.textContent=`$${totalIncome.toLocaleString()}`;
                  totalExpenseBarEl.textContent=`$${totalExpense.toLocaleString()}`;
                  balanceBarEl.textContent=`$${currentBalance.toLocaleString()}`;
                  currentInitialBalanceEl.textContent=`${initialBalance.toLocaleString()}`;
                  currentMonthlyBudgetEl.textContent=`${monthlyBudget.toLocaleString()}`;

                  // 5. æ›´æ–°é€²åº¦æ¢ç™¾åˆ†æ¯”
                  const maxAllValue = Math.max( totalIncome, totalExpense, Math.abs( currentBalance ), monthlyBudget, 1 ); 
                  
                  incomeFillEl.style.width = `${( totalIncome / maxAllValue * 100 ).toFixed( 2 )}%`;
                  expenseFillEl.style.width = `${( totalExpense / maxAllValue * 100 ).toFixed( 2 )}%`;
                  
                  let balancePercentage = Math.abs( currentBalance / maxAllValue * 100 );
                  balanceFillEl.style.width = `${balancePercentage.toFixed( 2 )}%`;

                  // é¤˜é¡é¡è‰²è™•ç†
                  if (currentBalance >= 0) {
                      balanceBarEl.style.color = 'var(--neon-green)';
                      balanceFillEl.style.backgroundColor = 'var(--neon-green)';
                      balanceFillEl.style.boxShadow = '0 0 10px var(--neon-green)';
                  } else {
                      balanceBarEl.style.color = 'var(--neon-pink)';
                      balanceFillEl.style.backgroundColor = 'var(--neon-pink)';
                      balanceFillEl.style.boxShadow = '0 0 10px var(--neon-pink)';
                  }
                  
                  // é ç®—ç‹€æ…‹æ›´æ–°
                  const remainingBudget = monthlyBudget - totalExpense;
                  let budgetPercentage = 0;

                  if (monthlyBudget > 0) {
                        budgetPercentage = (totalExpense / monthlyBudget) * 100;
                  }

                  const displayBudgetPercentage = Math.min(100, budgetPercentage); 

                  if (remainingBudget < 0) {
                        const overAmount = Math.abs(remainingBudget).toLocaleString();
                        budgetStatusBarEl.textContent = `è¶…æ”¯ $${overAmount}`;
                        budgetFillEl.style.width = `100%`; 
                        budgetStatusBarEl.style.color = 'var(--neon-pink)'; 
                        budgetFillEl.style.backgroundColor = 'var(--neon-pink)'; 
                        budgetFillEl.style.boxShadow = '0 0 10px var(--neon-pink)';
                  } else if (monthlyBudget === 0) {
                        budgetStatusBarEl.textContent = totalExpense > 0 ? 'æœªè¨­é ç®—' : '$0';
                        budgetFillEl.style.width = '0%';
                        budgetStatusBarEl.style.color = 'var(--gray-default)';
                        budgetFillEl.style.backgroundColor = 'var(--gray-default)';
                        budgetFillEl.style.boxShadow = 'none';
                  } else {
                        budgetStatusBarEl.textContent = `$${remainingBudget.toLocaleString()}`;
                        budgetFillEl.style.width = `${displayBudgetPercentage}%`;
                        budgetStatusBarEl.style.color = 'var(--neon-yellow)';
                        budgetFillEl.style.backgroundColor = 'var(--neon-yellow)';
                        budgetFillEl.style.boxShadow = '0 0 10px var(--neon-yellow)';
                  }

                  // 6. æ¸²æŸ“äº¤æ˜“å¡ç‰‡ (æ–°åŠŸèƒ½)
                  transactionCardsContainer.innerHTML = '';
                  
                  // æŒ‰æ—¥æœŸåˆ†çµ„
                  const transactionsByDate = transactions.reduce((acc, tx) => {
                        const datePart = tx.time.split(' ')[0]; // åªå–æ—¥æœŸéƒ¨åˆ† (ç¾åœ¨æ ¼å¼å·²å›ºå®šï¼Œæ•…å¯é )
                        if (!acc[datePart]) {
                              acc[datePart] = [];
                        }
                        // å°‡åŸå§‹ç´¢å¼•é™„åŠ åˆ°äº¤æ˜“å°è±¡ï¼Œç”¨æ–¼åˆªé™¤
                        // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ findIndex ç¢ºä¿åœ¨æ’åºå‰ç²å–æ­£ç¢ºçš„åŸå§‹ç´¢å¼•
                        const originalIndex = transactions.findIndex(t => t.time === tx.time && t.amount === tx.amount && t.name === tx.name);
                        tx.originalIndex = originalIndex;
                        acc[datePart].push(tx);
                        return acc;
                  }, {});

                  // æŒ‰ç…§æ—¥æœŸå¾æ–°åˆ°èˆŠæ’åº
                  const sortedDates = Object.keys(transactionsByDate).sort((a, b) => new Date(b) - new Date(a));

                  sortedDates.forEach(date => {
                        const dateCard = document.createElement('div');
                        dateCard.className = 'transaction-date-card';
                        
                        const dateHeader = `<div class="date-header">${date}</div>`; // æ¨™é ­åªé¡¯ç¤ºæ—¥æœŸ
                        let transactionRows = '';
                        
                        // æ ¹æ“šäº¤æ˜“æ™‚é–“å€’åºï¼Œè®“æœ€æ–°çš„äº¤æ˜“åœ¨å¡ç‰‡é ‚éƒ¨
                        // ç”±æ–¼ time ç¾åœ¨æ˜¯ YYYY/MM/DD HH:MM:SS æ ¼å¼ï¼Œnew Date(b.time) ä¾ç„¶èƒ½å¤ æ­£ç¢ºæ’åº
                        transactionsByDate[date].sort((a, b) => new Date(b.time) - new Date(a.time)).forEach((tx) => {

                              const iconChar = tx.type === 'income' ? 'â†‘' : 'â†“';
                              const iconColor = tx.type === 'income' ? 'var(--neon-blue)' : 'var(--neon-pink)';
                              const iconBg = tx.type === 'income' ? 'rgba(167, 215, 255, 0.2)' : 'rgba(255, 179, 207, 0.2)';
                              const amountSign = tx.type === 'income' ? '+' : '-';
                              const amountClass = tx.type === 'income' ? 'income' : 'expense';
                              
                              transactionRows += `
                                    <div class="transaction-row">
                                          <div class="transaction-left">
                                                <div class="icon" style="color: ${iconColor}; background-color: ${iconBg};">${iconChar}</div>
                                                <div>
                                                      <div class="category">${tx.category || 'æœªåˆ†é¡'}</div>
                                                      <div class="name">${tx.name}</div>
                                                </div>
                                          </div>
                                          <div class="transaction-right ${amountClass}">
                                                <span>${amountSign}$${Math.abs(tx.amount).toLocaleString()}</span>
                                                <button class="delete-btn" onclick="deleteTransaction(${tx.originalIndex})">åˆªé™¤</button>
                                          </div>
                                    </div>
                              `;
                        });

                        dateCard.innerHTML = dateHeader + transactionRows;
                        transactionCardsContainer.appendChild(dateCard);
                  });

                  // 7. æ›´æ–° Chart.js åœ–è¡¨
                  const activeCategoryBtn = document.querySelector('#report .chart-controls button.active');
                  let activeMode = 'category';
                  let activeType = 'expense'; 

                  if (activeCategoryBtn) {
                          activeMode = activeCategoryBtn.id === 'show-budget-btn' ? 'budget' : 
                                             (activeCategoryBtn.id === 'show-flow-btn' ? 'flow' : 'category');
                        
                        if (activeMode === 'category') {
                              activeType = activeCategoryBtn.id === 'show-category-income-btn' ? 'income' : 'expense';
                        }
                  }
                    renderChart(activeMode, activeCategoryBtn, activeType);
            }

            // ***ä¿®æ”¹: æ–°å¢äº¤æ˜“å‡½æ•¸ï¼Œæ ¹æ“š type è®€å–å°æ‡‰æ¬„ä½***
            function addTransaction( type ){

                  const nameInputId = type === 'income' ? 'item_name_income' : 'item_name_expense';
                  const amountInputId = type === 'income' ? 'amount_income' : 'amount_expense';
                  const categoryInputId = type === 'income' ? 'category_income' : 'category_expense';

                  const name = document.getElementById( nameInputId ).value.trim();
                  const amountStr = document.getElementById( amountInputId ).value;
                  const category = document.getElementById( categoryInputId ).value;
                  const amount = parseInt( amountStr );
                  
                  if( !name || !amountStr || isNaN( amount ) || amount <= 0 ){ 
                        alert( 'è«‹è¼¸å…¥æœ‰æ•ˆçš„äº¤æ˜“åç¨±å’Œæ­£æ•¸é‡‘é¡ï¼' ); 
                        return;
                  }
                  
                  const now = new Date();
                  const datePart = getFormattedDate(now); // YYYY/MM/DD
                  // ä½¿ç”¨ toLocaleTimeString ç¢ºä¿æ™‚é–“æ ¼å¼ (HH:MM:SS)ï¼Œä¸¦èˆ‡æ—¥æœŸç”¨ç©ºæ ¼åˆ†éš”
                  const timePart = now.toLocaleTimeString('zh-TW', { hour12: false }); 

                  // äº¤æ˜“æ™‚é–“ä»¥ YYYY/MM/DD HH:MM:SS æ ¼å¼å„²å­˜ï¼Œä¾¿æ–¼æ’åºå’Œåˆ†å‰²æ—¥æœŸ
                  transactions.push( { 
                        name, 
                        amount, 
                        type, 
                        category, 
                        time: `${datePart} ${timePart}` 
                  } ); 
                  localStorage.setItem('transactions', JSON.stringify(transactions)); 

                  // æ¸…ç©ºæ¬„ä½
                  document.getElementById( nameInputId ).value = '';
                  document.getElementById( amountInputId ).value = '';
                  document.getElementById( categoryInputId ).value = 'æœªåˆ†é¡'; // é è¨­å›æœªåˆ†é¡
                  
                  updateUI();
            }

            // åˆªé™¤äº¤æ˜“
            function deleteTransaction( idx ){
                  if( confirm( 'ç¢ºèªåˆªé™¤é€™ç­†äº¤æ˜“ç´€éŒ„å—ï¼Ÿ' ) ){
                        transactions.splice( idx,1 );
                        localStorage.setItem('transactions', JSON.stringify(transactions)); 
                        updateUI();
                  }
            }

            // å°è¦½åˆ—åˆ‡æ› (äº‹ä»¶ç›£è½å™¨)
            document.querySelectorAll( '.sidebar li' ).forEach( li => {
                  li.addEventListener( 'click',() => {
                        const pageId = li.getAttribute( 'data-page' );
                        showPage( pageId );
                        setActiveNav( pageId );
                        // ç‰¹æ®Šè™•ç†ï¼šåˆ‡æ›åˆ°å ±å‘Šé æ™‚ï¼Œå¼·åˆ¶é‡æ–°ç¹ªè£½åœ–è¡¨
                        if (pageId === 'report') {
                              const defaultBtn = document.getElementById('show-category-expense-btn');
                              renderChart('category', defaultBtn, 'expense');
                        }
                  } );
            } );

            // é¡¯ç¤ºæŒ‡å®šé é¢
            function showPage( pageId ){
                  document.querySelectorAll( '.page' ).forEach( p => {
                        p.classList.remove( 'active' );
                  } );

                  const page=document.getElementById( pageId );

                  if( page ){
                        page.classList.add( 'active' );
                  }
            }

            // è¨­å®šå°è¦½åˆ— Active ç‹€æ…‹
            function setActiveNav( pageId ){
                  document.querySelectorAll( '.sidebar li' ).forEach( li => {
                        li.classList.remove( 'active' );

                        if( li.getAttribute( 'data-page' ) === pageId ){
                              li.classList.add( 'active' )
                        };
                  } );
            }

            // åˆå§‹åŠ è¼‰æ™‚ï¼Œç¢ºä¿å ±å‘Šé çš„æŒ‰éˆ•é è¨­ç‚º Activeï¼Œä¸¦å¡«å……åˆ†é¡é¸é …
            window.onload = () => {
                  populateCategoryDropdowns(); 
                  updateUI(); 
                  document.getElementById('show-category-expense-btn').classList.add('active');
            };
      </script>
</body>
</html>