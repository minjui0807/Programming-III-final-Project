<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš™ï¸ ç³»çµ±è¨­å®š</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --------------------------- å…¨åŸŸè¨­å®š --------------------------- */
        :root{
            --bg-dark: #0f1115;
            --bg-secondary: #1e1e1e;
            --neon-blue: #a7d7ff;
            --neon-pink: #ffb3cf;
            --neon-green: #a8f0c6;
            --neon-yellow: #fff1a6;
            --neon-red: #ff7f7f;
            --text-light: #e6e6e6;
            --text-dark: #b8b8b8;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-dark);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-light);
            overflow-x: hidden;
            box-sizing: border-box;
            font-size: 18px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        h2 {
            color: var(--text-light);
            border-bottom: 2px solid var(--bg-secondary);
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        h2 i { color: var(--neon-blue); }

        /* --------------------------- è¨­å®šå€å¡Š --------------------------- */
        .settings-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-desc {
            color: var(--text-dark);
            font-size: 1rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* --------------------------- æŒ‰éˆ•ç¾¤çµ„ --------------------------- */
        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            color: #000;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: scale(0.98); }

        .btn-primary { background: var(--neon-blue); box-shadow: 0 0 15px rgba(167, 215, 255, 0.3); }
        .btn-excel { background: #21a366; color: white; box-shadow: 0 0 15px rgba(33, 163, 102, 0.4); } 
        .btn-success { background: var(--neon-green); box-shadow: 0 0 15px rgba(168, 240, 198, 0.3); }
        .btn-danger { background: rgba(255, 127, 127, 0.2); color: var(--neon-red); border: 1px solid var(--neon-red); }
        .btn-danger:hover { background: rgba(255, 127, 127, 0.3); color: #fff; }

        #fileInput { display: none; }

        .about-info {
            text-align: center;
            color: var(--text-dark);
            font-size: 0.9rem;
            margin-top: 50px;
            opacity: 0.6;
        }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--neon-green); color: #000;
            padding: 10px 20px; border-radius: 20px;
            font-weight: bold; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; z-index: 1000;
            box-shadow: 0 0 15px rgba(125, 242, 168, 0.4);
        }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fas fa-cog"></i> ç³»çµ±è¨­å®š</h2>

    <div class="settings-section">
        <div class="section-title"><i class="fas fa-database" style="color: var(--neon-yellow);"></i> è³‡æ–™å‚™ä»½èˆ‡åŒ¯å‡º</div>
        <p class="section-desc">
            æ”¯æ´ JSON å®Œæ•´å‚™ä»½ï¼Œæˆ–ä½¿ç”¨ Excel é€²è¡Œè³‡æ–™äº¤æ›ã€‚<br>
            <span style="font-size:0.9rem; color: var(--neon-blue);">ğŸ’¡ åŒ¯å…¥ Excel æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å»ºç«‹ç¼ºå°‘çš„åˆ†é¡å–”ï¼</span>
        </p>
        <div class="btn-group">
            <button class="btn btn-excel" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> åŒ¯å‡º Excel
            </button>

            <button class="btn btn-primary" onclick="exportData()">
                <i class="fas fa-file-export"></i> åŒ¯å‡ºå‚™ä»½ (JSON)
            </button>
            
            <button class="btn btn-success" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-import"></i> åŒ¯å…¥é‚„åŸ
            </button>
            
            <input type="file" id="fileInput" accept=".json, .xlsx, .xls" onchange="handleFileSelect(this)">
        </div>
    </div>

    <div class="settings-section" style="border-color: rgba(255, 127, 127, 0.3);">
        <div class="section-title"><i class="fas fa-exclamation-triangle" style="color: var(--neon-red);"></i> å±éšªå€åŸŸ</div>
        <p class="section-desc">
            é€™è£¡çš„æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹å°å¿ƒä½¿ç”¨ã€‚
        </p>
        <div class="btn-group">
            <button class="btn btn-danger" onclick="clearAllData()">
                <i class="fas fa-trash-alt"></i> æ¸…é™¤æ‰€æœ‰è³‡æ–™
            </button>
        </div>
    </div>

</div>

<div id="toast" class="toast">æ“ä½œæˆåŠŸï¼</div>

<script>
    // ------------------- 1. æª”æ¡ˆé¸æ“‡è™•ç† (åˆ†æµ) -------------------
    function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.json')) {
            importJSON(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            importExcel(file);
        } else {
            alert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼è«‹ä½¿ç”¨ .json æˆ– .xlsx');
        }
        input.value = ''; // æ¸…ç©ºä»¥åˆ©é‡è¤‡é¸å–
    }

    // ------------------- 2. åŒ¯å…¥ Excel é‚è¼¯ (æ ¸å¿ƒ) -------------------
    function importExcel(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æˆ JSON é™£åˆ—
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    throw new Error("Excel è£¡é¢æ²’æœ‰è³‡æ–™ï¼");
                }

                if (!confirm(`åµæ¸¬åˆ° ${jsonData.length} ç­†è³‡æ–™ã€‚\nç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ\n(é€™å°‡æœƒè¦†è“‹ç›®å‰çš„äº¤æ˜“ç´€éŒ„ï¼Œä½†ä¿ç•™ä¸¦åˆä½µåˆ†é¡)`)) {
                    return;
                }

                // æº–å‚™è½‰æ›è³‡æ–™
                const newTransactions = [];
                const newCategories = JSON.parse(localStorage.getItem('app_categories')) || { expense: {}, income: {} };
                
                // ç¢ºä¿çµæ§‹å­˜åœ¨
                if(Array.isArray(newCategories.expense)) { // èˆŠç‰ˆä¿®å¾©
                    const tmp = {}; newCategories.expense.forEach(c=>tmp[c]=[]); newCategories.expense=tmp;
                }

                // é è¨­åœ–æ¨™å°ç…§ (ç”¨æ–¼æ–°åˆ†é¡)
                const ICON_MAP = {
                    'é¤é£²': 'fas fa-utensils', 'äº¤é€š': 'fas fa-bus', 'è³¼ç‰©': 'fas fa-shopping-bag',
                    'å¨›æ¨‚': 'fas fa-gamepad', 'ä½æˆ¿': 'fas fa-home', 'å…¶ä»–': 'fas fa-box',
                    'è–ªæ°´': 'fas fa-money-bill-wave', 'çé‡‘': 'fas fa-star', 'æŠ•è³‡': 'fas fa-chart-line'
                };

                // éæ­· Excel è³‡æ–™ä¸¦è½‰æ›æ ¼å¼
                jsonData.forEach(row => {
                    // æ¬„ä½å°æ‡‰ (å®¹éŒ¯è™•ç†ï¼Œæ€• Excel æ¬„ä½åç¨±ä¸åŒ)
                    const date = row['æ—¥æœŸ'] || row['Date'];
                    const typeRaw = row['é¡å‹'] || row['Type'];
                    const mainCat = row['ä¸»åˆ†é¡'] || row['Category'];
                    const subCat = row['å­åˆ†é¡'] || row['SubCategory'];
                    const amount = row['é‡‘é¡'] || row['Amount'];
                    const desc = row['å‚™è¨»'] || row['Description'] || '';

                    if (!date || !amount) return; // è·³éç„¡æ•ˆè³‡æ–™

                    // é¡å‹è½‰æ› (ä¸­æ–‡ -> è‹±æ–‡)
                    let type = 'expense';
                    if (typeRaw && (typeRaw.includes('æ”¶') || typeRaw.toLowerCase() === 'income')) {
                        type = 'income';
                    }

                    // åˆ†é¡çµ„åˆ
                    let fullCategory = mainCat;
                    if (subCat) fullCategory += ` / ${subCat}`;

                    // â­ï¸ è‡ªå‹•è£œé½Šåˆ†é¡ (å¦‚æœç³»çµ±æ²’æœ‰é€™å€‹åˆ†é¡ï¼Œå°±åŠ é€²å»)
                    if (mainCat) {
                        if (type === 'expense') {
                            if (!newCategories.expense[mainCat]) newCategories.expense[mainCat] = [];
                        } else {
                            if (!newCategories.income[mainCat]) newCategories.income[mainCat] = [];
                        }
                    }

                    // æ±ºå®šåœ–æ¨™
                    const icon = ICON_MAP[mainCat] || (type === 'expense' ? 'fas fa-tag' : 'fas fa-coins');

                    newTransactions.push({
                        id: Date.now() + Math.random(), // ç”¢ç”Ÿå”¯ä¸€ ID
                        date: date,
                        type: type,
                        category: fullCategory || 'æœªåˆ†é¡',
                        categoryText: fullCategory || 'æœªåˆ†é¡',
                        amount: parseFloat(amount),
                        description: desc,
                        icon: icon
                    });
                });

                // å­˜æª”
                localStorage.setItem('transactions', JSON.stringify(newTransactions));
                localStorage.setItem('app_categories', JSON.stringify(newCategories));

                showToast(`âœ… æˆåŠŸåŒ¯å…¥ ${newTransactions.length} ç­†äº¤æ˜“ï¼`);
                
                setTimeout(() => { window.parent.location.reload(); }, 1500);

            } catch (err) {
                alert("âŒ Excel åŒ¯å…¥å¤±æ•—ï¼š\n" + err.message);
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // ------------------- 3. åŒ¯å…¥ JSON é‚è¼¯ (åŸç‰ˆ) -------------------
    function importJSON(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.transactions || !data.app_categories) throw new Error("æ ¼å¼éŒ¯èª¤");

                if (confirm(`ç¢ºå®šè¦é‚„åŸå‚™ä»½æª”å—ï¼Ÿ\näº¤æ˜“ç´€éŒ„å°‡è¢«è¦†è“‹ï¼`)) {
                    localStorage.setItem('transactions', JSON.stringify(data.transactions));
                    localStorage.setItem('app_categories', JSON.stringify(data.app_categories));
                    if (data.budget_settings) {
                        localStorage.setItem('budget_settings', JSON.stringify(data.budget_settings));
                    }
                    showToast("âœ… JSON é‚„åŸæˆåŠŸï¼");
                    setTimeout(() => { window.parent.location.reload(); }, 1500);
                }
            } catch (err) {
                alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼");
            }
        };
        reader.readAsText(file);
    }

    // ------------------- 4. åŒ¯å‡º Excel -------------------
    function exportToExcel() {
        const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        if (transactions.length === 0) {
            alert('ç›®å‰æ²’æœ‰äº¤æ˜“è³‡æ–™å¯ä»¥åŒ¯å‡ºå–”ï¼');
            return;
        }

        const excelData = transactions.map(t => {
            let mainCat = t.category || t.categoryText || 'æœªåˆ†é¡';
            let subCat = '';
            if (mainCat.includes(' / ')) {
                const parts = mainCat.split(' / ');
                mainCat = parts[0];
                subCat = parts[1];
            }
            return {
                'æ—¥æœŸ': t.date,
                'é¡å‹': t.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥',
                'ä¸»åˆ†é¡': mainCat,
                'å­åˆ†é¡': subCat,
                'é‡‘é¡': parseFloat(t.amount),
                'å‚™è¨»': t.description || ''
            };
        });

        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "äº¤æ˜“ç´€éŒ„");
        
        const dateStr = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `è¨˜å¸³æ˜ç´°_${dateStr}.xlsx`);
        showToast("âœ… Excel ä¸‹è¼‰æˆåŠŸï¼");
    }

    // ------------------- 5. åŒ¯å‡º JSON -------------------
    function exportData() {
        const data = {
            transactions: JSON.parse(localStorage.getItem('transactions')) || [],
            app_categories: JSON.parse(localStorage.getItem('app_categories')) || {},
            budget_settings: JSON.parse(localStorage.getItem('budget_settings')) || {},
            exportDate: new Date().toLocaleString()
        };
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const dateStr = new Date().toISOString().slice(0,10);
        a.download = `é‡å­è¨˜å¸³å‚™ä»½_${dateStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("âœ… å‚™ä»½æª”åŒ¯å‡ºæˆåŠŸï¼");
    }

    function clearAllData() {
        if (confirm("âš ï¸ è­¦å‘Šï¼é€™å°‡æœƒåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
            localStorage.clear();
            showToast("ğŸ—‘ï¸ è³‡æ–™å·²æ¸…é™¤ï¼");
            setTimeout(() => { window.parent.location.reload(); }, 1500);
        }
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.opacity = '1';
        setTimeout(() => { toast.style.opacity = '0'; }, 2000);
    }
</script>

</body>
</html>