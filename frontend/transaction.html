<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ æ•¸æ“šæ ¸å¿ƒï¼šé‡å­è¨˜å¸³ç³»çµ±</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        
        /* --------------------------- å…¨åŸŸè®Šæ•¸ --------------------------- */
        :root{
            --bg-dark: #0f1115;             /* ä¸»è¦èƒŒæ™¯è‰² (æœ€æ·±) */
            --bg-secondary: #1e1e1e;        /* æ¬¡è¦èƒŒæ™¯è‰² (ç”¨æ–¼å°è¦½åˆ—/å¡ç‰‡) */
            --neon-blue: #a7d7ff;           /* éœ“è™¹è— (æ”¶å…¥/ä¸»è‰²) */
            --neon-pink: #ffb3cf;           /* éœ“è™¹ç²‰ (æ”¯å‡º/å‰¯è‰²) */
            --neon-green: #a8f0c6;          /* éœ“è™¹ç¶  (é¤˜é¡) */
            --neon-yellow: #fff1a6;         /* éœ“è™¹é»ƒ (å¼·èª¿/é¡åˆ¥) */
            --text-light: #e6e6e6;          /* æ–‡å­—æ·ºè‰² */
            --text-dark: #b8b8b8;           /* æ–‡å­—æ·±è‰² */
            --gray-default: #d8d8d8;        /* é è¨­ç°è‰² */
            --sidebar-width: 250px;           /* å´é‚Šæ¬„å¯¬åº¦ */
            --sidebar-collapsed-width: 72px;  /* å´é‚Šæ¬„æ”¶åˆå¾Œå¯¬åº¦ */

            --cat-1: #ff7f7f;
            --cat-2: #ffcc66;
            --cat-3: #a8f0c6;
            --cat-4: #a7d7ff;
            --cat-5: #ffb3cf;
            --cat-6: #cf9cff;
            --cat-7: #66ffcc;
            --cat-8: #ff9c66;
            --cat-9: #99ccff;
            --cat-10: #d4d4d4;
            --cat-11: #ffd1dc;
            --cat-12: #ffe066;
            --cat-13: #8affc1;
            --cat-14: #8ed1ff;
            --cat-15: #c9a7ff;
            --cat-16: #ffb380;
            --cat-17: #b3ffb3;
            --cat-18: #b3d9ff;
            --cat-19: #ffe6b3;
            --cat-20: #ffadad;

            --deep-blue: #0f2640;     
            --mouse-x: 50%;                   /* é è¨­æ»‘é¼  X ä½ç½® */
            --mouse-y: 50%;                   /* é è¨­æ»‘é¼  Y ä½ç½® */

            --neon-blue-rgb: 167, 215, 255; 
            --neon-pink-rgb: 255, 179, 207;
        }

        /* --------------------------- åŸºç¤ç‰ˆé¢ --------------------------- */
        body{
            margin:0;
            padding:0;
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Noto Sans TC', 'Poppins', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            display:flex;
            min-height: 100vh;
        }

        /* 1. é‡å°æ‰€æœ‰å…ƒç´ ï¼ˆåŒ…å« body å’Œæ‰€æœ‰ divï¼‰éš±è—æ»¾å‹•æ¢ï¼Œä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ */
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
        }

        *::-webkit-scrollbar {
            display: none;             /* Chrome, Safari, Opera */
            width: 0 !important;
            height: 0 !important;
        }

        /* 2. ç¢ºä¿ html å’Œ body ä¹Ÿå®Œå…¨éš±è— */
        html, body {
            overflow: -moz-scrollbars-none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        body.modal-open {
            overflow: hidden;
            height: 100vh;
        }

        /* --------------------------- ä¸»å…§å®¹å€ --------------------------- */
        .main-content{
            flex-grow:1;
            padding:30px;
        }

        .page{
            display:none;
        }

        .page.active{
            display:block;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-primary);
            border-radius: 10px;
        }

        h1 {
            color: var(--neon-blue);
            text-align: center;
            margin-bottom: 30px;
            /* text-shadow: 0 0 5px rgba(167, 215, 255, 0.5); */
            text-shadow: 0 0 20px #8fd3ff;
        }

        /* --------------------------- å„€è¡¨æ¿ (Dashboard) æ¨£å¼ --------------------------- */
        .dashboard-container {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 25px; /* èˆ‡ä¸‹æ–¹åˆ—è¡¨çš„è·é›¢ */
            padding: 0 5px;
        }

        .summary-card {
            flex: 1;
            background: var(--bg-secondary); /* ä½¿ç”¨ä¸€è‡´çš„å¡ç‰‡èƒŒæ™¯ */
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 0; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        /* é¡è‰²è®Šæ•¸æ‡‰ç”¨ */
        .val-income { color: var(--neon-blue); text-shadow: 0 0 10px rgba(167, 215, 255, 0.3); }
        .val-expense { color: var(--neon-pink); text-shadow: 0 0 10px rgba(255, 179, 207, 0.3); }
        .val-balance { color: var(--neon-green); text-shadow: 0 0 10px rgba(168, 240, 198, 0.3); }

        /* é€²åº¦æ¢å®¹å™¨ */
        .progress-bg {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        /* é€²åº¦æ¢æœ¬é«” */
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            width: 0%; /* é è¨­ 0ï¼Œç”± JS æ§åˆ¶ */
            transition: width 0.5s ease-out;
        }

        .fill-income { background: var(--neon-blue); }
        .fill-expense { background: var(--neon-pink); }
        .fill-balance { background: var(--neon-green); }

        /* æ‰‹æ©Ÿç‰ˆé©é…ï¼šè®Šæˆç›´æ’æˆ–å…©æ’ */
        @media (max-width: 600px) {
            .dashboard-container {
                flex-direction: column;
            }
            .summary-card {
                margin-bottom: 10px;
            }
        }

        /* --------------------------- äº¤æ˜“å¡ç‰‡æ¨£å¼ --------------------------- */
        .transaction-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid transparent;
            display: flex;
            align-items: center;
        }
        
        .transaction-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .expense-border { border-left-color: var(--neon-pink); }
        .income-border { border-left-color: var(--neon-blue); }

        .card-content {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .icon-section {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #2a2a2a;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            margin-right: 15px;
            color: var(--text-light);
        }

        /* â­ï¸ æ–°å¢ï¼šåœ–ç‰‡çš„æ¨£å¼ */
        .icon-section .category-image {
            /* ç¢ºä¿åœ–ç‰‡å¡«æ»¿ icon-section å®¹å™¨ */
            width: 100%;       
            height: 100%;      
            
            /* è®“åœ–ç‰‡é¡¯ç¤ºç‚ºåœ“å½¢ (å¦‚æœé€™æ˜¯æ‚¨çš„è¨­è¨ˆç›®æ¨™) */
            border-radius: 50%; 
            
            /* ç¢ºä¿åœ–ç‰‡ä¸è®Šå½¢ä¸”å¡«æ»¿ï¼Œå¤šé¤˜éƒ¨åˆ†æœƒè¢«è£åˆ‡ */
            object-fit: cover; 
        }

        .info-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-grow: 1;
        }

        .category-and-desc {
            display: flex;
            flex-direction: column;
            text-align: left;
            flex-grow: 1;
        }

        .category-tag {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 3px;
            opacity: 0.8;
        }

        .description {
            font-size: 0.9em;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }

        .amount-section {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            min-width: 100px;
        }
        
        .expense-color { font-size: 1.2em; font-weight: bold; color: var(--neon-pink); }
        .income-color { font-size: 1.2em; font-weight: bold; color: var(--neon-blue); }

        /* --------------------------- æ—¥æœŸç¾¤çµ„/æ”¶åˆæ¨£å¼ --------------------------- */

        .date-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-top: 20px;
            margin-bottom: 10px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-left: 5px solid var(--neon-yellow);
            user-select: none;
        }
        .date-group-header:hover {
            background-color: #2a2a2a;
        }
        .date-group-header .date-text {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--neon-yellow);
        }
        .date-group-header .date-summary {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1em;
            color: var(--text-light);
        }
        .date-group-header .toggle-icon {
            transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
            margin-left: 5px;
        }
        .date-group-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .daily-transactions {
            display: grid;
            gap: 15px;
            overflow: hidden;

            /* â­ï¸æ ¸å¿ƒï¼šé«˜åº¦éæ¸¡æ›´æŸ”é † */
            transition: 
                max-height 0.45s cubic-bezier(0.25, 0.1, 0.25, 1),
                opacity 0.35s ease;

            max-height: 2000px;
            opacity: 1;
        }

        .daily-transactions.collapsed {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
        }

        /* --------------------------- ç„¡è³‡æ–™ç‹€æ…‹æ¨£å¼ (Empty State) - æœ€çµ‚åˆä½µç‰ˆ --------------------------- */
        .no-transactions-message {
            /* ==== æ ¸å¿ƒï¼šå¯¦ç¾å‚ç›´å †ç–Šèˆ‡ç½®ä¸­ (ä¾†è‡ªæ‚¨çš„ä¿®æ”¹) ==== */
            display: flex;
            flex-direction: column; /* å°‡å­å…ƒç´ å‚ç›´æ’åˆ— */
            align-items: center; /* è®“å­å…ƒç´ åœ¨å®¹å™¨ä¸­æ°´å¹³ç½®ä¸­ */
            justify-content: center; /* è®“å­å…ƒç´ åœ¨å®¹å™¨ä¸­å‚ç›´ç½®ä¸­ (å¦‚æœç©ºé–“è¶³å¤ ) */
            min-height: 250px; /* ç¢ºä¿å®¹å™¨æœ‰è¶³å¤ çš„ç©ºé–“ä¾†å±•ç¤ºç½®ä¸­æ•ˆæœ */
            box-sizing: border-box; 

            /* ==== åŸå§‹æ¨£å¼èˆ‡ç©ºé–“èª¿æ•´ ==== */
            padding: 60px 20px; 
            border: 1px dashed var(--text-dark);
            border-radius: 8px;
            color: var(--text-dark);
            width: 100%;
            margin: 20px 0 30px 0;
        }

        /* åœ–ç¤º */
        .no-transactions-message .fa-ghost,
        .no-transactions-message .fas.fa-ghost {
            font-size: 4em; /* æ¡ç”¨è¼ƒå¤§çš„å­—é«” (4em) */
            color: var(--neon-yellow); /* æ²¿ç”¨åŸå§‹æ¨£å¼ä¸­çš„éœ“è™¹ç²‰è‰² */
            margin-bottom: 20px;
        }

        /* æ–‡å­— */
        .no-transactions-message p {
            font-size: 1.2em;
            text-align: center; /* ç¢ºä¿æ–‡å­—æœ¬èº«å…§å®¹ç½®ä¸­ */
            color: var(--text-dark, #b8b8b8); 
            margin-top: 0; /* ç¢ºä¿æ²’æœ‰ä¸Šé‚Šè·å¹²æ“¾ */
            margin-bottom: 30px;
            max-width: 300px; /* é™åˆ¶æ–‡å­—å¯¬åº¦ï¼Œè®“æ–‡å­—ä¸æœƒå¤ªé•· */
        }

        /* æŒ‰éˆ• */
        .no-transactions-message .add-button {
            /* ç¢ºä¿æŒ‰éˆ•èˆ‡ä¸Šæ–¹çš„æ–‡å­—åªæœ‰ p çš„ margin-bottom éš”é–‹ï¼Œä¸éœ€è¦é¡å¤–çš„ margin-top */
            margin-top: 0;
        }

        /* ------------------------------------- */
        /* æŒ‰éˆ•æ ¸å¿ƒæ¨£å¼ï¼šç½®ä¸­ã€å°é½Šã€ç´”è— Hotspot */
        /* ------------------------------------- */
        .add-button {
            /* ç½®ä¸­èˆ‡å°é½Š */
            display: flex; 
            align-items: center;
            justify-content: center;
            gap: 8px; 

            color: var(--text-light); 
            padding: 12px 32px;
            border: 2px solid rgba(167, 215, 255, 0.3); 
            border-radius: 12px; 
            font-size: 1.15em; 
            font-weight: bold;
            cursor: pointer;
            overflow: hidden; 
            position: relative; 
            z-index: 10; 

            /* éœæ…‹èƒŒæ™¯ï¼šæ·±è‰² */
            background-color: var(--bg-secondary); 
            
            /* â­ï¸ ä¿®æ­£ 1ï¼šè®“æ¼¸å±¤ä¸­å¿ƒé»ç”± CSS è®Šæ•¸æ§åˆ¶ */
            background-image: radial-gradient(circle at var(--mouse-x) var(--mouse-y), var(--neon-blue) 0%, var(--deep-blue) 60%, var(--bg-secondary) 100%);
            
            /* é è¨­èƒŒæ™¯å¤§å° (å¾ˆå¤§)ï¼Œè®“äº®é»åœ¨æŒ‰éˆ•å¤–éƒ¨çœ‹ä¸è¦‹ */
            background-size: 500% 500%; 
            /* ç§»é™¤ background-position: center; å› ç‚ºä¸­å¿ƒé»å·²ç¶“è¢« var() æ§åˆ¶ */

            /* â­ï¸ ä¿®æ­£ 2ï¼šéœæ…‹æ™‚åªéæ¸¡ transform, box-shadow, border-color */
            transition: transform 0.2s, box-shadow 0.3s, border-color 0.3s; 
            box-shadow: 0 0 5px rgba(167, 215, 255, 0.2); 
        }

        /* åœ–ç¤ºå°é½Šçš„çµ‚æ¥µä¿®æ­£ */
        .add-button i {
            transform: translateY(-1px); 
        }

        /* æ»‘é¼ æ‡¸åœæ™‚ (Hover) */
        .add-button:hover {
            border-color: var(--neon-blue); 
            box-shadow: 0 0 25px rgba(167, 215, 255, 0.9), 0 0 8px var(--neon-blue); 
            transform: scale(1.03); 
            
            /* â­ï¸ ä¿®æ­£ 3ï¼šæ‡¸åœæ™‚ï¼Œè®“å…‰é»å¾å¤§è®Šå°ï¼Œä¸”è®Šå‹•éœ€è¦å¹³æ»‘éæ¸¡ */
            transition: transform 0.2s, box-shadow 0.3s, border-color 0.3s, background-size 0.5s; 
            background-size: 150% 150%; /* è®“ Hotspot è®Šå¾—å¯è¦‹ */
        }

        /* æ»‘é¼ é»æ“Šæ™‚ (Active) */
        .add-button:active {
            transform: scale(0.95); 
            box-shadow: 0 0 5px rgba(167, 215, 255, 0.2); 
            transition: transform 0.1s, box-shadow 0.1s; 
        }

        /* [CSS] åˆ†é¡æ–‡å­—é¡è‰²ï¼šæ ¹æ“šæ”¶æ”¯è®Šè‰² */
        .cat-income {
            color: var(--neon-blue) !important;
            text-shadow: 0 0 5px rgba(167, 215, 255, 0.5); /* æ·¡æ·¡çš„è—è‰²å…‰æšˆ */
            font-weight: bold;
        }

        .cat-expense {
            color: var(--neon-pink) !important;
            text-shadow: 0 0 5px rgba(255, 179, 207, 0.5); /* æ·¡æ·¡çš„ç²‰è‰²å…‰æšˆ */
            font-weight: bold;
        }

        /* --------------------------- Modal æ¨£å¼ --------------------------- */
        .modal {
            display: none; /* â­ï¸ é—œéµ 1ï¼šé è¨­ä¸€å®šè¦éš±è—ï¼ */
            position: fixed; /* â­ï¸ é—œéµ 2ï¼šå›ºå®šåœ¨è¢å¹•ä¸Šï¼Œä¸éš¨å…§å®¹æµå‹• */
            z-index: 1000; /* ç¢ºä¿å®ƒåœ¨æœ€ä¸Šå±¤ï¼Œè“‹ä½å…¶ä»–å…§å®¹ */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%; /* ä½”æ»¿æ•´å€‹è¢å¹• */
            background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            
            /* è®“å…§å®¹å±…ä¸­é¡¯ç¤º */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto; 
            padding: 30px;
            border: 1px solid var(--neon-yellow);
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(255, 241, 166, 0.3);
            animation: fadeIn 0.3s;
            max-height: 85vh;          /* â­ ä¸è¶…éè¦–çª— */
            overflow: hidden;          /* â­ é—œéµï¼šå¤–å±¤ä¸å‡ºæ²è»¸ */
        }

        .modal-scroll {
            max-height: 85vh;
            overflow-y: auto;          /* â­ å¯ä»¥æ»‘ */
            padding: 20px;
            box-sizing: border-box;

            /* === éš±è— scrollbar === */
            scrollbar-width: none;     /* Firefox */
            -ms-overflow-style: none;  /* IE / Edge */
        }

        .modal-scroll::-webkit-scrollbar {
            display: none;             /* Chrome / Safari */
        }

        .photo-preview {
            width: 100%;
            height: 200px;
            margin-top: 6px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .photo-upload-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 14px;
            border-radius: 8px;
            background: var(--neon-blue);
            color: var(--neon-yellow);
            cursor: pointer;
            font-size: 14px;
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close {
            color: var(--text-dark);
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }

        .close:hover,
        .close:focus {
            color: var(--neon-pink);
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--neon-yellow);
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #2a2a2a;
            color: var(--text-light);
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--neon-blue);
        }
        
        /* è®“æ—¥æœŸé¸æ“‡æŒ‰éˆ•ï¼ˆæ—¥æ›†åœ–æ¨™ï¼‰åœ¨æš—è‰²æ¨¡å¼ä¸‹é¡¯ç¤ºç‚ºç™½è‰² */
        #modal_date::-webkit-calendar-picker-indicator {
            filter: invert(1); 
            cursor: pointer;
            opacity: 0.8; 
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 10px;
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        .modal-actions button:active {
            transform: scale(0.98);
        }

        #modalDeleteBtn {
            background-color: var(--neon-pink);
            color: var(--bg-dark);
        }
        #modalDeleteBtn:hover {
            background-color: #ff8ca3;
        }

        #modalSaveBtn {
            background-color: var(--neon-green);
            color: var(--bg-dark);
            flex-grow: 1;
        }
        #modalSaveBtn:hover {
            background-color: #79f7a7;
        }

        .record-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.04);
            padding: 25px 30px;
            border-radius: 16px;
            box-shadow: 0 0 20px rgba(155,228,255,0.05);
        }

        .record-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--neon-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* è¡¨å–®ç¾¤çµ„ */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 18px;
        }

        .form-group label {
            margin-bottom: 6px;
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* è¼¸å…¥æ¡† */
        .record-form input,
        .record-form select {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: var(--text-light);
            font-size: 1rem;
        }

        .record-form input::placeholder {
            color: var(--text-dark);
        }

        /* é¡å‹é¸æ“‡ */
        .type-buttons {
            display: flex;
            gap: 10px;
        }

        .type-btn {
            flex: 1;
            padding: 12px 0;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-light);
            cursor: pointer;
            transition: 0.25s;
        }

        .type-btn.active {
            background: linear-gradient(135deg, #7bc8ff, #5fb0ff);
            color: #0d1a2b;
            font-weight: bold;
            border-color: transparent;
        }

        .type-btn.income.active {
            background: linear-gradient(135deg, #8cd6ff, #4da6ff);
            color: #0f1a2b;
        }
        
        .type-btn.expense.active {
            background: linear-gradient(135deg, #ff9ac2, #ff7ba9);
            color: #2b0f17;
        }

        /* --- New: é¡å‹æŒ‰éˆ• (Type Button) çš„è¦–è¦ºå¼·åŒ– --- */
        .type-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .type-btn {
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.6; /* é è¨­è¼ƒæš— */
            color: var(--bg-dark); /* æ–‡å­—é¡è‰²ç‚ºæ·±è‰² */
        }

        /* æ”¯å‡º (Expense) é è¨­æ¨£å¼ */
        #expenseBtn {
            background-color: var(--neon-pink); 
            box-shadow: 0 0 8px rgba(255, 156, 207, 0.4);
        }

        /* æ”¶å…¥ (Income) é è¨­æ¨£å¼ */
        #incomeBtn {
            background-color: var(--neon-blue); 
            box-shadow: 0 0 8px rgba(155, 228, 255, 0.4);
        }

        /* é¡å‹é¸ä¸­æ™‚ (Active) çš„æ¨£å¼ï¼šé«˜äº® */
        .type-btn.active {
            opacity: 1;
            transform: scale(1.05);
        }

        /* --- New: åˆ†é¡ç®¡ç†å®¹å™¨é¡è‰²æŒ‡ç¤º --- */
        #categoryManagement.expense-type .section-header {
            border-left-color: var(--neon-pink);
            color: var(--neon-pink);
        }

        #categoryManagement.income-type .section-header {
            border-left-color: var(--neon-blue);
            color: var(--neon-blue);
        }

        /* å­åˆ†é¡ (Sub Category) åˆ—è¡¨æ¨£å¼èª¿æ•´ */
        .sub-category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* è®“å­åˆ†é¡è‡ªå‹•åˆ†ä½ˆ */
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
        }

        /* é€å‡ºæŒ‰éˆ• */
        .submit-btn {
            width: 100%;
            padding: 14px 18px;
            background: linear-gradient(135deg, #8cd6ff, #4da6ff);
            color: #0d1a2b;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: 0.25s;
            margin-top: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(123, 200, 255, 0.4);
        }

        .submit-btn:active {
            transform: scale(0.97);
        }

        /* --- New: æ‡¸æµ®æŒ‰éˆ• (FAB) æ¨£å¼ --- */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 500; /* ç¢ºä¿åœ¨å¤§å¤šæ•¸å…§å®¹ä¹‹ä¸Š */
        }

        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            /* ä½¿ç”¨éœ“è™¹è—ä½œç‚ºä¸»æŒ‰éˆ•é¡è‰² */
            background-color: var(--neon-blue);
            color: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            cursor: pointer;
            transition: transform 0.3s, background-color 0.3s;
            position: relative;
            /* æ–°å¢ï¼šæ»‘é¼ æ‡¸åœæ™‚çš„ç™¼å…‰æ•ˆæœ */
            box-shadow: 0 0 10px rgba(167, 215, 255, 0.5), 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .fab:hover {
            background-color: #7bc8ff;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(167, 215, 255, 0.8), 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .fab.open {
            /* å±•é–‹æ™‚é¡è‰²è®Šç‚ºç²‰è‰²ï¼Œåœ–æ¨™æ—‹è½‰ 45 åº¦ */
            background-color: var(--neon-pink);
            transform: rotate(180deg); 
        }

        .fab-options {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 15px; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
        }

        .fab-container.open .fab-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .fab-option-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4em;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .fab-option-btn:hover {
            transform: scale(1.1);
        }

        #fabIncomeBtn {
            background-color: var(--neon-blue); /* æ”¶å…¥ï¼šè—è‰² */
            color: var(--bg-dark);
        }

        #fabExpenseBtn {
            background-color: var(--neon-pink); /* æ”¯å‡ºï¼šç²‰è‰² */
            color: var(--bg-dark);
        }

        .fab-container {
            position: fixed;
            bottom: 40px; /* ç¨å¾®æŠ¬é«˜ */
            right: 40px;
            z-index: 1000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            user-select: none;
            perspective: 1000px; /* å¼•å…¥ 3D è¦–è§’ */
        }

        /* --- ä¸»æŒ‰éˆ• (FAB) æ¨£å¼ --- */
        .fab {
            --fab-color-rgb: var(--neon-blue-rgb); /* åˆå§‹ä¸»è‰² */
            width: 68px; /* ç¨å¾®åŠ å¤§ */
            height: 68px;
            border-radius: 50%;

            /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
            background: rgba(var(--fab-color-rgb), 0.1); 
            backdrop-filter: blur(8px); 
            border: 1px solid rgba(var(--fab-color-rgb), 0.4);
            
            color: var(--text-light); 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em; /* åœ–æ¨™æ›´å¤§ */
            cursor: pointer;
            
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s, background 0.3s, border-color 0.3s;
            position: relative;
            
            /* æ ¸å¿ƒç™¼å…‰èˆ‡ 3D é™°å½± */
            box-shadow: 
                0 0 10px rgba(var(--fab-color-rgb), 0.5), 
                0 8px 15px rgba(0, 0, 0, 0.4); 
            transform: translateZ(5px); /* è¼•å¾®çš„ 3D æŠ¬å‡æ„Ÿ */
        }

        /* ä¸»åœ–æ¨™é¡è‰²ï¼Œè®“å®ƒå¾èƒŒæ™¯ä¸­å‡¸é¡¯ */
        .fab i {
            transition: color 0.3s, transform 0.3s;
            color: var(--neon-blue);
            transform: rotate(0deg);
        }

        /* æ‡¸åœæ•ˆæœ */
        .fab:hover {
            transform: translateZ(10px) scale(1.05);
            box-shadow: 
                0 0 25px rgba(var(--fab-color-rgb), 0.9),
                0 10px 20px rgba(0, 0, 0, 0.6);
        }

        /* é»æ“Šå±•é–‹æ™‚çš„æ¨£å¼ */
        .fab-container.open .fab {
            --fab-color-rgb: var(--neon-pink-rgb); /* å±•é–‹æ™‚è®Šç‚ºéœ“è™¹ç²‰ RGB */
            border-color: rgba(var(--neon-pink-rgb), 0.4);
            background: rgba(var(--neon-pink-rgb), 0.1);
            transform: rotate(180deg) translateZ(5px); 
            box-shadow: 
                0 0 20px var(--neon-pink), 
                0 4px 20px rgba(0, 0, 0, 0.8); 
        }

        .fab-container.open .fab i {
            color: var(--neon-pink);
            transform: rotate(90deg); 
        }


        /* --- é¸é …æŒ‰éˆ•çµ„ --- */
        .fab-options {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 20px; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            
            /* åˆå§‹ç‹€æ…‹ï¼šéš±è—ä¸”åç§» */
            opacity: 0;
            visibility: hidden;
            transform: translateZ(0) translateY(20px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s;
        }

        .fab-container.open .fab-options {
            /* å±•é–‹ç‹€æ…‹ï¼šå¯è¦‹ */
            opacity: 1;
            visibility: visible;
            transform: translateZ(0) translateY(0);
        }

        /* è®“å­æŒ‰éˆ•æœ‰éšæ¢¯å¼å‡ºç¾çš„æ•ˆæœ */
        .fab-container.open #fabIncomeBtn {
            transition-delay: 0.05s;
        }
        .fab-container.open #fabExpenseBtn {
            transition-delay: 0.1s;
        }

        /* --- å­æŒ‰éˆ•æ¨£å¼ --- */
        .fab-option-btn {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); 
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s, opacity 0.3s;
            transform: translateZ(5px);
            color: var(--bg-dark);
        }

        #fabIncomeBtn {
            /* æ”¶å…¥ï¼šè—è‰²æ¼¸å±¤ */
            background: linear-gradient(135deg, var(--neon-blue), #5fb0ff);
        }

        #fabExpenseBtn {
            /* æ”¯å‡ºï¼šç²‰è‰²æ¼¸å±¤ */
            background: linear-gradient(135deg, var(--neon-pink), #ff7ba9);
        }

        .fab-option-btn:hover {
            transform: translateZ(10px) scale(1.1); /* æ‡¸åœæ™‚å¾®æ”¾å¤§ä¸”æŠ¬å‡ */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 6px 20px rgba(0, 0, 0, 0.6); 
        }

    </style>
</head>
<body>

    <div class="main-content">
        <div id="list" class="page active">
            <div class="container">
                <h1>âš¡LumiTrack</h1>
                <div class="dashboard-container">
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æ”¶å…¥</div>
                        <div class="summary-value val-income" id="dashIncome">$0</div>
                        <div class="progress-bg"><div class="progress-fill fill-income" id="barIncome" style="width: 0%"></div></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æ”¯å‡º</div>
                        <div class="summary-value val-expense" id="dashExpense">$0</div>
                        <div class="progress-bg"><div class="progress-fill fill-expense" id="barExpense" style="width: 0%"></div></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ç¸½çµé¤˜</div>
                        <div class="summary-value val-balance" id="dashBalance">$0</div>
                        <div class="progress-bg"><div class="progress-fill fill-balance" id="barBalance" style="width: 0%"></div></div>
                    </div>
                </div>

                <h1>ğŸ—“ï¸ æ­·å²äº¤æ˜“ç´€éŒ„</h1>
                <div id="emptyState" style="display: none;">
                    <div class="no-transactions-message">
                        <i class="fas fa-ghost"></i>
                        <p>ç›®å‰é‚„æ²’æœ‰ä»»ä½•äº¤æ˜“ç´€éŒ„ï¼Œå¿«é»æ“ŠæŒ‰éˆ•æ–°å¢ç¬¬ä¸€ç­†å§ï¼</p>
                        <button type="button" id="addFirstTransactionBtn" class="add-button">
                            <i class="fas fa-plus-circle"></i> æ–°å¢äº¤æ˜“
                        </button>
                    </div>
                </div>
                <div id="transactionList"></div>
            </div>
        </div>

        <div id="editTransactionModal" class="modal">
            <div class="modal-content">
                <span class="close" id="modalCloseBtn">&times;</span>

                <div class="modal-scroll">

                    <h2 style="color: var(--neon-blue); margin-top: 0;">ç·¨è¼¯äº¤æ˜“</h2>
                    <form id="editForm">
                        <input type="hidden" id="modal_id">

                        <div class="form-group">
                            <label for="modal_date">æ—¥æœŸ</label>
                            <input type="date" id="modal_date" required>
                        </div>

                        <div class="form-group">
                            <label for="modal_type">é¡å‹</label>
                            <select id="modal_type" required>
                                <option value="expense">æ”¯å‡º</option>
                                <option value="income">æ”¶å…¥</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="modal_main_category">ä¸»åˆ†é¡</label>
                            <select id="modal_main_category" required></select>
                        </div>

                        <div class="form-group">
                            <label for="modal_sub_category">å­åˆ†é¡</label>
                            <select id="modal_sub_category"></select>
                        </div>

                        <div class="form-group">
                            <label for="modal_amount">é‡‘é¡</label>
                            <input type="number" id="modal_amount" min="0" step="1" required placeholder="è¼¸å…¥é‡‘é¡">
                        </div>

                        <div class="form-group">
                            <label>å¹£åˆ¥</label>
                            <select id="modal_currency"></select>
                        </div>

                        <div class="form-group">
                            <small id="exchangeHint" style="opacity:0.7"></small>
                        </div>


                        <!-- ğŸ“¸ äº¤æ˜“ç…§ç‰‡ -->
                        <div class="form-group">
                            <label>äº¤æ˜“ç…§ç‰‡</label>

                            <label class="photo-upload-btn">
                                <i class="fas fa-upload"></i> ä¸Šå‚³ / æ›´æ›ç…§ç‰‡
                                <input type="file" id="photoInput" accept="image/*" hidden>
                            </label>

                            <div class="photo-preview" id="photoPreview">
                                <i class="fas fa-camera"></i>
                                <p>å°šæœªä¸Šå‚³ç…§ç‰‡</p>
                            </div>

                        </div>

                        <div class="form-group">
                            <label for="modal_description">å‚™è¨»</label>
                            <input type="text" id="modal_description" placeholder="è¼¸å…¥å‚™è¨»...">
                        </div>

                        <div class="modal-actions">
                            <button type="button" id="modalDeleteBtn" style="display: none;">
                                <i class="fas fa-trash"></i> åˆªé™¤
                            </button>
                            
                            <button type="submit" id="modalSaveBtn">
                                <i class="fas fa-save"></i> å„²å­˜ä¿®æ”¹
                            </button>

                            <button type="button" id="modalCopyBtn">
                                <i class="fas fa-copy"></i> è¤‡è£½äº¤æ˜“
                            </button>

                        </div>
                    </form>

                </div>

            </div>
        </div>

        <div class="fab-container" id="fabContainer">
            <div class="fab" id="mainFab">
                <i class="fa fa-ellipsis-h" aria-hidden="true"></i>
            </div>
            <div class="fab-options">
                <div class="fab-option-btn" id="fabIncomeBtn" data-type="income">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="fab-option-btn" id="fabExpenseBtn" data-type="expense">
                    <i class="fas fa-minus"></i>
                </div>
            </div>
        </div>
        
    </div>

    
</body>
    <script>

        // ================= å¹£åˆ¥ / åŒ¯ç‡ç³»çµ± =================
        const DEFAULT_CURRENCY_SETTING = {
            base: 'TWD',
            symbol: 'NT$'
        };

        const DEFAULT_RATES = {
            TWD:1,
            USD:0.032,
            JPY:4.6,
            EUR:0.029,
            HKD:0.24,
            CNY:0.22,
            GBP:0.024,
            AUD:0.046,
            KRW:41.5,
            SGD:0.041
        };

        function getCurrencySetting() {
            return JSON.parse(localStorage.getItem('app_currency')) || DEFAULT_CURRENCY_SETTING;
        }

        function getCurrencyRates() {
            return JSON.parse(localStorage.getItem('currency_rates')) || DEFAULT_RATES;
        }

        function formatMoney(amount) {
            const { symbol } = getCurrencySetting();
            return `${symbol}${Number(amount).toLocaleString()}`;
        }

        function convertAmount(amount, from, to) {
            const rates = getCurrencyRates();
            if (!rates[from] || !rates[to]) return amount;
            return amount / rates[from] * rates[to];
        }


        const CATEGORY_KEY = 'categoryData';
        const IMGS = 'RECEIPT_IMAGES';

        let receiptImages = {}; 

        function loadReceiptImages() {
            const imgsStr = localStorage.getItem(IMGS);
            receiptImages = imgsStr ? JSON.parse(imgsStr) : {};
        }

        function loadCategoryData() {
            return JSON.parse(localStorage.getItem(CATEGORY_KEY) || '{}');
        }

        // --------------------------- æ•¸æ“šæ ¸å¿ƒ (å‡è³‡æ–™æ¨¡å¼) ---------------------------
        const DUMMY_TRANSACTIONS = [];
        const DUMMY_CATEGORY_LISTS = {
            expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'ä½æˆ¿', 'å…¶ä»–'],
            income: ['è–ªæ°´', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–æ”¶å…¥'] // å°‡å…¶ä»–æ”¹ç‚ºå…¶ä»–æ”¶å…¥ä»¥é¿å…è¡çª
        };

        // [æ–°å¢] é è¨­çš„å­åˆ†é¡è³‡æ–™ (ç‚ºäº†è®“ç·¨è¼¯åŠŸèƒ½é‹ä½œ)
        const DEFAULT_SUB_CATEGORIES = {
            // æ”¯å‡ºé¡
            'é¤é£²': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'é£²æ–™', 'é›¶é£Ÿ'],
            'äº¤é€š': ['æ·é‹', 'å…¬è»Š', 'è¨ˆç¨‹è»Š', 'åŠ æ²¹', 'åœè»Šè²»'],
            'è³¼ç‰©': ['æ—¥ç”¨å“', 'æœé£¾', '3C', 'ç¾å¦', 'é›œè²¨'],
            'å¨›æ¨‚': ['é›»å½±', 'éŠæˆ²', 'KTV', 'èšæœƒ', 'è¨‚é–±æœå‹™'],
            'ä½æˆ¿': ['æˆ¿ç§Ÿ', 'æ°´é›»è²»', 'ç®¡ç†è²»', 'ç¶²è·¯è²»', 'ä¿®ç¹•'],
            'å…¶ä»–': ['é†«ç™‚', 'ä¿éšª', 'æ•™è‚²', 'ææ¬¾', 'é›œé …'],
            
            // æ”¶å…¥é¡
            'è–ªæ°´': ['æ­£è·è–ªè³‡', 'åŠ ç­è²»'],
            'çé‡‘': ['å¹´çµ‚', 'ç¸¾æ•ˆ', 'ä¸‰ç¯€'],
            'æŠ•è³‡': ['è‚¡ç¥¨', 'åˆ©æ¯', 'è‚¡æ¯', 'åŸºé‡‘'],
            'å…¼è·': ['å¤–åŒ…', 'æ‰“å·¥'],
            'å…¶ä»–æ”¶å…¥': ['ç´…åŒ…', 'äºŒæ‰‹æ‹è³£', 'é€€ç¨…']
        };

        const CATEGORY_COLOR_MAP = {
            expense: [
                { id: 1, name: "é¤é£²", icon: "fas fa-utensils", color: "var(--cat-1)", sub: [
                    { id: 101, name: "å¤–é£Ÿ", icon: "fas fa-burger", color: "var(--cat-1)" },
                    { id: 102, name: "é£²å“", icon: "fas fa-coffee", color: "var(--cat-1)" },
                    { id: 103, name: "é›¶é£Ÿ", icon: "fas fa-cookie-bite", color: "var(--cat-1)" },
                ]},
                { id: 2, name: "äº¤é€š", icon: "fas fa-bus", color: "var(--cat-2)", sub: [
                    { id: 201, name: "æ²¹è³‡/å……é›»", icon: "fas fa-gas-pump", color: "var(--cat-2)" },
                    { id: 202, name: "å…¬è»Š/æ·é‹", icon: "fas fa-subway", color: "var(--cat-2)" },
                    { id: 203, name: "è¨ˆç¨‹è»Š", icon: "fas fa-taxi", color: "var(--cat-2)" },
                ]},
                { id: 3, name: "è³¼ç‰©", icon: "fas fa-shopping-bag", color: "var(--cat-3)", sub: [
                    { id: 301, name: "æœé£¾", icon: "fas fa-shirt", color: "var(--cat-3)" },
                    { id: 302, name: "æ—¥ç”¨å“", icon: "fas fa-toilet-paper", color: "var(--cat-3)" },
                    { id: 303, name: "3C ç”¢å“", icon: "fas fa-mobile-screen-button", color: "var(--cat-3)" },
                ]},
                { id: 4, name: "å¨›æ¨‚", icon: "fas fa-gamepad", color: "var(--cat-4)", sub: [
                    { id: 401, name: "é›»å½±/å±•è¦½", icon: "fas fa-ticket", color: "var(--cat-4)" },
                    { id: 402, name: "éŠæˆ²", icon: "fas fa-dice", color: "var(--cat-4)" },
                    { id: 403, name: "æ—…éŠ", icon: "fas fa-plane", color: "var(--cat-4)" },
                ]},
                { id: 5, name: "å±…ä½", icon: "fas fa-home", color: "var(--cat-5)", sub: [
                    { id: 501, name: "æˆ¿ç§Ÿ/æˆ¿è²¸", icon: "fas fa-building-columns", color: "var(--cat-5)" },
                    { id: 502, name: "æ°´é›»ç“¦æ–¯", icon: "fas fa-lightbulb", color: "var(--cat-5)" },
                    { id: 503, name: "ç¶²è·¯/é›»ä¿¡", icon: "fas fa-signal", color: "var(--cat-5)" },
                ]}
            ],
            income: [
                { id: 6, name: "è–ªè³‡", icon: "fas fa-money-check-alt", color: "var(--cat-6)", sub: [
                    { id: 601, name: "æœˆè–ª", icon: "fas fa-money-bill-wave", color: "var(--cat-6)" },
                    { id: 602, name: "çé‡‘", icon: "fas fa-hand-holding-dollar", color: "var(--cat-6)" },
                    { id: 603, name: "å…¼è·", icon: "fas fa-briefcase", color: "var(--cat-6)" },
                ]},
                { id: 7, name: "æŠ•è³‡", icon: "fas fa-chart-line", color: "var(--cat-7)", sub: [
                    { id: 701, name: "è‚¡æ¯", icon: "fas fa-arrow-trend-up", color: "var(--cat-7)" },
                    { id: 702, name: "åŸºé‡‘æ”¶ç›Š", icon: "fas fa-vault", color: "var(--cat-7)" },
                    { id: 703, name: "æˆ¿ç”¢ç§Ÿé‡‘", icon: "fas fa-house-chimney-crack", color: "var(--cat-7)" },
                ]},
                { id: 8, name: "ç¦®é‡‘", icon: "fas fa-gift", color: "var(--cat-8)", sub: [
                    { id: 801, name: "ç´…åŒ…", icon: "fas fa-envelope", color: "var(--cat-8)" },
                    { id: 802, name: "ç”Ÿæ—¥ç¦®ç‰©", icon: "fas fa-cake-candles", color: "var(--cat-8)" },
                    { id: 803, name: "è´ŠåŠ©", icon: "fas fa-heart", color: "var(--cat-8)" },
                ]},
                { id: 9, name: "å‰¯æ¥­", icon: "fas fa-laptop-code", color: "var(--cat-9)", sub: [
                    { id: 901, name: "ç¨¿è²»", icon: "fas fa-pen-nib", color: "var(--cat-9)" },
                    { id: 902, name: "éŠ·å”®", icon: "fas fa-store", color: "var(--cat-9)" },
                    { id: 903, name: "æœå‹™è²»", icon: "fas fa-handshake", color: "var(--cat-9)" },
                ]},
                { id: 10, name: "å…¶ä»–", icon: "fas fa-ellipsis-h", color: "var(--cat-10)", sub: [
                    { id: 1101, name: "é€€æ¬¾", icon: "fas fa-undo", color: "var(--cat-10)" },
                    { id: 1102, name: "æ„å¤–æ”¶å…¥", icon: "fas fa-meteor", color: "var(--cat-10)" },
                    { id: 1103, name: "åˆ©æ¯", icon: "fas fa-percent", color: "var(--cat-10)" },
                ]}
            ]

        };



        // [JS] 1. è®€å–èˆ‡è¨˜å¸³é é¢åŒæ­¥çš„åˆ†é¡è³‡æ–™
        function loadAppCategories() {
            const stored = localStorage.getItem('app_categories');
            if (stored) {
                return JSON.parse(stored);
            }
            // é è¨­è³‡æ–™ (è‹¥ localStorage æ²’æ±è¥¿)
            return {
                expense: {
                    'é¤é£²': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'é£²æ–™', 'é›¶é£Ÿ'],
                    'äº¤é€š': ['æ·é‹', 'å…¬è»Š', 'è¨ˆç¨‹è»Š', 'åŠ æ²¹', 'åœè»Šè²»'],
                    'è³¼ç‰©': ['æ—¥ç”¨å“', 'æœé£¾', '3C', 'ç¾å¦', 'é›œè²¨'],
                    'å¨›æ¨‚': ['é›»å½±', 'éŠæˆ²', 'KTV', 'èšæœƒ', 'è¨‚é–±æœå‹™'],
                    'ä½æˆ¿': ['æˆ¿ç§Ÿ', 'æ°´é›»è²»', 'ç®¡ç†è²»', 'ç¶²è·¯è²»', 'ä¿®ç¹•'],
                    'å…¶ä»–': ['é†«ç™‚', 'ä¿éšª', 'æ•™è‚²', 'ææ¬¾', 'é›œé …']
                },
                income: {
                    'è–ªæ°´': ['æ­£è·è–ªè³‡', 'åŠ ç­è²»'],
                    'çé‡‘': ['å¹´çµ‚', 'ç¸¾æ•ˆ', 'ä¸‰ç¯€'],
                    'æŠ•è³‡': ['è‚¡ç¥¨', 'åˆ©æ¯', 'è‚¡æ¯', 'åŸºé‡‘'],
                    'å…¼è·': ['å¤–åŒ…', 'æ‰“å·¥'],
                    'å…¶ä»–æ”¶å…¥': ['ç´…åŒ…', 'äºŒæ‰‹æ‹è³£', 'é€€ç¨…']
                }
            };
        }
        let APP_CATEGORIES = loadAppCategories();

        function resolveCategoryIcon(type, mainCat, subCat) {
            const categoryData = loadCategoryData();
            const list = categoryData[type] || [];

            const main = list.find(c => c.name === mainCat);
            if (!main) return 'fas fa-folder';

            const subs = main.sub || main.subs || [];

            if (subCat && subs.length > 0) {
                const sub = subs.find(s => s.name === subCat);
                if (sub?.icon) return sub.icon;
            }

            // return main.icon || 'fas fa-folder';

            return main.icon || CATEGORY_ICON_MAP[mainCat] || 'fas fa-folder';

        }

        // [JS] ç¢ºä¿æœ‰é€™å€‹åœ–ç¤ºå°ç…§è¡¨ï¼Œä¸ç„¶å­˜æª”æœƒå ±éŒ¯ï¼
        const CATEGORY_ICON_MAP = {
            // æ”¯å‡º
            'é¤é£²': 'fas fa-utensils',
            'äº¤é€š': 'fas fa-bus',
            'è³¼ç‰©': 'fas fa-shopping-bag',
            'å¨›æ¨‚': 'fas fa-gamepad',
            'ä½æˆ¿': 'fas fa-home',
            'å…¶ä»–': 'fas fa-box',
            // æ”¶å…¥
            'è–ªæ°´': 'fas fa-money-bill-wave',
            'çé‡‘': 'fas fa-star',
            'æŠ•è³‡': 'fas fa-chart-line',
            'å…¼è·': 'fas fa-briefcase',
            'å…¶ä»–æ”¶å…¥': 'fas fa-hand-holding-usd'
        };

        // å¾ localStorage è®€å–æ•¸æ“šï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨å‡è³‡æ–™ä¸¦å­˜å…¥
        let TRANSACTIONS = JSON.parse(localStorage.getItem('transactions'));
        let CATEGORY_LISTS = JSON.parse(localStorage.getItem('categoryLists'));

        // â­ï¸ æ ¸å¿ƒä¿®æ­£ 1: è³‡æ–™åˆå§‹åŒ–èˆ‡è£œé½Š
        if (!TRANSACTIONS) {
            // å¦‚æœé€£è³‡æ–™éƒ½æ²’æœ‰ï¼Œå‰‡åˆå§‹åŒ–ç‚ºç©ºé™£åˆ—ä¸¦å­˜å…¥
            TRANSACTIONS = DUMMY_TRANSACTIONS;
            localStorage.setItem('transactions', JSON.stringify(TRANSACTIONS));
            console.log('--- âš ï¸ äº¤æ˜“è³‡æ–™åˆå§‹åŒ–ç‚ºç©ºé™£åˆ— âš ï¸ ---');
        } else {
            // å¦‚æœæœ‰è³‡æ–™ (ä¸è«–æ˜¯å¦ç‚ºç©ºé™£åˆ—)ï¼Œæª¢æŸ¥ä¸¦è£œé½Šå¿…è¦çš„æ¬„ä½ (ä¾‹å¦‚ recordpage.html æ²’å­˜çš„ icon)
            let isDataModified = false;
            TRANSACTIONS = TRANSACTIONS.map(t => {
                // å¦‚æœ icon æ¬„ä½ç¼ºå¤± (ä¾‹å¦‚ç‚º undefined æˆ–ç©ºå­—ä¸² '')ï¼Œå‰‡å˜—è©¦æ ¹æ“š category è£œä¸Šåœ–æ¨™
                if (!t.icon || t.icon === "") {
                    const primaryCategory = t.category.split(' / ')[0]; // å³ä½¿æ˜¯ã€Œä¸»åˆ†é¡ / å­åˆ†é¡ã€ï¼Œä¹Ÿåªå–ä¸»åˆ†é¡
                    const iconMapKey = primaryCategory in CATEGORY_ICON_MAP ? primaryCategory : (t.type === 'expense' ? 'å…¶ä»–' : 'å…¶ä»–æ”¶å…¥');
                    t.icon = CATEGORY_ICON_MAP[iconMapKey] || 'fas fa-question';
                    isDataModified = true;
                }

                if (!('receiptImageKey' in t)) {
                    t.receiptImageKey = '';
                    isDataModified = true;
                }

                return t;
            });

            // å¦‚æœæœ‰ä»»ä½•è³‡æ–™è¢«ä¿®æ”¹ï¼ˆè£œä¸Šåœ–æ¨™ï¼‰ï¼Œå‰‡å­˜å› localStorage
            if (isDataModified) {
                localStorage.setItem('transactions', JSON.stringify(TRANSACTIONS));
                console.log('--- âœ… æˆåŠŸè£œé½Šäº¤æ˜“ç´€éŒ„ä¸­çš„åœ–æ¨™æ¬„ä½ ---');
            }
        }

        const { base } = getCurrencySetting();

        TRANSACTIONS = TRANSACTIONS.map(t => {
            if (!t.currency) t.currency = base;
            if (!t.baseAmount) t.baseAmount = t.amount;
            return t;
        });

        

        // ç¢ºä¿åˆ†é¡åˆ—è¡¨å­˜åœ¨
        if (!CATEGORY_LISTS) {
            CATEGORY_LISTS = DUMMY_CATEGORY_LISTS;
            localStorage.setItem('categoryLists', JSON.stringify(CATEGORY_LISTS));
        }

        // --------------------------- æ•¸æ“šæ“ä½œå‡½å¼ ---------------------------

        /**
         * å°‡ç•¶å‰äº¤æ˜“åˆ—è¡¨å­˜å› localStorage
         */
        function saveToLocalStorage() {
            localStorage.setItem('transactions', JSON.stringify(TRANSACTIONS));
        }

        /**
         * æ ¹æ“š ID å–å¾—äº¤æ˜“ç‰©ä»¶
         * @param {number} id - äº¤æ˜“ ID
         * @returns {Object|null} äº¤æ˜“ç‰©ä»¶æˆ– null
         */
        function getTransactionById(id) {
            return TRANSACTIONS.find(t => t.id === id);
        }

        // --------------------------- Modal ç›¸é—œå‡½å¼ ---------------------------

        /**
         * é—œé–‰ç·¨è¼¯ Modal
         */
        function closeModal() {
            document.getElementById('editTransactionModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å–®ï¼Œé¿å…ä¸‹æ¬¡æ‰“é–‹æ®˜ç•™è³‡æ–™
            document.getElementById('editForm').reset();
            document.getElementById('modal_id').value = '';
            
            currentPhotoBase64 = '';
            document.getElementById('photoPreview').innerHTML = `
                <i class="fas fa-camera"></i>
                <p>å°šæœªä¸Šå‚³ç…§ç‰‡</p>
            `;
            
            // éš±è—åˆªé™¤æŒ‰éˆ•
            document.getElementById('modalDeleteBtn').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('editTransactionModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        let currentReceiptImageKey = '';

        document.getElementById('photoInput').addEventListener('change', async function () {
            const file = this.files[0];
            if (!file) return;

            const base64 = await resizeImageKeepRatio(file);
            const key = 'receipt_' + Date.now();

            const receiptMap = JSON.parse(localStorage.getItem('receiptImages') || '{}');
            receiptMap[key] = base64;
            localStorage.setItem('receiptImages', JSON.stringify(receiptMap));

            currentReceiptImageKey = key;
            
            // å¦‚æœæ˜¯ç·¨è¼¯ä¸­ï¼Œç›´æ¥æ›´æ–°äº¤æ˜“ç‰©ä»¶
            const modalId = parseInt(document.getElementById('modal_id').value);
            if(modalId > 0){
                const t = TRANSACTIONS.find(tx => tx.id === modalId);
                if(t){
                    t.receiptImageKey = key;
                    saveToLocalStorage();
                    renderTransactionList();
                }
            }

            document.getElementById('photoPreview').innerHTML = `<img src="${base64}">`;
        });



        function resizeImageKeepRatio(file, maxEdge = 1200, quality = 0.8) {
            return new Promise(resolve => {
                const img = new Image();
                const reader = new FileReader();

                reader.onload = e => img.src = e.target.result;
                reader.readAsDataURL(file);

                img.onload = () => {
                    let { width, height } = img;

                    // åªè™•ç†éå¤§çš„åœ–ç‰‡
                    if (Math.max(width, height) > maxEdge) {
                        const scale = maxEdge / Math.max(width, height);
                        width = Math.round(width * scale);
                        height = Math.round(height * scale);
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        }

        function updateModalCategories(type, selectedMain, selectedSub) {
            const mainSelect = document.getElementById('modal_main_category');
            const subSelect = document.getElementById('modal_sub_category');
            
            // 1. æ¸…ç©ºä¸»åˆ†é¡ä¸¦é‡æ–°ç”Ÿæˆ
            mainSelect.innerHTML = '';
            const categories = CATEGORY_LISTS[type] || [];
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === selectedMain) {
                    option.selected = true;
                }
                mainSelect.appendChild(option);
            });

            // è‹¥åŸä¸»åˆ†é¡ä¸åœ¨æ¸…å–®ä¸­ï¼ˆé˜²å‘†ï¼‰ï¼ŒåŠ å›å»
            if (selectedMain && !categories.includes(selectedMain)) {
                const option = document.createElement('option');
                option.value = selectedMain;
                option.textContent = selectedMain;
                option.selected = true;
                mainSelect.appendChild(option);
            }

            // 2. å®šç¾©æ›´æ–°å­åˆ†é¡çš„å…§éƒ¨å‡½å¼
            const updateSubOptions = (mainCat) => {
                subSelect.innerHTML = '';
                // å–å¾—è©²ä¸»åˆ†é¡ä¸‹çš„å­åˆ†é¡åˆ—è¡¨ï¼Œè‹¥ç„¡å‰‡çµ¦ä¸€å€‹é è¨­ç©ºé¸é …
                const subCategories = DEFAULT_SUB_CATEGORIES[mainCat] || ['ç„¡å­åˆ†é¡'];
                
                subCategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    // å¦‚æœå‚³å…¥çš„å­åˆ†é¡ç¬¦åˆï¼Œå‰‡é¸ä¸­
                    if (sub === selectedSub) {
                        option.selected = true;
                    }
                    subSelect.appendChild(option);
                });

                // é˜²å‘†ï¼šè‹¥åŸä¾†çš„å­åˆ†é¡ä¸åœ¨é è¨­æ¸…å–®ä¸­ï¼Œä¹Ÿè¦åŠ å›å»é¡¯ç¤º
                if (selectedSub && !subCategories.includes(selectedSub)) {
                    const option = document.createElement('option');
                    option.value = selectedSub;
                    option.textContent = selectedSub;
                    option.selected = true;
                    subSelect.appendChild(option);
                }
            };

            // 3. åˆå§‹åŸ·è¡Œä¸€æ¬¡æ›´æ–°å­åˆ†é¡ (ä½¿ç”¨ç•¶å‰é¸ä¸­çš„ä¸»åˆ†é¡)
            updateSubOptions(mainSelect.value);

            // 4. [é—œéµ] ç§»é™¤èˆŠçš„ç›£è½å™¨ä¸¦ç¶å®šæ–°çš„ (é¿å…é‡è¤‡ç¶å®š)
            // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘ä½¿ç”¨ onchange å±¬æ€§è¦†è“‹
            mainSelect.onchange = function() {
                updateSubOptions(this.value);
            };
        }

        /**
         * æ¸…ç©ºä¸¦é–‹å•Ÿ Modal ç”¨æ–¼æ–°å¢äº¤æ˜“ (æ­¤åŠŸèƒ½ç›®å‰è¢« recordpage.html å–ä»£)
         */
        function openNewTransactionModal() {
            // è¨­ç½® Modal æ¨™é¡Œ
            document.querySelector('#editTransactionModal h2').textContent = 'æ–°å¢äº¤æ˜“';
            
            // æ¸…ç©ºä¸¦è¨­ç½®é è¨­å€¼
            document.getElementById('modal_id').value = 0; // ä½¿ç”¨ 0 æˆ– -1 è¡¨ç¤ºæ–°äº¤æ˜“
            document.getElementById('modal_date').value = new Date().toISOString().split('T')[0]; // é è¨­ä»Šå¤©
            document.getElementById('modal_type').value = 'expense';
            document.getElementById('modal_amount').value = '';
            document.getElementById('modal_description').value = '';

            // é è¨­åˆ†é¡ç‚ºæ”¯å‡ºé¡çš„ç¬¬ä¸€é …
            updateModalCategories('expense', CATEGORY_LISTS['expense'][0] || '');

            // éš±è—åˆªé™¤æŒ‰éˆ•
            document.getElementById('modalDeleteBtn').style.display = 'none';

            // è®Šæ›´å„²å­˜æŒ‰éˆ•æ–‡å­—
            document.getElementById('modalSaveBtn').innerHTML = '<i class="fas fa-plus-circle"></i> æ–°å¢äº¤æ˜“';

            // é¡¯ç¤º Modal
            document.getElementById('editTransactionModal').style.display = 'block';
        }

        /**
         * [JS] é–‹å•Ÿç·¨è¼¯è¦–çª— (ä¿®å¾©ï¼šä½¿ç”¨ Clone Node å¾¹åº•è§£æ±ºé‡è¤‡è·³çª—å•é¡Œ)
         */
        function editTransaction(id) {
            const transaction = TRANSACTIONS.find(t => t.id === id);
            if (!transaction) return;

            document.getElementById('modal_id').value = transaction.id;
            document.getElementById('modal_date').value = transaction.date;
            document.getElementById('modal_type').value = transaction.type;

            // â­ï¸ è¨­ç½®å¹£åˆ¥é¸å–®
            renderCurrencySelect(transaction.currency);

            // â­ï¸ å¡«å…¥äº¤æ˜“ç•¶æ™‚è¼¸å…¥çš„åŸå§‹é‡‘é¡
            document.getElementById('modal_amount').value = transaction.amount;

            // â­ï¸ é¸æ“‡å¹£åˆ¥
            document.getElementById('modal_currency').value = transaction.currency;

            // â­ï¸ æ›´æ–°å³æ™‚æ›ç®—é¡¯ç¤º baseAmount
            updateExchangePreview();

            document.getElementById('modal_description').value = transaction.description || '';

            // åˆ†é¡è™•ç†
            let fullCategory = transaction.category || transaction.categoryText || '';
            let mainCat = fullCategory;
            let subCat = '';
            if (fullCategory.includes(' / ')) {
                const parts = fullCategory.split(' / ');
                mainCat = parts[0];
                subCat = parts[1];
            }
            updateModalCategoriesFromCategoryData(transaction.type, mainCat, subCat);

            // é¡¯ç¤ºåˆªé™¤æŒ‰éˆ• & åœ–ç‰‡
            const delBtn = document.getElementById('modalDeleteBtn');
            if (delBtn) {
                const newBtn = delBtn.cloneNode(true);
                delBtn.parentNode.replaceChild(newBtn, delBtn);
                newBtn.style.display = 'inline-block';
                newBtn.onclick = function() {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“å—ï¼Ÿ')) deleteTransaction(transaction.id);
                };
            }

            const preview = document.getElementById('photoPreview');
            const base64Image = getReceiptImage(transaction.receiptImageKey);
            if (base64Image) {
                preview.innerHTML = `<img src="${base64Image}">`;
                currentReceiptImageKey = transaction.receiptImageKey;
            } else {
                preview.innerHTML = `<i class="fas fa-camera"></i><p>å°šæœªä¸Šå‚³ç…§ç‰‡</p>`;
                currentReceiptImageKey = '';
            }

            document.getElementById('editTransactionModal').style.display = 'flex';
        }

        // â­ï¸ å³æ™‚æ›ç®—é‡‘é¡ (Modal é¡¯ç¤º)
        function updateExchangePreview() {
            const amountInput = document.getElementById('modal_amount');
            const currencySelect = document.getElementById('modal_currency');
            const textElem = document.getElementById('exchangeHint');
            if (!amountInput || !currencySelect || !textElem) return;

            const rawAmount = parseFloat(amountInput.value.replace(/,/g, '')) || 0;
            const from = currencySelect.value || 'TWD';
            const base = getCurrencySetting().base || 'TWD';
            const symbol = getCurrencySetting().symbol || 'NT$';

            const converted = convertAmount(rawAmount, from, base);
            textElem.textContent = `å³æ™‚æ›ç®— â‰ˆ ${symbol}${converted.toFixed(2)} (${base})`;
        }

        // ç›£è½é‡‘é¡èˆ‡å¹£åˆ¥è®Šå‹•
        document.getElementById('modal_amount').addEventListener('input', updateExchangePreview);
        document.getElementById('modal_currency').addEventListener('change', updateExchangePreview);


        function importTransactions(importedList) {
            // è®€å–ç¾æœ‰çš„ receiptImages
            const receiptMap = JSON.parse(localStorage.getItem('receiptImages') || '{}');

            importedList.forEach(t => {
                // ç”Ÿæˆå”¯ä¸€ id
                if (!t.id) t.id = Date.now() + Math.floor(Math.random() * 1000);

                // å¦‚æœæœ‰ Base64 åœ–ç‰‡æ¬„ä½
                if (t.receiptImageBase64) {
                    const key = 'receipt_' + t.id;
                    receiptMap[key] = t.receiptImageBase64;
                    t.receiptImageKey = key;
                    delete t.receiptImageBase64;
                }

                // æ–°å¢åˆ°äº¤æ˜“åˆ—è¡¨
                TRANSACTIONS.push(t);
            });

            // å­˜å› localStorage
            localStorage.setItem('transactions', JSON.stringify(TRANSACTIONS));
            localStorage.setItem('receiptImages', JSON.stringify(receiptMap));

            renderTransactionList();
        }

        /**
         * [JS] åˆªé™¤äº¤æ˜“ (ç´”é‚è¼¯ï¼Œä¸è·³çª—)
         */
        function deleteTransaction(id) {
            // ç›´æ¥åŸ·è¡Œåˆªé™¤å‹•ä½œ
            TRANSACTIONS = TRANSACTIONS.filter(t => t.id !== id);
            saveToLocalStorage();
            renderTransactionList();
            closeModal();
            console.log('åˆªé™¤æˆåŠŸï¼');
        }

        function updateModalCategoriesFromCategoryData(type, selectedMain, selectedSub) {
            const mainSelect = document.getElementById('modal_main_category');
            const subSelect = document.getElementById('modal_sub_category');
            const categoryData = loadCategoryData();

            mainSelect.innerHTML = '';
            subSelect.innerHTML = '';

            const primaryList = categoryData[type] || [];

            // ä¸»åˆ†é¡
            primaryList.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                if (p.name === selectedMain) opt.selected = true;
                mainSelect.appendChild(opt);
            });

            const selectedPrimary = primaryList.find(p => p.name === mainSelect.value);

            const subs = selectedPrimary?.sub || selectedPrimary?.subs || [];
            if (subs.length) {
                subs.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.name;
                    opt.textContent = s.name;
                    if (s.name === selectedSub) opt.selected = true;
                    subSelect.appendChild(opt);
                });
            } else {
                // ç„¡å­åˆ†é¡æ™‚é¡¯ç¤ºä¸€å€‹å›ºå®šé¸é …
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'ç„¡å­åˆ†é¡';
                opt.selected = true;
                subSelect.appendChild(opt);
            }

            mainSelect.onchange = () => {
                updateModalCategoriesFromCategoryData(type, mainSelect.value, '');
            };
        }

        // [JS] 3. å„²å­˜ä¿®æ”¹ (è¶…ç´šç›´ç™½ç‰ˆï¼šç›´æ¥æŠ“é¸å–®æ–‡å­—ï¼Œä¿è­‰ä¸ç‚ºç©º)
        function saveModalChanges(e) {
            e.preventDefault();

            // 1ï¸âƒ£ å–å¾—åŸºæœ¬æ¬„ä½
            const id = parseInt(document.getElementById('modal_id').value);
            const date = document.getElementById('modal_date').value;
            const type = document.getElementById('modal_type').value;
            const description = document.getElementById('modal_description').value || '';
            const currency = document.getElementById('modal_currency').value;

            // 2ï¸âƒ£ å–å¾—é‡‘é¡ä¸¦é˜²å‘†ï¼ˆå»æ‰åƒåˆ†ä½ï¼‰
            const rawAmount = document.getElementById('modal_amount').value.replace(/,/g, '');
            const amount = parseFloat(rawAmount);
            if (isNaN(amount)) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„é‡‘é¡ï¼');
                return;
            }

            // 3ï¸âƒ£ å–å¾—åˆ†é¡
            const mainSelect = document.getElementById('modal_main_category');
            const subSelect = document.getElementById('modal_sub_category');

            let mainCat = mainSelect.selectedIndex !== -1 ? mainSelect.options[mainSelect.selectedIndex].text : mainSelect.value;
            let subCat = subSelect.selectedIndex !== -1 ? subSelect.options[subSelect.selectedIndex].text : subSelect.value;

            if (subCat === 'ç„¡å­åˆ†é¡' || subCat.trim() === '') subCat = '';

            let finalCategory = mainCat;
            if (subCat) finalCategory = `${mainCat} / ${subCat}`;
            if (!finalCategory || finalCategory.trim() === '') finalCategory = 'æœªåˆ†é¡';

            // 4ï¸âƒ£ è¨ˆç®— baseAmount
            const { base } = getCurrencySetting();
            const baseAmount = convertAmount(amount, currency, base);

            // 5ï¸âƒ£ å–å¾—åœ–ç¤º
            const newIcon = resolveCategoryIcon(type, mainCat, subCat);

            // 6ï¸âƒ£ æº–å‚™äº¤æ˜“ç‰©ä»¶
            const newData = {
                date,
                type,
                category: finalCategory,
                categoryText: finalCategory,
                currency,
                amount,
                baseAmount,
                description,
                icon: newIcon,
                receiptImageKey: currentReceiptImageKey
            };

            // 7ï¸âƒ£ å¯«å…¥äº¤æ˜“é™£åˆ—
            if (id === 0 || isNaN(id)) {
                // æ–°å¢äº¤æ˜“
                newData.id = Date.now();
                TRANSACTIONS.unshift(newData);
            } else {
                // ç·¨è¼¯äº¤æ˜“
                const index = TRANSACTIONS.findIndex(t => t.id === id);
                if (index !== -1) {
                    TRANSACTIONS[index] = { ...TRANSACTIONS[index], ...newData };
                }
            }

            // 8ï¸âƒ£ å­˜æª”ä¸¦æ›´æ–°ç•«é¢
            saveToLocalStorage();
            renderTransactionList();
            closeModal();

            // 9ï¸âƒ£ debug logï¼ˆå¯é¸ï¼‰
            console.log('äº¤æ˜“å·²ä¿å­˜ï¼š', newData);
        }

        // --------------------------- æ¸²æŸ“é‚è¼¯ ---------------------------

        // å–å¾—æ”¶æ“šåœ–ç‰‡ Base64 è³‡æ–™çš„è¼”åŠ©å‡½å¼
        function getReceiptImage(key) {
            if (!key) return null;
            const map = JSON.parse(localStorage.getItem('receiptImages') || '{}');
            return map[key] || null;
        }

        // ============== æ–°å¢ï¼šBase64 åœ–ç‰‡æŸ¥è©¢å‡½æ•¸ ==============
        function getReceiptImageBase64(key) {
            if (!key) return null;
            try {
                const receiptImages = JSON.parse(localStorage.getItem('receiptImages') || '{}');
                const base64String = receiptImages[key];
                if (base64String) {
                    if (base64String.startsWith('data:')) return base64String;
                    return 'data:image/jpeg;base64,' + base64String;
                }
                return null;
            } catch (e) {
                console.error('Error retrieving receipt image:', e);
                return null;
            }
        }

        // ======================================================

        function getCategoryColor(type, mainCategory) {
            const categoryData = JSON.parse(localStorage.getItem('categoryData')) || {};
            const list = categoryData[type] || [];
            const found = list.find(c => c.name === mainCategory);
            return found?.color || '#9E9E9E';
        }


        function renderTransactionList(list = TRANSACTIONS) {
            const listContainer = document.getElementById('transactionList');
            if (!listContainer) return;

            // è®€å–ç³»çµ±è¨­å®šçš„å¹£åˆ¥èˆ‡åŒ¯ç‡
            const currencySetting = getCurrencySetting();
            const targetCurrencyCode = currencySetting.base || 'TWD';
            const targetSymbol = currencySetting.symbol || 'NT$';
            const rates = getCurrencyRates();

            // è¨ˆç®—ç¸½é‡‘é¡ï¼ˆå°å¹£åŸºæº–ï¼‰
            let totalIncomeTWD = 0;
            let totalExpenseTWD = 0;
            const safeList = Array.isArray(list) ? list : [];

            safeList.forEach(t => {
                const amtTWD = parseFloat(t.baseAmount) || 0;
                if (t.type === 'income') totalIncomeTWD += amtTWD;
                else if (t.type === 'expense') totalExpenseTWD += amtTWD;
            });

            // æ›ç®—æˆç›®æ¨™å¹£åˆ¥
            const displayTotalIncome = convertAmount(totalIncomeTWD, 'TWD', targetCurrencyCode);
            const displayTotalExpense = convertAmount(totalExpenseTWD, 'TWD', targetCurrencyCode);
            const displayTotalBalance = displayTotalIncome - displayTotalExpense;

            // æ›´æ–°å„€è¡¨æ¿
            const dashIncome = document.getElementById('dashIncome');
            if (dashIncome) {
                const fmt = (num) => targetCurrencyCode === 'JPY' 
                    ? Math.round(num).toLocaleString() 
                    : num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

                document.getElementById('dashIncome').textContent = `${targetSymbol} ${fmt(displayTotalIncome)}`;
                document.getElementById('dashExpense').textContent = `${targetSymbol} ${fmt(displayTotalExpense)}`;
                document.getElementById('dashBalance').textContent = `${targetSymbol} ${fmt(displayTotalBalance)}`;

                const barIncome = document.getElementById('barIncome');
                const barExpense = document.getElementById('barExpense');
                const barBalance = document.getElementById('barBalance');
                if (barIncome) barIncome.style.width = totalIncomeTWD > 0 ? '100%' : '0%';
                if (barExpense) {
                    let expP = totalIncomeTWD > 0 ? (totalExpenseTWD / totalIncomeTWD) * 100 : (totalExpenseTWD > 0 ? 100 : 0);
                    barExpense.style.width = `${Math.min(expP, 100)}%`;
                }
                if (barBalance) {
                    let balP = (totalIncomeTWD > 0 && totalIncomeTWD > totalExpenseTWD) ? ((totalIncomeTWD - totalExpenseTWD) / totalIncomeTWD) * 100 : 0;
                    barBalance.style.width = `${balP}%`;
                }
            }

            // ç„¡è³‡æ–™ç‹€æ…‹
            const emptyState = document.getElementById('emptyState');
            if (safeList.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                listContainer.style.display = 'none';
                return;
            } else {
                if (emptyState) emptyState.style.display = 'none';
                listContainer.style.display = 'block';
                listContainer.innerHTML = '';
            }

            // æ—¥æœŸåˆ†çµ„
            const grouped = safeList.reduce((acc, t) => {
                const date = t.date || 'æœªçŸ¥æ—¥æœŸ';
                if (!acc[date]) acc[date] = [];
                acc[date].push(t);
                return acc;
            }, {});

            const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                // ç•¶æ—¥æ”¶å…¥/æ”¯å‡ºï¼ˆå°å¹£ï¼‰
                let dailyIncomeTWD = 0;
                let dailyExpenseTWD = 0;

                grouped[date].forEach(t => {
                    const amt = parseFloat(t.baseAmount) || 0;
                    if (t.type === 'income') dailyIncomeTWD += amt;
                    else if (t.type === 'expense') dailyExpenseTWD += amt;
                });

                // åˆ†é–‹è½‰æ›æˆç›®æ¨™å¹£åˆ¥
                let dailyBalanceDisplay = 0;
                grouped[date].forEach(t => {
                    const amtDisplay = convertAmount(parseFloat(t.amount) || 0, t.currency, targetCurrencyCode);
                    dailyBalanceDisplay += (t.type === 'income' ? 1 : -1) * amtDisplay;
                });

                const fmt = (num) => targetCurrencyCode === 'JPY'
                    ? Math.round(num).toLocaleString()
                    : num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                const formattedDaily = (dailyBalanceDisplay >= 0 ? '+' : '-') + targetSymbol +
                    (targetCurrencyCode === 'JPY' 
                        ? Math.round(Math.abs(dailyBalanceDisplay)).toLocaleString() 
                        : Math.abs(dailyBalanceDisplay).toLocaleString(undefined, { minimumFractionDigits: 2 }));


                const dateDiv = document.createElement('div');
                dateDiv.className = 'date-group';
                const summaryColor = dailyBalanceDisplay >= 0 ? 'income-color' : 'expense-color';

                dateDiv.innerHTML = `
                    <div class="date-group-header" onclick="toggleDateGroup(this)">
                        <div class="date-text">${date}</div>
                        <div class="date-summary">
                            <span class="${summaryColor}">${formattedDaily}</span>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                    </div>
                    <div class="daily-transactions" style="display: block;"></div>
                `;
                listContainer.appendChild(dateDiv);
                const dailyContainer = dateDiv.querySelector('.daily-transactions');

                // æ¯ç­†äº¤æ˜“æ¸²æŸ“
                grouped[date].forEach(t => {
                    const card = document.createElement('div');
                    card.onclick = () => editTransaction(t.id);

                    const itemDisplay = convertAmount(parseFloat(t.amount) || 0, t.currency, targetCurrencyCode);
                    const isExp = t.type === 'expense';
                    const mainCategory = (t.category || t.categoryText || '').split(' / ')[0];
                    const color = getCategoryColor(t.type, mainCategory);
                    const displayCategory = t.category || t.categoryText || 'æœªåˆ†é¡';

                    card.className = `transaction-card ${isExp ? 'expense-border' : 'income-border'}`;
                    card.innerHTML = `
                        <div class="card-content">
                            <div class="icon-section"><i class="${t.icon || 'fas fa-folder'}" style="color: ${color};"></i></div>
                            <div class="info-section">
                                <div class="category-and-desc">
                                    <span class="category-tag ${isExp ? 'cat-expense' : 'cat-income'}">${displayCategory}</span>
                                    <span class="description">${t.description || 'ç„¡å‚™è¨»'}</span>
                                </div>
                            </div>
                            <div class="amount-section ${isExp ? 'expense-color' : 'income-color'}">
                                ${isExp ? '-' : '+'} ${targetSymbol} ${
                                    targetCurrencyCode === 'JPY' 
                                    ? Math.round(itemDisplay).toLocaleString() 
                                    : itemDisplay.toLocaleString(undefined, { minimumFractionDigits: 2 })
                                }
                            </div>
                        </div>
                    `;
                    dailyContainer.appendChild(card);
                });
            });
        }

        /**
        * [JS] é»æ“Šæ—¥æœŸæ¨™é¡Œæ™‚æ”¶åˆ/å±•é–‹
        */
        function toggleDateGroup(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if(icon) icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                if(icon) icon.style.transform = 'rotate(-90deg)';
            }
        }

        function renderCurrencySelect(selected) {
            const select = document.getElementById('modal_currency');
            const rates = getCurrencyRates();
            select.innerHTML = '';

            Object.keys(rates).forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = code;
                if (code === selected) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function updateExchangePreview() {
            const amountInput = document.getElementById('modal_amount');
            const currencySelect = document.getElementById('modal_currency');

            if (!amountInput || !currencySelect) return;

            const amount = parseFloat(amountInput.value) || 0;
            const from = currencySelect.value || 'TWD'; // fallback
            const currencySetting = getCurrencySetting();
            const base = currencySetting.base || 'TWD';
            const symbol = currencySetting.symbol || 'NT$'; // âœ… fallback

            const converted = convertAmount(amount, from, base);
            const safeConverted = isNaN(converted) ? 0 : converted;

            const textElem = document.getElementById('exchangeHint');
            if (textElem) {
                textElem.textContent = `å³æ™‚æ›ç®— â‰ˆ ${symbol}${safeConverted.toFixed(2)} (${base})`;

            }
        }



        // é‡‘é¡è¼¸å…¥æ¬„
        document.getElementById('modal_amount').addEventListener('input', updateExchangePreview);

        // å¹£åˆ¥ä¸‹æ‹‰æ¬„
        document.getElementById('modal_currency').addEventListener('change', updateExchangePreview);


        document.getElementById('modalCopyBtn').onclick = function () {
            const id = parseInt(document.getElementById('modal_id').value);
            const t = getTransactionById(id);
            if (!t) return;

            const copy = {
                ...t,
                id: Date.now(),
                date: new Date().toISOString().split('T')[0]
            };

            TRANSACTIONS.unshift(copy);
            saveToLocalStorage();
            renderTransactionList();
            closeModal();
        };

        // --------------------------- äº‹ä»¶ç¶å®š ---------------------------

        // Hotspot æ¼¸å±¤è·Ÿéš¨æ»‘é¼ ç§»å‹•æ•ˆæœ åŠ äº‹ä»¶ç¶å®š
        document.addEventListener('DOMContentLoaded', () => {
            // --------------------------- New: æ‡¸æµ®æŒ‰éˆ• (FAB) é‚è¼¯ ---------------------------
            const fabContainer = document.getElementById('fabContainer');
            const mainFab = document.getElementById('mainFab');
            const fabIncomeBtn = document.getElementById('fabIncomeBtn');
            const fabExpenseBtn = document.getElementById('fabExpenseBtn');

            // å°èˆªå‡½å¼ï¼Œç”¨æ–¼è™•ç† FAB é»æ“Š
            function navigateToRecordPage(type) {
                // å¸¶ä¸Š type åƒæ•¸åˆ° recordpage.htmlï¼Œä¾‹å¦‚: recordpage.html?type=income
                const targetUrl = `recordpage.html?type=${type}`;
                
                if (window.parent && typeof window.parent.switchPage === 'function') {
                    // å‘¼å«çˆ¶å±¤çš„ switchPage é€²è¡Œé é¢åˆ‡æ›
                    window.parent.switchPage(null, targetUrl);
                } else {
                    // Fallbackï¼šç›´æ¥è·³è½‰
                    console.warn(`Parent switchPage not found. Falling back to direct page load: ${targetUrl}`);
                    window.location.href = targetUrl;
                }
            }

            // 1. ç¶å®šä¸»æŒ‰éˆ•é»æ“Šäº‹ä»¶ (é–‹/é—œå­æŒ‰éˆ•)
            mainFab.addEventListener('click', () => {
                fabContainer.classList.toggle('open');
            });

            // 2. ç¶å®šé¸é …æŒ‰éˆ•é»æ“Šäº‹ä»¶ (å°èˆªåˆ° recordpage.html ä¸¦å¸¶ä¸Šé¡å‹)
            fabIncomeBtn.addEventListener('click', () => {
                navigateToRecordPage('income');
            });

            fabExpenseBtn.addEventListener('click', () => {
                navigateToRecordPage('expense');
            });
            // --------------------------- End: æ‡¸æµ®æŒ‰éˆ• (FAB) é‚è¼¯ ---------------------------

            // é¸æ“‡æ‰€æœ‰ä½¿ç”¨æ–°æ¨£å¼çš„æŒ‰éˆ•
            const addButtons = document.querySelectorAll('.add-button');
            if (addButtons.length === 0) return;

            addButtons.forEach(addButton => {
                // 1. ç¶å®š Hotspot æ•ˆæœ (æ»‘é¼ ç§»å‹•æ™‚ï¼Œæ›´æ–° CSS è®Šæ•¸)
                addButton.addEventListener('mousemove', (e) => {
                    const rect = addButton.getBoundingClientRect();
                    // è¨ˆç®—æ»‘é¼ åœ¨æŒ‰éˆ•å…§çš„ç™¾åˆ†æ¯”ä½ç½® (0 ~ 100%)
                    const x = (e.clientX - rect.left) / rect.width * 100;
                    const y = (e.clientY - rect.top) / rect.height * 100;
                    // â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šç›´æ¥è¨­ç½® CSS è®Šæ•¸ï¼Œæ§åˆ¶å¾‘å‘æ¼¸å±¤çš„ä¸­å¿ƒé»
                    addButton.style.setProperty('--mouse-x', `${x}%`);
                    addButton.style.setProperty('--mouse-y', `${y}%`);
                });
            });

            loadReceiptImages();
            // é é¢è¼‰å…¥æ™‚å…ˆæ¸²æŸ“ä¸€æ¬¡åˆ—è¡¨
            renderTransactionList();
        });

        // ç¶å®š Modal æŒ‰éˆ•äº‹ä»¶ (ä¿ç•™ä¸è®Š)
        document.getElementById('modalCloseBtn').addEventListener('click', closeModal);

        document.getElementById('editForm').addEventListener('submit', saveModalChanges);

        // â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šé»æ“Šç„¡è³‡æ–™æŒ‰éˆ•æ™‚ï¼Œå‘¼å«çˆ¶æ¡†æ¶çš„ switchPageï¼Œä¸¦å¢åŠ ç›´æ¥è·³è½‰çš„ fallback
        document.getElementById('addFirstTransactionBtn').addEventListener('click', function() {
            if (window.parent && typeof window.parent.switchPage === 'function') {
                // å‘¼å«çˆ¶å±¤çš„ switchPage(element=null, url='recordpage.html')
                // ç¢ºä¿èª¿ç”¨æ™‚ï¼Œç¬¬äºŒå€‹åƒæ•¸å‚³éç›®æ¨™ URL
                window.parent.switchPage(null, 'recordpage.html');
            } else {
                // Fallbackï¼šå¦‚æœæ²’æœ‰çˆ¶æ¡†æ¶æˆ– switchPageï¼Œå‰‡ç›´æ¥è·³è½‰
                console.warn('Parent switchPage not found. Falling back to direct page load.');
                window.location.href = 'recordpage.html';
            }
        });

    </script>
</html>