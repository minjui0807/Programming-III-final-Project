<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ é ç®—æ§åˆ¶ä¸­å¿ƒ | LumiTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-secondary: #1e1e1e;
            --neon-blue: #a7d7ff;
            --neon-pink: #ffb3cf;
            --neon-green: #a8f0c6;
            --neon-yellow: #fff1a6;
            --neon-red: #ff7f7f;
            --text-light: #e6e6e6;
            --text-dark: #b8b8b8;
            --border-color: #2a2a2a;

            
            --cat-1: #ff7f7f;
            --cat-2: #ffcc66;
            --cat-3: #a8f0c6;
            --cat-4: #a7d7ff;
            --cat-5: #ffb3cf;
            --cat-6: #cf9cff;
            --cat-7: #66ffcc;
            --cat-8: #ff9c66;
            --cat-9: #99ccff;
            --cat-10: #d4d4d4;
            --cat-11: #ffd1dc;
            --cat-12: #ffe066;
            --cat-13: #8affc1;
            --cat-14: #8ed1ff;
            --cat-15: #c9a7ff;
            --cat-16: #ffb380;
            --cat-17: #b3ffb3;
            --cat-18: #b3d9ff;
            --cat-19: #ffe6b3;
            --cat-20: #ffadad;
        }

        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        body { margin:0; padding:20px; background:var(--bg-dark); font-family:'Segoe UI', sans-serif; color:var(--text-light); }
        .container { max-width: 900px; margin:auto; padding-bottom:80px; }

        .page-title { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); font-size:1.8em; margin-bottom:25px; display:flex; align-items:center; gap:12px; }

        .total-budget-card { background: linear-gradient(145deg,#1e1e1e,#252525); padding:25px; border-radius:20px; margin-bottom:30px; text-align:center; border:1px solid var(--border-color); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .total-title { color: var(--text-dark); font-size:1rem; }
        .total-amount { font-size:2.6rem; font-weight:bold; margin:15px 0; transition: color 0.3s; }

        .progress-container { background: rgba(255,255,255,0.1); height:18px; border-radius:9px; overflow:hidden; margin:10px 0; }
        .progress-fill { height:100%; width:0%; transition: width 0.8s cubic-bezier(0.34,1.56,0.64,1), background-color 0.3s; }
        .progress-text { display:flex; justify-content:space-between; color: var(--text-dark); font-size:0.9em; }

        .budget-list { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); gap:20px; }
        .budget-card { background: var(--bg-secondary); padding:20px; border-radius:16px; border:1px solid var(--border-color); transition: transform 0.2s, background 0.2s; }
        .main-budget-card { cursor:pointer; }
        .main-budget-card:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); }

        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .cat-info { display:flex; gap:12px; align-items:center; }
        .cat-icon { width:40px; height:40px; border-radius:50%; background: rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; font-size:1.2rem; }
        .cat-name { font-weight:bold; }
        .expand-icon { transition: transform 0.3s; font-size:0.8em; margin-left:5px; color: var(--text-dark); }
        .expanded .expand-icon { transform: rotate(180deg); }

        .budget-setter { text-align:right; }
        .budget-label { font-size:0.75rem; color: var(--text-dark); margin-bottom:2px; }
        .budget-display { font-size:1.1rem; cursor:pointer; transition: color 0.2s; font-weight:500; }
        .budget-display:hover { color: var(--neon-yellow); text-decoration:underline; }
        .budget-input { display:none; width:90px; background:#000; color:#fff; border:1px solid var(--neon-blue); padding:5px; border-radius:6px; text-align:right; font-size:1rem; outline:none; box-shadow:0 0 10px rgba(167,215,255,0.3); }

        .card-stats { display:flex; justify-content:space-between; margin-top:10px; font-size:0.85em; color: var(--text-dark); }
        .sub-category-container { display:none; margin-left:15px; padding-left:15px; border-left:1px dashed #444; margin-top:10px; }
        .sub-category-container.active { display:block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-5px);} to { opacity:1; transform:translateY(0);} }

        .toast { position: fixed; bottom:30px; left:50%; transform:translateX(-50%); background: var(--neon-green); color:#000; padding:10px 25px; border-radius:30px; font-weight:bold; opacity:0; transition:0.3s; z-index:1000; box-shadow:0 5px 15px rgba(0,0,0,0.3);}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title"><i class="fas fa-shield-alt"></i> é ç®—æ§åˆ¶ä¸­å¿ƒ</h1>

        <div class="total-budget-card">
            <div class="total-title" id="monthTitle">æœ¬æœˆå‰©é¤˜é ç®—</div>
            <div class="total-amount" id="totalRemaining">---</div>
            <div class="progress-container"><div class="progress-fill" id="totalBar"></div></div>
            <div class="progress-text"><span id="totalSpentText">å·²èŠ± ---</span><span id="totalBudgetText">ç¸½é ç®— ---</span></div>
        </div>

        <div class="budget-list" id="budgetList"></div>
        <div id="noBudgetMsg" style="text-align:center;color:var(--text-dark);padding:50px 0;display:none;">
            <i class="fas fa-receipt fa-3x" style="color:var(--neon-pink);margin-bottom:15px;"></i>
            <h3>å°šæœªè¨­å®šåˆ†é¡æˆ–é ç®—</h3>
            <p>é»æ“Šä¸Šæ–¹åˆ†é¡é‡‘é¡å³å¯é–‹å§‹è¨­å®šé ç®—</p>
        </div>
    </div>

    <div class="toast" id="toast">âœ… é ç®—å·²æ›´æ–°</div>

</body>

    <script>
        /* ================= å¹£åˆ¥ç³»çµ±ï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰ ================= */
        const FIXED_RATES = {
            TWD:1, USD:0.032, JPY:4.6, EUR:0.029, HKD:0.24,
            CNY:0.22, GBP:0.024, AUD:0.046, KRW:41.5, SGD:0.041
        };
        const SYMBOL_MAP = {
            TWD:'NT$', USD:'$', JPY:'Â¥', EUR:'â‚¬', HKD:'HK$',
            CNY:'Â¥', GBP:'Â£', AUD:'A$', KRW:'â‚©', SGD:'S$'
        };

        function getCurrencySetting(){
            return JSON.parse(localStorage.getItem('app_currency')) || { base:'TWD' };
        }

        function fromTWD(amountTWD){
            const { base } = getCurrencySetting();
            return amountTWD * (FIXED_RATES[base] || 1);
        }

        function money(n){
            const { base } = getCurrencySetting();
            return `${SYMBOL_MAP[base] || '$'}${Math.round(n).toLocaleString()}`;
        }

        /* ================= ä¸»æ¸²æŸ“ ================= */
        function renderBudget(){
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            const categoryData = JSON.parse(localStorage.getItem('categoryData')) || { expense:[] };
            const budgetSettings = JSON.parse(localStorage.getItem('budget_settings')) || {};

            const now = new Date();
            const m = now.getMonth(), y = now.getFullYear();
            document.getElementById('monthTitle').textContent = `${m+1} æœˆå‰©é¤˜é ç®—`;

            let totalBudget = 0;
            let totalSpent = 0;
            const list = document.getElementById('budgetList');
            list.innerHTML = '';

            categoryData.expense.forEach((mainCat,idx)=>{
                // ===== åˆ¤æ–·æ˜¯å¦æœ‰å­åˆ†é¡é ç®— =====
                const subBudgets = (mainCat.sub || []).map(sub=>{
                const k = `${mainCat.name} / ${sub.name}`;
                return budgetSettings[k] || 0;
                });

                const hasSubBudget = subBudgets.some(v => v > 0);

                // ===== ä¸»åˆ†é¡é ç®—ï¼ˆTWDï¼‰ =====
                let budgetTWD = 0;

                if(hasSubBudget){
                // ğŸ‘‰ æœ‰å­åˆ†é¡ â†’ å¼·åˆ¶åŠ ç¸½
                budgetTWD = subBudgets.reduce((a,b)=>a+b,0);
                }else{
                // ğŸ‘‰ æ²’å­åˆ†é¡ â†’ å…è¨±ä¸»åˆ†é¡è¨­å®š
                budgetTWD = budgetSettings[mainCat.name] || 0;
                }

                const budget = fromTWD(budgetTWD);


                /* ===== å·²èŠ±ï¼ˆåªç”¨ baseAmountï¼‰ ===== */
                const spentTWD = transactions
                .filter(t=>{
                    if(t.type!=='expense') return false;
                    const d = new Date(t.date);
                    if(d.getMonth()!==m || d.getFullYear()!==y) return false;
                    const main = (t.categoryText || '').split(' / ')[0];
                    return main === mainCat.name;
                })
                .reduce((sum,t)=>sum + (Number(t.baseAmount)||0),0);

                const spent = fromTWD(spentTWD);

                totalBudget += budget;
                totalSpent += spent;

                /* ===== å­åˆ†é¡ ===== */
                let subHtml = '';
                if(mainCat.sub?.length){
                    mainCat.sub.forEach(sub=>{
                        const key = `${mainCat.name} / ${sub.name}`;
                        const subBudget = fromTWD(budgetSettings[key]||0);

                        const subSpentTWD = transactions
                        .filter(t=>t.categoryText===key)
                        .reduce((s,t)=>s+(Number(t.baseAmount)||0),0);

                        const subKey = `${mainCat.name} / ${sub.name}`;

                        subHtml += createCard(
                            sub.name,
                            subBudget,
                            fromTWD(subSpentTWD),
                            sub.color,
                            sub.icon,
                            true,
                            null,
                            false,
                            subKey
                        );
                    });
                }

                list.insertAdjacentHTML('beforeend',`
                <div class="category-group">
                    ${createCard(
                            mainCat.name,
                            budget,
                            spent,
                            mainCat.color,
                            mainCat.icon,
                            false,
                            idx,
                            !!subHtml,
                            mainCat.name,
                            hasSubBudget   // ğŸ‘ˆ æ–°å¢
                        )

                    }
                    <div id="sub-${idx}" class="sub-category-container">${subHtml}</div>
                </div>
                `);
            });

            updateTotal(totalBudget,totalSpent);
        }

        /* ================= å¡ç‰‡ï¼ˆæ²¿ç”¨åŸç‰ˆå‹ï¼‰ ================= */
        function createCard( name, budget, spent, color, icon,  isSub, idx, hasSub, key, lockMain){
            const p = budget>0 ? Math.min(100,(spent/budget)*100) : 0;
            const bar = p>=100?'var(--neon-red)':p>80?'var(--neon-yellow)':'var(--neon-green)';

            return `
                <div class="budget-card ${!isSub?'main-budget-card':''}"
                ${!isSub&&hasSub?`onclick="toggleSub(${idx})"`:''}
                style="border-left:4px solid ${color}">
                <div class="card-header">
                    <div class="cat-info">
                    <i class="${icon}" style="color:${color}"></i>
                    <span class="cat-name">${name}</span>
                    </div>

                    <div class="budget-setter" onclick="event.stopPropagation()">
                    <div class="budget-label">é ç®—</div>
                    <div class="budget-display"
                        ${lockMain ? 'style="opacity:.5;cursor:not-allowed"' : 'onclick="editBudget(this)"'}>
                        ${budget?money(budget):(lockMain?'â€”':'é»æ“Šè¨­å®š')}
                    </div>
                    <input class="budget-input"
                            type="number"
                            min="0"
                            onblur="saveBudget(this,'${key}')"
                            onkeydown="if(event.key==='Enter') this.blur()">
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-fill" style="width:${p}%;background:${bar}"></div>
                </div>

                <div class="card-stats">
                    <span>å·²èŠ± ${money(spent)}</span>
                    <span>${p.toFixed(0)}%</span>
                </div>
                </div>
            `;
        }

        /* ================= ç¸½è¨ˆ ================= */
        function updateTotal(budget, spent){
            const remain = budget - spent;
            const p = budget > 0 ? Math.min(100, (spent / budget) * 100) : 0;

            const bar = document.getElementById('totalBar');

            document.getElementById('totalRemaining').textContent = money(remain);
            document.getElementById('totalRemaining').style.color =
                remain >= 0 ? 'var(--neon-green)' : 'var(--neon-red)';

            document.getElementById('totalSpentText').textContent = `å·²èŠ± ${money(spent)}`;
            document.getElementById('totalBudgetText').textContent = `ç¸½é ç®— ${money(budget)}`;

            /* â­ é€²åº¦æ¢é¡è‰² */
            bar.style.width = `${p}%`;
            bar.style.background =
                p >= 100 ? 'var(--neon-red)' :
                p > 80  ? 'var(--neon-yellow)' :
                        'var(--neon-green)';
        }


        /* ================= å±•é–‹ ================= */
        function toggleSub(i){
            document.getElementById(`sub-${i}`)?.classList.toggle('active');
        }

        /* ================= åŒæ­¥ ================= */
        window.addEventListener('storage',e=>{
            if(['transactions','budget_settings','categoryData','app_currency'].includes(e.key)){
                renderBudget();
            }
        });
        document.addEventListener('DOMContentLoaded',renderBudget);

        function editBudget(el,key){
            const wrap = el.closest('.budget-setter');
            const input = wrap.querySelector('.budget-input');

            const raw = el.textContent.replace(/[^\d]/g,'');
            input.value = raw ? Number(raw) : '';
            el.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
        }

        function saveBudget(input,key){
            const wrap = input.closest('.budget-setter');
            const display = wrap.querySelector('.budget-display');
            const val = Number(input.value);

            input.style.display = 'none';
            display.style.display = 'block';

            if(isNaN(val) || val<=0){
                display.textContent = 'é»æ“Šè¨­å®š';
                return;
            }

            // âš ï¸ é¡¯ç¤ºå¹£åˆ¥ â†’ è½‰å› TWD å­˜
            const { base } = getCurrencySetting();
            const rate = FIXED_RATES[base] || 1;
            const twdAmount = Math.round(val / rate);

            const settings = JSON.parse(localStorage.getItem('budget_settings')) || {};
            settings[key] = twdAmount;
            localStorage.setItem('budget_settings',JSON.stringify(settings));

            showToast();
            renderBudget();
        }

        function saveBudget(input, key){
            const raw = input.value.trim();
            const settings = JSON.parse(localStorage.getItem('budget_settings')) || {};

            if(raw === '' || isNaN(raw) || Number(raw) <= 0){
                // â­ æ¸…ç©º = åˆªé™¤
                delete settings[key];
            }else{
                // â­ ä¸€å¾‹å­˜ TWD
                const { base } = getCurrencySetting();
                const rate = FIXED_RATES[base] || 1;
                settings[key] = Number(raw) / rate;
            }

            localStorage.setItem('budget_settings', JSON.stringify(settings));

            input.style.display = 'none';
            input.previousElementSibling.style.display = 'block';

            renderBudget();

            const toast = document.getElementById('toast');
            toast.style.opacity = 1;
            setTimeout(()=>toast.style.opacity=0,1200);
        }


        function showToast(){
            const t = document.getElementById('toast');
            t.style.opacity = 1;
            setTimeout(()=>t.style.opacity=0,1500);
        }

    </script>

</html>
