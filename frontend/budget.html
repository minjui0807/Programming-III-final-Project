<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ é ç®—æ§åˆ¶ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --------------------------- å…¨åŸŸèˆ‡éœ“è™¹è®Šæ•¸ (çµ±ä¸€ç‰ˆæœ¬) --------------------------- */
        :root {
            --bg-dark: #0f1115;                      /* ä¸»è¦èƒŒæ™¯è‰² (æœ€æ·±) */
            --bg-secondary: #1e1e1e;                 /* æ¬¡è¦èƒŒæ™¯è‰² (ç”¨æ–¼å¡ç‰‡/è¡¨å–®) */

            --neon-blue: #a7d7ff;                    /* éœ“è™¹è— (ä¸»è¦é€£çµ/æ”¶å…¥) */
            --neon-pink: #ffb3cf;                    /* éœ“è™¹ç²‰ (æ”¯å‡º/å‰¯è‰²) */
            --neon-green: #a8f0c6;                   /* å„²å­˜/é ç®—ç¶  */
            --neon-yellow: #fff1a6;                  /* å¼·èª¿è‰²/è­¦ç¤º */
            --neon-red: #ff7f7f;                     /* åˆªé™¤/å±éšª */

            --text-light: #e6e6e6;                   /* æ–‡å­—æ·ºè‰² */
            --text-dark: #b8b8b8;                    /* æ–‡å­—æ·±è‰² */
            --border-color: #2a2a2a;                 /* é‚Šæ¡†é¡è‰² */

            /* åˆ†é¡é¡è‰²è®Šæ•¸ (å¯æ ¹æ“šæ‚¨çš„éœ€æ±‚èª¿æ•´) */
            --cat-1: #ff7f7f;
            --cat-2: #ffcc66;
            --cat-3: #a8f0c6;
            --cat-4: #a7d7ff;
            --cat-5: #ffb3cf;
            --cat-6: #cf9cff;
            --cat-7: #66ffcc;
            --cat-8: #ff9c66;
            --cat-9: #99ccff;
            --cat-10: #d4d4d4;
            --cat-11: #ffd1dc;
            --cat-12: #ffe066;
            --cat-13: #8affc1;
            --cat-14: #8ed1ff;
            --cat-15: #c9a7ff;
            --cat-16: #ffb380;
            --cat-17: #b3ffb3;
            --cat-18: #b3d9ff;
            --cat-19: #ffe6b3;
            --cat-20: #ffadad;
        }

        /* çµ±ä¸€çš„éœ“è™¹æ¨£å¼ */
        .neon-text {
            text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue);
            transition: text-shadow 0.3s;
        }
        .neon-pink-text {
            text-shadow: 0 0 5px var(--neon-pink), 0 0 10px var(--neon-pink);
            transition: text-shadow 0.3s;
        }
        .neon-shadow {
            box-shadow: 0 0 10px rgba(167, 215, 255, 0.3), 0 0 20px rgba(167, 215, 255, 0.1);
            transition: box-shadow 0.3s;
        }
        /* Active ç‹€æ…‹æŒ‰éˆ•çš„éœ“è™¹å…‰æšˆ */
        .active-neon-glow {
            box-shadow: 0 0 8px var(--neon-blue), 0 0 15px var(--neon-blue)50;
            border-color: var(--neon-blue) !important;
        }

        /* çµ±ä¸€ Font-Awesome åœ–æ¨™æ¨£å¼ */
        .fa, .fas, .far, .fab {
            margin-right: 5px;
        }

        body{
            margin:0;
            padding:20px;
            background:var(--bg-dark);
            font-family:'Segoe UI',sans-serif;
            color:var(--text-light);
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox (é›–ç„¶æ‚¨ä¸»è¦ä½¿ç”¨çš„æ˜¯ Webkit/MSï¼Œä½†çµ±ä¸€åŠ ä¸Š) */
        }

        /* --------------------------- éš±è—æ»¾å‹•æ¢ï¼šWebkit æ ¸å¿ƒç€è¦½å™¨ (Chrome, Safari) --------------------------- */
        /* é‡å°æ•´å€‹ body å…ƒç´  */
        body::-webkit-scrollbar {
            width: 0px;  /* éš±è—å‚ç›´æ»¾å‹•æ¢ */
            height: 0px; /* éš±è—æ°´å¹³æ»¾å‹•æ¢ */
        }

        body::-webkit-scrollbar,
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        /* 1. é‡å°æ‰€æœ‰å…ƒç´ ï¼ˆåŒ…å« body å’Œæ‰€æœ‰ divï¼‰éš±è—æ»¾å‹•æ¢ï¼Œä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ */
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
        }

        *::-webkit-scrollbar {
            display: none;             /* Chrome, Safari, Opera */
            width: 0 !important;
            height: 0 !important;
        }

        /* 2. ç¢ºä¿ html å’Œ body ä¹Ÿå®Œå…¨éš±è— */
        html, body {
            overflow: -moz-scrollbars-none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        /* é‡å°éœ€è¦æ»¾å‹•çš„ç‰¹å®šå®¹å™¨ (å¦‚ä¸»è¦çš„å…§å®¹å€å¡Š) */
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        .container{max-width:900px;margin:auto;padding-bottom:80px;}

        h2{
            color:var(--neon-green);
            border-bottom:2px solid var(--bg-secondary);
            padding-bottom:12px;
            margin-bottom:25px;
            display:flex;
            align-items:center;
            gap:12px;
        }

        /* budget.html: ä¿®æ­£ .page-title */
        .page-title {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            font-size: 1.8em;
            margin-bottom: 25px;
            padding-left: 10px;
        }

        /* budget.html: çµ±ä¸€ card æ¨£å¼ */
        .budget-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 1em; /* çµ±ä¸€å¡ç‰‡å…§æ–‡å­—é«”å¤§å° */
        }

        /* budget.html: é€²åº¦æ¢æ–‡å­—å¤§å° */
        .progress-text {
            font-size: 0.95em;
            font-weight: 500;
        }

        /* -------- ç¸½è¦½ -------- */
        .total-budget-card{
            background:linear-gradient(145deg,#1e1e1e,#252525);
            padding:25px;
            border-radius:20px;
            margin-bottom:30px;
            text-align:center;
        }
        .total-title{color:var(--text-dark);}
        .total-amount{font-size:2.6rem;font-weight:bold;margin:15px 0;}

        .progress-container{
            background:rgba(255,255,255,0.1);
            height:22px;
            border-radius:11px;
            overflow:hidden;
        }
        .progress-fill{
            height:100%;
            width:0%;
            transition:.5s;
            /* é€™è£¡ä¸å†ä½¿ç”¨ status-safe/warning/danger é¡ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ JS ä¸­è¨­å®šèƒŒæ™¯è‰² */
        }
        .progress-text{
            display:flex;
            justify-content:space-between;
            margin-top:8px;
            color:var(--text-dark);
        }

        /* ç‹€æ…‹ */
        .status-safe{background:var(--neon-green);}
        .status-warning{background:var(--neon-yellow);}
        .status-danger{background:var(--neon-red);}
        .text-safe{color:var(--neon-green);}
        .text-warning{color:var(--neon-yellow);}
        .text-danger{color:var(--neon-red);}

        /* -------- åˆ†é¡å¡ç‰‡ -------- */
        .budget-list{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
            gap:20px;
        }
        .budget-card{
            background:var(--bg-secondary);
            padding:20px;
            border-radius:16px;
        }
        .card-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:12px;
        }
        .cat-info{display:flex;gap:12px;align-items:center;}
        .cat-icon{
            width:42px;height:42px;
            border-radius:50%;
            background:rgba(255,255,255,0.1);
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .cat-name{font-size:1.25rem;font-weight:bold;}

        .budget-setter{
            text-align:right;
            cursor:pointer;
        }
        .budget-label{font-size:.8rem;color:var(--text-dark);}
        .budget-display{font-size:1.1rem;color:var(--neon-yellow);}
        .budget-input{
            display:none;
            width:90px;
            background:#000;
            color:#fff;
            border:1px solid #555;
            padding:4px;
            text-align:right;
        }

        .card-stats{
            display:flex;
            justify-content:space-between;
            margin-top:8px; /* èª¿æ•´ç‚º card-statsï¼Œå› ç‚ºé€²åº¦æ¢å¾ŒåŸæœ¬æœ‰ progress-text */
            color:var(--text-dark);
        }

        .toast{
            position:fixed;
            bottom:30px;
            left:50%;
            transform:translateX(-50%);
            background:var(--neon-green);
            color:#000;
            padding:10px 20px;
            border-radius:20px;
            font-weight:bold;
            opacity:0;
            transition:.3s;
            z-index: 1000;
        }
    </style>

</head>

<body>
    <div class="container">
        <h1 class="page-title neon-text"><i class="fas fa-shield-alt"></i> é ç®—æ§åˆ¶ä¸­å¿ƒ</h1>

        <div class="total-budget-card">
            <div class="total-title">æœ¬æœˆç¸½é ç®—å‰©é¤˜</div>
            <div class="total-amount" id="totalRemaining">$0</div>
            <div class="progress-container">
                <div class="progress-fill" id="totalBar"></div> 
            </div>
            <div class="progress-text">
                <span id="totalSpentText">å·²èŠ± $0</span>
                <span id="totalBudgetText">ç¸½é ç®— $0</span>
            </div>
        </div>

        <div class="budget-list" id="budgetList"></div>

        <div id="noBudgetMsg" style="text-align: center; color: var(--text-dark); padding: 50px 0; display: none;">
            <i class="fas fa-hand-pointer fa-3x" style="color: var(--neon-pink); margin-bottom: 15px;"></i>
            <h3>æ²’æœ‰é ç®—æˆ–äº¤æ˜“ç´€éŒ„</h3>
            <p>è«‹åˆ° <a href="#" onclick="if (window.parent && typeof window.parent.switchPage === 'function') { window.parent.switchPage(null, 'settings.html'); }">è¨­å®šé é¢</a> æˆ– <a href="#" onclick="if (window.parent && typeof window.parent.switchPage === 'function') { window.parent.switchPage(null, 'recordpage.html'); }">è¨˜å¸³é é¢</a> è¨­å®šåˆ†é¡å¾Œï¼Œç›´æ¥åœ¨ä¸‹æ–¹åˆ†é¡è¨­å®šé ç®—ã€‚</p>
        </div>


    </div>

    <div class="toast" id="toast">å·²æ›´æ–°é ç®—</div>

</body>

<script>
/* ===============================
Budget Page - JS
=============================== */

const TRANSACTION_STORAGE_KEY = 'transactions';
const BUDGET_STORAGE_KEY = 'budget_settings';
const CATEGORY_STORAGE_KEY = 'categoryData';

// ---------- é è¨­åˆ†é¡ï¼ˆåƒ…æœ¬é åˆå§‹åŒ–ç”¨ï¼‰ ----------
function getDefaultCategoriesForBudget() {
    return {
        expense: [
            { id: 1, name: "é¤é£²", icon: "fas fa-utensils", color: "#ff7f7f", sub: [] },
            { id: 2, name: "äº¤é€š", icon: "fas fa-bus", color: "#ffcc66", sub: [] },
            { id: 3, name: "è³¼ç‰©", icon: "fas fa-shopping-bag", color: "#a8f0c6", sub: [] },
            { id: 4, name: "å¨›æ¨‚", icon: "fas fa-gamepad", color: "#a7d7ff", sub: [] },
            { id: 5, name: "å±…ä½", icon: "fas fa-home", color: "#ffb3cf", sub: [] }
        ],
        income: []
    };
}

// ---------- Storage Helpers ----------
function getTransactions() {
    return JSON.parse(localStorage.getItem(TRANSACTION_STORAGE_KEY) || '[]');
}
function getBudgetSettings() {
    return JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}');
}
function getCategoryData() {
    let data = JSON.parse(localStorage.getItem(CATEGORY_STORAGE_KEY) || '{"expense":[],"income":[]}');
    // å¦‚æœ localStorage æ²’æœ‰æ”¯å‡ºåˆ†é¡ï¼Œä½¿ç”¨é è¨­åˆ†é¡ï¼ˆä¸æ”¹ localStorageï¼‰
    if(!data.expense || data.expense.length === 0) data = getDefaultCategoriesForBudget();
    return data;
}
function saveBudgetSettings(settings) {
    localStorage.setItem(BUDGET_STORAGE_KEY, JSON.stringify(settings));
}

// ---------- Render Budget ----------
function renderBudget() {
    const TRANSACTIONS = getTransactions();
    const BUDGET_SETTINGS = getBudgetSettings();
    const CATEGORY_DATA = getCategoryData();

    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const expenseCategories = CATEGORY_DATA.expense || [];

    // ç¯©é¸æœ¬æœˆæ”¯å‡º
    const monthlyTransactions = TRANSACTIONS.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear && t.type === 'expense';
    });

    // è¨ˆç®—å·²èŠ±è²»é‡‘é¡ï¼ˆæŒ‰ä¸»åˆ†é¡ï¼‰
    const actualExpense = monthlyTransactions.reduce((acc, t) => {
        let mainCatName = t.categoryObject?.primary?.name || t.categoryText?.split(' / ')[0] || 'æœªåˆ†é¡';
        const amount = parseFloat(t.amount) || 0;
        acc[mainCatName] = (acc[mainCatName] || 0) + amount;
        return acc;
    }, {});

    // æº–å‚™é¡¯ç¤ºè³‡æ–™
    let displayCategories = {};
    let totalBudget = 0;
    let totalSpent = 0;

    expenseCategories.forEach(mainCat => {
        const name = mainCat.name;
        if(displayCategories[name]) {
            renderCard(name, displayCategories[name]);
        }
        displayCategories[name] = {
            spent: actualExpense[name] || 0,
            budget: BUDGET_SETTINGS[name] || 0,
            icon: mainCat.icon || 'fas fa-tag',
            color: mainCat.color || '#ffb3cf'
        };
    });

    // åŠ å…¥å·²è¨­å®šé ç®—ä½†åˆ†é¡ä¸åœ¨ expenseCategories çš„ä¸»åˆ†é¡
    Object.keys(BUDGET_SETTINGS).forEach(cat => {
        if (!displayCategories[cat]) {
            displayCategories[cat] = {
                spent: actualExpense[cat] || 0,
                budget: BUDGET_SETTINGS[cat],
                icon: 'fas fa-tag',
                color: 'var(--neon-yellow)'
            };
        }
    });

    const activeCategories = Object.keys(displayCategories).filter(cat => {
        const item = displayCategories[cat];
        // åªç¯©æ‰å®Œå…¨æ²’æœ‰é ç®—ä¹Ÿæ²’æœ‰äº¤æ˜“çš„
        return item.budget !== undefined; // æˆ– item.budget>=0
    });

    const container = document.getElementById('budgetList');
    const noData = document.getElementById('noBudgetMsg');

    if (!container) return;

    if (activeCategories.length === 0) {
        container.innerHTML = expenseCategories.length > 0 ? expenseCategories.map(mainCat => {
            const name = mainCat.name;
            const color = mainCat.color || '#ffb3cf';
            const icon = mainCat.icon || 'fas fa-tag';
            return `
                <div class="budget-card">
                    <div class="card-header">
                        <div class="cat-info">
                            <span class="cat-icon" style="color: ${color};"><i class="${icon}"></i></span>
                            <span class="cat-name" style="color: ${color};">${name}</span>
                        </div>
                        <div class="budget-setter" onclick="editBudget(this)">
                            <div class="budget-label">æœ¬æœˆé ç®—</div>
                            <div class="budget-display" style="color: var(--text-dark)">
                                $è¨­å®šé ç®—
                            </div>
                            <input type="number" class="budget-input" placeholder="è¼¸å…¥é‡‘é¡"
                                onblur="saveBudget(this, '${name}')"
                                onkeydown="if(event.key==='Enter') saveBudget(this, '${name}')">
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill status-safe" style="width:0%;background-color:${color};"></div>
                    </div>
                    <div class="card-stats">
                        <span class="spent-amount">å·²èŠ± $0</span>
                        <span class="spent-percent">0%</span>
                    </div>
                </div>
            `;
        }).join('') : '';
        if(noData) noData.style.display = expenseCategories.length > 0 ? 'none' : 'block';
        updateTotal(0,0);
        return;
    }

    noData && (noData.style.display='none');
    container.innerHTML = '';
    totalBudget = 0;
    totalSpent = 0;

    activeCategories.forEach(catName => {
        const item = displayCategories[catName];
        const budget = item.budget || 0;
        const spent = item.spent || 0;
        const color = item.color || '#ffb3cf';
        const icon = item.icon || 'fas fa-tag';

        totalBudget += budget;
        totalSpent += spent;

        let progress = 0;
        let statusClass = 'status-safe';
        let progressColor = color;
        if(budget>0){
            progress = Math.min(100,(spent/budget)*100);
            if(progress>=100) {statusClass='status-danger'; progressColor='var(--neon-red)';}
            else if(progress>80) {statusClass='status-warning'; progressColor='var(--neon-yellow)';}
        } else if(spent>0){
            progress = 100;
            statusClass='status-danger';
            progressColor='var(--neon-red)';
        }

        const currentBudget = budget>0 ? budget.toLocaleString() : 'è¨­å®šé ç®—';

        const listItemHtml = `
            <div class="budget-card">
                <div class="card-header">
                    <div class="cat-info">
                        <span class="cat-icon" style="color: ${color};"><i class="${icon}"></i></span>
                        <span class="cat-name" style="color: ${color};">${catName}</span>
                    </div>
                    <div class="budget-setter" onclick="editBudget(this)">
                        <div class="budget-label">æœ¬æœˆé ç®—</div>
                        <div class="budget-display" style="color: ${budget>0?'var(--neon-yellow)':'var(--text-dark)'}">
                            $${currentBudget}
                        </div>
                        <input type="number" class="budget-input" value="${budget}" 
                            placeholder="è¼¸å…¥é‡‘é¡" 
                            onblur="saveBudget(this, '${catName}')"
                            onkeydown="if(event.key==='Enter') saveBudget(this,'${catName}')">
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-fill ${statusClass}" style="width:${progress}%;background-color:${progressColor};box-shadow:0 0 5px ${progressColor}50;"></div>
                </div>
                <div class="card-stats">
                    <span class="spent-amount">å·²èŠ± $${spent.toLocaleString()}</span>
                    <span class="spent-percent">${progress.toFixed(0)}%</span>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', listItemHtml);
    });

    updateTotal(totalBudget.toLocaleString(), totalSpent.toLocaleString());
}

// ---------- æ›´æ–°ç¸½è¦½ ----------
function updateTotal(budget, spent){
    const budgetValue = parseFloat(budget.replace(/,/g,''))||0;
    const spentValue = parseFloat(spent.replace(/,/g,''))||0;
    const remaining = budgetValue-spentValue;

    const remainEl = document.getElementById('totalRemaining');
    const spentEl = document.getElementById('totalSpentText');
    const budgetEl = document.getElementById('totalBudgetText');
    const bar = document.getElementById('totalBar');

    spentEl && (spentEl.textContent=`å·²èŠ± $${spent}`);
    budgetEl && (budgetEl.textContent=`ç¸½é ç®— $${budget}`);
    if(remainEl){
        remainEl.textContent=`$${remaining.toLocaleString()}`;
        remainEl.style.color = remaining>=0?'var(--neon-green)':'var(--neon-red)';
    }

    if(bar){
        let progress = budgetValue>0 ? Math.min(spentValue/budgetValue*100,100) : 0;
        let color='var(--neon-green)';
        if(progress>=100) color='var(--neon-red)';
        else if(progress>80) color='var(--neon-yellow)';
        bar.style.width=`${progress}%`;
        bar.style.backgroundColor=color;
        bar.style.boxShadow=`0 0 10px ${color}50`;
    }
}

// ---------- ç·¨è¼¯/ä¿å­˜é ç®— ----------
function editBudget(el){
    const display = el.querySelector('.budget-display');
    const input = el.querySelector('.budget-input');
    display && (display.style.display='none');
    input && (input.style.display='block', input.focus(), input.select());
}
function saveBudget(input, cat){
    const settings = getBudgetSettings();
    if(input.value.trim()==='' || Number(input.value)<=0) delete settings[cat];
    else settings[cat] = Number(input.value);
    saveBudgetSettings(settings);

    const display = input.parentElement.querySelector('.budget-display');
    input.style.display='none';
    display && (display.style.display='block');

    showToast();
    renderBudget();
}

// ---------- Toast ----------
function showToast(){
    const t=document.getElementById('toast');
    if(!t) return;
    t.style.opacity=1;
    setTimeout(()=>t.style.opacity=0,1200);
}

// ---------- ç›£è½ localStorage / è‡ªè¨‚äº‹ä»¶ ----------
window.addEventListener('storage', (e)=>{
    if(e.key===CATEGORY_STORAGE_KEY || e.key===TRANSACTION_STORAGE_KEY) renderBudget();
});
window.addEventListener('category-updated', ()=>renderBudget());

// ---------- åˆå§‹åŒ– ----------
document.addEventListener('DOMContentLoaded', ()=>{
    renderBudget();
});
</script>


</html>