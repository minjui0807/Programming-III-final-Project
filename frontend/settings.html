<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>⚙️ 系統設定</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
/* ... (Style 保持不變) ... */
:root {
    --bg: #0f1115;
    --card-bg: #1e1e1e;
    --text: #e6e6e6;
    --text-muted: #9ca3af;
    --primary: #60a5fa;
    --border: #2a2a2a;
    --danger: #dc2626;
    --glass-blur: 8px;
}

body{
    margin:0;
    padding:20px;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    transition: background 0.3s,color 0.3s;
}

.container{
    max-width:720px;
    margin:auto;
}

h1{
    text-align:center;
    margin-bottom:30px;
    color:var(--primary);
}

.card{
    background:var(--card-bg);
    border-radius:18px;
    padding:24px;
    margin-bottom:22px;
    border:1px solid rgba(255,255,255,0.06);
    box-shadow:0 12px 28px rgba(0,0,0,0.55);
    backdrop-filter: blur(var(--glass-blur));
    transition: all 0.3s;
}

.card-title{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:1.25rem;
    font-weight:bold;
    margin-bottom:8px;
}

.card-desc{
    font-size:0.95rem;
    color:var(--text-muted);
    margin-bottom:16px;
}

.btn-group{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
}

button{
    flex:1;
    padding:10px 14px;
    border-radius:8px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--text);
    cursor:pointer;
    font-weight:600;
    transition: all 0.25s;
}

button:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(59,130,246,0.25);
}

.danger-card{
    border:1px solid var(--danger);
    background:linear-gradient(180deg, rgba(220,38,38,0.15) 0%, rgba(220,38,38,0.05) 100%);
    box-shadow:0 12px 28px rgba(220,38,38,0.35);
}

.danger-btn{
    background-color: var(--danger);
    color:#fff;
    border-color: var(--danger);
}
</style>
</head>
<body>

<div class="container">
    <h1>⚙️ 系統設定</h1>

        <div class="card action-card">
        <div class="card-title"><i class="fas fa-tags"></i> 分類管理</div>
        <div class="card-desc">前往分類管理頁面，新增、編輯支出與收入的主分類與子分類</div>
        <div class="btn-group">
            <button class="go-btn" onclick="location.href='category.html'"><i class="fas fa-arrow-right"></i> 前往分類管理</button>
        </div>
    </div>

        <div class="card">
        <div class="card-title"><i class="fas fa-file-export"></i> 資料備份與還原</div>
        <div class="card-desc">ZIP：完整備份交易、分類、預算及圖片</div>
        <div class="btn-group">
            <button onclick="exportZip()"><i class="fas fa-download"></i> 匯出 ZIP</button>
            <button onclick="document.getElementById('importZipFile').click()"><i class="fas fa-upload"></i> 匯入 ZIP</button>
            <input type="file" id="importZipFile" style="display:none" accept=".zip" />
        </div>
    </div>

        <div class="card danger-card">
        <div class="card-title"><i class="fas fa-exclamation-triangle"></i> 危險區域</div>
        <div class="card-desc">這裡的操作無法復原，請小心使用。</div>
        <div class="btn-group">
            <button class="danger-btn" onclick="clearAllData()"><i class="fas fa-trash-alt"></i> 清除所有資料</button>
        </div>
    </div>

</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const TX = 'transactions';
            const CAT = 'categoryData';
            const BUD = 'budget_settings';
            const IMG = 'receiptImages';
            // ⭐️ 關鍵修正 1：定義 transaction.html 讀取的正確 Key
            const IMGS = 'RECEIPT_IMAGES'; 

            window.clearAllData = function(){
                if(!confirm('⚠️ 確定要清除所有資料嗎？')) return;
                // 確保清除所有可能的圖片鍵
                [TX,CAT,BUD,IMG,IMGS].forEach(k=>localStorage.removeItem(k)); 
                alert('資料已清除');
                location.reload();
            };

            window.exportZip = async function(){
                const zip = new JSZip();
                const transactions = JSON.parse(localStorage.getItem(TX) || '[]');
                const categories   = JSON.parse(localStorage.getItem(CAT) || '{}');
                const budgets      = JSON.parse(localStorage.getItem(BUD) || '{}');
                // 匯出時，同時檢查新的 IMGS 鍵和舊的 IMG 鍵
                const images       = JSON.parse(localStorage.getItem(IMGS) || localStorage.getItem(IMG) || '{}');

                zip.file('data.json', JSON.stringify({transactions, categories, budgets}, null, 2));

                const imgFolder = zip.folder('images');
                Object.entries(images).forEach(([key,value])=>{
                    if(value?.startsWith('data:image')){
                        const base64 = value.split(',')[1];
                        // 修正：確保圖片副檔名正確
                        const extMatch = value.match(/^data:image\/(.+?);base64/);
                        const extension = extMatch ? extMatch[1].replace('jpeg', 'jpg') : 'jpg';

                        // 匯出時，將 key 轉回檔名
                        let filename = key;
                        if(key.startsWith('receipt_')){
                            filename = key.substring(8); // 移除 'receipt_' 前綴
                        }
                        imgFolder.file(filename+'.'+extension, base64,{base64:true});
                    }
                });

                const content = await zip.generateAsync({type:'blob'});
                saveAs(content, 'LumiTrack_backup.zip');
            };

            document.getElementById('importZipFile').addEventListener('change', async e=>{
                const file = e.target.files[0];
                if(!file) return;

                const zip = await JSZip.loadAsync(file);
                const dataFile = zip.file('data.json');
                if(!dataFile){ alert('ZIP 內缺少 data.json'); return; }

                const dataStr = await dataFile.async('string');
                const data = JSON.parse(dataStr);

                const importedTransactions = data.transactions || [];
                const importedCategories = data.categories || {};
                const importedBudgets = data.budgets || {};

                // 匯入圖片
                const imgFolder = zip.folder('images');
                const imgs = {};
                if(imgFolder){
                    const files = [];
                    imgFolder.forEach((relPath,f)=>{
                        if(!f.dir) files.push(f);
                    });
                    for(const f of files){
                        const base64 = await f.async('base64');
                        // 修正：使用 f.name 作為 key 的基礎
                        const filenameWithoutExt = f.name.replace(/\.(jpe?g|png|gif)$/i,'');
                        const key = 'receipt_'+filenameWithoutExt;

                        // 判斷圖片類型，組合成正確的 Data URI
                        let mimeType = 'image/jpeg';
                        if (f.name.match(/\.png$/i)) mimeType = 'image/png';
                        else if (f.name.match(/\.gif$/i)) mimeType = 'image/gif';
                        
                        imgs[key] = `data:${mimeType};base64,`+base64;
                    }
                }

                importedTransactions.forEach(t => {
                    // 檢查交易物件中是否有圖片檔名的參考
                    if (t.receiptImageFile) {
                        // 依照 settings.html 處理圖片的邏輯，重新組成圖片的 key
                        // 格式應為： 'receipt_' + 檔案名稱 (不含副檔名)
                        const filenameWithoutExt = t.receiptImageFile.replace(/\.(jpe?g|png|gif)$/i, '');
                        const imageKey = 'receipt_' + filenameWithoutExt;

                        // ⭐️ 關鍵修正 2：將舊的檔案名參考改成新的 Key 參考
                        if (imgs[imageKey]) {
                            t.receiptImageKey = imageKey;
                            // 由於已經設定了新的 key，舊的參考欄位可以選擇性刪除，以保持資料乾淨
                            delete t.receiptImageFile; 
                        }
                    }
                });

                // 儲存資料
                localStorage.setItem(TX, JSON.stringify(importedTransactions));
                localStorage.setItem(CAT, JSON.stringify(importedCategories));
                localStorage.setItem(BUD, JSON.stringify(importedBudgets));
                
                // ⭐️ 關鍵修正 3：確保圖片資料儲存在 IMGS 鍵中 (transaction.html 需要讀取這個鍵)
                localStorage.setItem(IMGS, JSON.stringify(imgs));
                
                alert('ZIP 還原完成，圖片已修正 key，可直接在 Modal 顯示');
                location.reload();
            });
        });
    </script>

</body>
</html>