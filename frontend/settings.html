<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>⚙️ 系統設定</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --------------------------- 全域與霓虹變數 (統一版本) --------------------------- */
        :root {
            --bg-dark: #0f1115;                      /* 主要背景色 (最深) */
            --bg-secondary: #1e1e1e;                 /* 次要背景色 (用於卡片/表單) */

            --neon-blue: #a7d7ff;                    /* 霓虹藍 (主要連結/收入) */
            --neon-pink: #ffb3cf;                    /* 霓虹粉 (支出/副色) */
            --neon-green: #a8f0c6;                   /* 儲存/預算綠 */
            --neon-yellow: #fff1a6;                  /* 強調色/警示 */
            --neon-red: #ff7f7f;                     /* 刪除/危險 */

            --text-light: #e6e6e6;                   /* 文字淺色 */
            --text-dark: #b8b8b8;                    /* 文字深色 */
            --border-color: #2a2a2a;                 /* 邊框顏色 */

            /* 分類顏色變數 (可根據您的需求調整) */
            --cat-1: #ff7f7f;
            --cat-2: #ffcc66;
            --cat-3: #a8f0c6;
            --cat-4: #a7d7ff;
            --cat-5: #ffb3cf;
            --cat-6: #cf9cff;
            --cat-7: #66ffcc;
            --cat-8: #ff9c66;
            --cat-9: #99ccff;
            --cat-10: #d4d4d4;
            --cat-11: #ffd1dc;
            --cat-12: #ffe066;
            --cat-13: #8affc1;
            --cat-14: #8ed1ff;
            --cat-15: #c9a7ff;
            --cat-16: #ffb380;
            --cat-17: #b3ffb3;
            --cat-18: #b3d9ff;
            --cat-19: #ffe6b3;
            --cat-20: #ffadad;
        }

        /* 統一的霓虹樣式 */
        .neon-text {
            text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue);
            transition: text-shadow 0.3s;
        }
        .neon-pink-text {
            text-shadow: 0 0 5px var(--neon-pink), 0 0 10px var(--neon-pink);
            transition: text-shadow 0.3s;
        }
        .neon-shadow {
            box-shadow: 0 0 10px rgba(167, 215, 255, 0.3), 0 0 20px rgba(167, 215, 255, 0.1);
            transition: box-shadow 0.3s;
        }
        /* Active 狀態按鈕的霓虹光暈 */
        .active-neon-glow {
            box-shadow: 0 0 8px var(--neon-blue), 0 0 15px var(--neon-blue)50;
            border-color: var(--neon-blue) !important;
        }

        /* 統一 Font-Awesome 圖標樣式 */
        .fa, .fas, .far, .fab {
            margin-right: 5px;
        }

        body{
            margin:0;
            padding:20px;
            background:var(--bg);
            color:var(--text-light);
            font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
            transition: background 0.3s,color 0.3s;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox (雖然您主要使用的是 Webkit/MS，但統一加上) */
        }

        /* --------------------------- 隱藏滾動條：Webkit 核心瀏覽器 (Chrome, Safari) --------------------------- */
        /* 針對整個 body 元素 */
        body::-webkit-scrollbar {
            width: 0px;  /* 隱藏垂直滾動條 */
            height: 0px; /* 隱藏水平滾動條 */
        }

        body::-webkit-scrollbar,
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        /* 針對需要滾動的特定容器 (如主要的內容區塊) */
        .content-container::-webkit-scrollbar,
        .category-list-container::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        /* 1. 針對所有元素（包含 body 和所有 div）隱藏滾動條，但保留滾動功能 */
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
        }

        *::-webkit-scrollbar {
            display: none;             /* Chrome, Safari, Opera */
            width: 0 !important;
            height: 0 !important;
        }

        /* 2. 確保 html 和 body 也完全隱藏 */
        html, body {
            overflow: -moz-scrollbars-none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        .container{
            max-width:720px;
            margin:auto;
        }

        h1{
            text-align:center;
            margin-bottom:30px;
            color:var(--primary);
        }

        /* settings.html: 修正 .page-title */
        .page-title {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            font-size: 1.8em;
            margin-bottom: 25px;
            padding-left: 10px;
        }
        /* settings.html: 統一 card 樣式 */
        .card {
            background-color: var(--card-bg); /* 使用統一的 var(--bg-secondary) */
            border: 1px solid var(--border); /* 使用統一的 var(--border-color) */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .card-title {
            font-size: 1.4em;
            color: var(--neon-blue);
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* 統一設定按鈕組樣式 */
        #currencyButtons button {
            font-size: 1em;
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        #currencyButtons button.active {
            color: var(--bg);
            background-color: var(--primary); /* 使用 var(--neon-blue) */
            /* 統一霓虹發光 */
            box-shadow: 0 0 8px var(--primary), 0 0 15px var(--primary)50;
        }

        .card{
            background:var(--card-bg);
            border-radius:18px;
            padding:24px;
            margin-bottom:22px;
            border:1px solid rgba(255,255,255,0.06);
            box-shadow:0 12px 28px rgba(0,0,0,0.55);
            backdrop-filter: blur(var(--glass-blur));
            transition: all 0.3s;
        }

        .card-title{
            display:flex;
            align-items:center;
            gap:10px;
            font-size:1.25rem;
            font-weight:bold;
            margin-bottom:8px;
        }

        .card-desc{
            font-size:0.95rem;
            color:var(--text-muted);
            margin-bottom:16px;
        }

        .btn-group{
            display:flex;
            gap:12px;
            flex-wrap:wrap;
        }

        button{
            flex:1;
            padding:10px 14px;
            border-radius:8px;
            border:1px solid var(--border);
            background:transparent;
            color:var(--text);
            cursor:pointer;
            font-weight:600;
            transition: all 0.25s;
        }

        button:hover{
            transform:translateY(-2px);
            box-shadow:0 8px 20px rgba(59,130,246,0.25);
        }

        .danger-card{
            border:1px solid var(--danger);
            background:linear-gradient(180deg, rgba(220,38,38,0.15) 0%, rgba(220,38,38,0.05) 100%);
            box-shadow:0 12px 28px rgba(220,38,38,0.35);
        }

        .danger-btn{
            background-color: var(--danger);
            color:#fff;
            border-color: var(--danger);
        }

        #currencyButtons button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
            box-shadow: 0 0 18px rgba(96,165,250,0.6);
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="page-title neon-text"><i class="fas fa-wrench"></i> 系統設定</h1>

        <div class="card action-card">
            <div class="card-title"><i class="fas fa-tags"></i> 分類管理</div>
            <div class="card-desc">前往分類管理頁面，新增、編輯支出與收入的主分類與子分類</div>
            <div class="btn-group">
                <button class="go-btn" onclick="location.href='category.html'"><i class="fas fa-arrow-right"></i> 前往分類管理</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <i class="fas fa-coins"></i> 預設貨幣</div>
            <div class="card-desc">新增交易時預設顯示的貨幣（可隨時切換）</div>

            <div class="btn-group" id="currencyButtons">
                <button data-currency="TWD">TWD</button>
                <button data-currency="USD">USD</button>
                <button data-currency="JPY">JPY</button>
                <button data-currency="EUR">EUR</button>
            </div>
        </div>


        <div class="card">
            <div class="card-title"><i class="fas fa-file-export"></i> 資料備份與還原</div>
            <div class="card-desc">ZIP：完整備份交易、分類、預算及圖片</div>
            <div class="btn-group">
                <button onclick="exportZip()"><i class="fas fa-download"></i> 匯出 ZIP</button>
                <button onclick="document.getElementById('importZipFile').click()"><i class="fas fa-upload"></i> 匯入 ZIP</button>
                <input type="file" id="importZipFile" style="display:none" accept=".zip" />
            </div>
        </div>

        <div class="card danger-card">
            <div class="card-title" style="color: var(--neon-red);"><i class="fas fa-exclamation-triangle"></i> 危險區域</div>
            <div class="card-desc">這裡的操作無法復原，請小心使用。</div>
            <div class="btn-group">
                <button class="danger-btn" onclick="clearAllData()"><i class="fas fa-trash-alt"></i> 清除所有資料</button>
            </div>
        </div>

</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const TX   = 'transactions';
            const CAT  = 'categoryData';
            const BUD  = 'budget_settings';
            const IMGS = 'receiptImages';

            /* ===============================
            清除全部資料
            =============================== */
            window.clearAllData = function(){
                if(!confirm('⚠️ 確定要清除所有資料嗎？')) return;
                [TX, CAT, BUD, IMGS].forEach(k => localStorage.removeItem(k));
                alert('資料已清除');
                location.reload();
            };

            /* ===============================
            匯出 ZIP（完整）
            =============================== */
            window.exportZip = async function(){
                const zip = new JSZip();

                const payload = {
                    meta:{
                        app:'LumiTrack',
                        version:'1.1',
                        exportedAt:new Date().toISOString()
                    },
                    transactions: JSON.parse(localStorage.getItem(TX) || '[]'),
                    categories:   JSON.parse(localStorage.getItem(CAT) || '{}'),
                    budgets:      JSON.parse(localStorage.getItem(BUD) || '{}'),
                    images:       JSON.parse(localStorage.getItem(IMGS) || '{}')
                };

                function buildCategorySummaryExcel(transactions){

                    const map = {};
                    const totalByType = { expense: 0, income: 0 };

                    transactions.forEach(t=>{
                        if(!t.amount || !t.categoryObject) return;

                        const type = t.type || 'expense';
                        const p = t.categoryObject.primary?.name || '未分類';
                        const s = t.categoryObject.sub?.name || '未分類';

                        const key = `${type}|${p}|${s}`;

                        if(!map[key]){
                            map[key] = {
                                type,
                                primary: p,
                                sub: s,
                                total: 0,
                                count: 0
                            };
                        }

                        map[key].total += Number(t.baseAmount || 0);
                        map[key].count += 1;
                        totalByType[type] += Number(t.amount);
                    });

                    const rows = [{
                        類型:'類型',
                        主分類:'主分類',
                        子分類:'子分類',
                        總金額:'總金額',
                        筆數:'筆數',
                        佔比:'佔比'
                    }];

                    Object.values(map).forEach(r=>{
                        const base = totalByType[r.type] || 1;
                        rows.push({
                            類型: r.type === 'income' ? '收入' : '支出',
                            主分類: r.primary,
                            子分類: r.sub,
                            總金額: r.total,
                            筆數: r.count,
                            佔比: ((r.total / base) * 100).toFixed(1) + '%'
                        });
                    });

                    const ws = XLSX.utils.json_to_sheet(rows, {skipHeader:true});
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '分類統計');

                    return XLSX.write(wb, {type:'array', bookType:'xlsx'});
                }


                zip.file('data.json', JSON.stringify(payload, null, 2));
                const excelArray = buildCategorySummaryExcel(payload.transactions);
                zip.file('summary_by_category.xlsx', excelArray);
                const content = await zip.generateAsync({type:'blob'});
                saveAs(content, 'LumiTrack_backup.zip');


            };

            /* ===============================
            匯入 ZIP（完整）
            =============================== */
            document.getElementById('importZipFile')
            .addEventListener('change', async e => {

                const file = e.target.files[0];
                if(!file) return;

                if(!confirm('⚠️ 匯入會覆蓋目前資料，確定繼續？')) return;

                const zip = await JSZip.loadAsync(file);
                const dataFile = zip.file('data.json');
                if(!dataFile){
                    alert('❌ ZIP 內缺少 data.json');
                    return;
                }

                const data = JSON.parse(await dataFile.async('string'));

                /* 1️⃣ 圖片（先） */
                const images =
                    data.images ||
                    JSON.parse(localStorage.getItem(IMGS) || '{}');

                localStorage.setItem(IMGS, JSON.stringify(images));

                /* 2️⃣ 交易 */
                localStorage.setItem(
                    TX,
                    JSON.stringify(data.transactions || [])
                );

                /* 3️⃣ 分類 */
                localStorage.setItem(
                    CAT,
                    JSON.stringify(data.categories || {})
                );

                /* 4️⃣ 預算 */
                localStorage.setItem(
                    BUD,
                    JSON.stringify(data.budgets || {})
                );

                alert('✅ 還原完成（交易 / 圖片 / 分類 / 預算）');
                location.reload();
            });

            const CURRENCY_KEY = 'app_currency';

            const SYMBOL_MAP = {
                TWD: 'NT$',
                USD: '$',
                JPY: '¥',
                EUR: '€'
            };

            const currencyButtons = document.querySelectorAll('#currencyButtons button');

            // 讀取目前設定（預設 TWD）
            function getCurrencySetting() {
                return JSON.parse(localStorage.getItem(CURRENCY_KEY)) || {
                    base: 'TWD',
                    symbol: 'NT$'
                };
            }

            // 儲存設定
            function setCurrencySetting(base) {
                const setting = {
                    base,
                    symbol: SYMBOL_MAP[base] || base
                };
                localStorage.setItem(CURRENCY_KEY, JSON.stringify(setting));

                // ⭐️ 主動觸發 storage（同頁也能收到）
                window.dispatchEvent(
                    new StorageEvent('storage', {
                        key: CURRENCY_KEY
                    })
                );
            }

            // 更新 UI 樣式
            function updateCurrencyUI() {
                const { base } = getCurrencySetting();
                currencyButtons.forEach(btn => {
                    btn.classList.toggle(
                        'active',
                        btn.dataset.currency === base
                    );
                });
            }

            // 點擊切換
            currencyButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const currency = btn.dataset.currency;
                    setCurrencySetting(currency);
                    updateCurrencyUI();
                });
            });

            // 初始化
            updateCurrencyUI();
        });

        window.addEventListener('storage', (e) => {
            if (e.key === 'app_currency') {
                renderTransactionList();
                renderDashboard?.();
            }
        });
    </script>


</body>
</html>