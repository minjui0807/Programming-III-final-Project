<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>âš™ï¸ ç³»çµ±è¨­å®š | LumiTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f1115;
            --bg-secondary: #1e1e1e;
            --neon-blue: #9be4ff;
            --neon-pink: #ff9ccf;
            --text-light: #e9f7ff;
            --text-dark: #c4d9ee;
        }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }
        html, body { overflow: -moz-scrollbars-none; -ms-overflow-style: none; scrollbar-width: none; }
        body { margin:0; padding:20px; background:var(--bg-dark); color:var(--text-light); font-family:system-ui,-apple-system,sans-serif; }
        .container { max-width:720px; margin:auto; }
        .page-title { color:var(--neon-blue); text-shadow:0 0 10px var(--neon-blue); font-size:1.8em; text-align:center; margin-bottom:30px; }
        .card { background:var(--bg-secondary); border-radius:18px; padding:24px; margin-bottom:22px; border:1px solid #333; box-shadow:0 12px 28px rgba(0,0,0,0.5); }
        .card-title { display:flex; align-items:center; gap:10px; font-size:1.25rem; font-weight:bold; margin-bottom:8px; color:var(--neon-blue); }
        .card-desc { font-size:0.9rem; color:var(--text-dark); margin-bottom:16px; }
        .currency-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(80px,1fr)); gap:10px; }
        button, .custom-select { padding:12px; border-radius:10px; border:1px solid #333; background:#252525; color:var(--text-light); cursor:pointer; font-weight:600; transition: all 0.3s; text-align:center; }
        button:hover { border-color:var(--neon-blue); background:#2a2a2a; }
        button.active, .custom-select.active { background:var(--neon-blue); color:#000; border-color:var(--neon-blue); box-shadow:0 0 15px var(--neon-blue); }
        .custom-select { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23a7d7ff' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; background-size:20px; padding-right:30px; outline:none; }
        .custom-select option { background:var(--bg-dark); color:#fff; }
        .btn-group { display:flex; gap:12px; flex-wrap:wrap; }
        .btn-group button { flex:1; min-width:120px; }
        .danger-card { position:relative; border:2px solid #ff3c3c !important; background:rgba(255,60,60,0.05) !important; overflow:hidden; animation: danger-pulse 2s infinite alternate; }
        @keyframes danger-pulse { from { box-shadow:0 0 10px rgba(255,127,127,0.2); } to { box-shadow:0 0 25px rgba(255,127,127,0.5); } }
        .danger-card::before { content:""; position:absolute; top:0; left:0; right:0; height:6px; background:repeating-linear-gradient(45deg,#ff7f7f,#ff7f7f 10px,#000 10px,#000 20px); }
        .danger-input-group { margin-top:15px; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px; border:1px dashed #ff3c3c; }
        .danger-input-group label { display:block; font-size:0.85rem; color:var(--neon-pink); margin-bottom:8px; }
        .danger-input-group input { width:100%; background:#151515; border:1px solid #444; padding:10px; color:#fff; border-radius:8px; font-family:monospace; text-align:center; letter-spacing:2px; box-sizing:border-box; }
        .danger-input-group input:focus { border-color:#ff3c3c; outline:none; box-shadow:0 0 8px #ff3c3c; }
        .danger-btn:disabled { filter:grayscale(1); opacity:0.3; cursor:not-allowed; box-shadow:none; }
        .danger-btn { background:transparent; border-color:#ff3c3c; color:#ff3c3c; }
        .danger-btn:hover { background:#ff3c3c; color:#fff; box-shadow:0 0 15px #ff3c3c; }
        .go-btn { background:rgba(167,215,255,0.1); color:var(--neon-blue); border-color:var(--neon-blue); }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title"><i class="fas fa-microchip"></i> æ ¸å¿ƒç³»çµ±è¨­å®š</h1>

        <div class="card">
            <div class="card-title"><i class="fas fa-sitemap"></i> åˆ†é¡æ¶æ§‹ç®¡ç†</div>
            <div class="card-desc">è‡ªå®šç¾©æ‚¨çš„æ”¶æ”¯é¡åˆ¥ï¼Œç³»çµ±å°‡è‡ªå‹•å¥—ç”¨è‡³æ‰€æœ‰å ±è¡¨ã€‚</div>
            <button class="go-btn" style="width:100%" onclick="location.href='category.html'">
                <i class="fas fa-external-link-alt"></i> é€²å…¥åˆ†é¡ç·¨è¼¯å™¨
            </button>
        </div>

        <div class="card">
            <div class="card-title"><i class="fas fa-globe"></i> åŸºæº–è²¨å¹£è¨­å®š</div>
            <div class="card-desc">é¸æ“‡ç³»çµ±çš„ä¸»è²¨å¹£ï¼Œé€™å°‡å½±éŸ¿åŒ¯ç¸½å ±è¡¨çš„é¡¯ç¤ºã€‚</div>
            <div class="currency-container" id="currencyArea">
                <button data-currency="TWD">TWD å°å¹£</button>
                <button data-currency="USD">USD ç¾é‡‘</button>
                <button data-currency="JPY">JPY æ—¥å¹£</button>
                <button data-currency="EUR">EUR æ­å…ƒ</button>
                <select id="otherCurrency" class="custom-select">
                    <option value="" disabled selected>å…¶ä»–è²¨å¹£</option>
                    <option value="HKD">HKD æ¸¯å¹£</option>
                    <option value="CNY">CNY äººæ°‘å¹£</option>
                    <option value="GBP">GBP è‹±éŠ</option>
                    <option value="AUD">AUD æ¾³å¹£</option>
                    <option value="KRW">KRW éŸ“å…ƒ</option>
                    <option value="SGD">SGD æ–°å¹£</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><i class="fas fa-cloud-download-alt"></i> æ•¸æ“šå‚™ä»½èˆ‡å°å‡º</div>
            <div class="card-desc">åŒ¯å‡ºå« Excel çµ±è¨ˆè¡¨èˆ‡å®Œæ•´æ•¸æ“šçš„ ZIP å£“ç¸®åŒ…ã€‚</div>
            <div class="btn-group">
                <button onclick="exportFullBackup()"><i class="fas fa-file-export"></i> å®Œæ•´åŒ¯å‡º (ZIP)</button>
                <button onclick="document.getElementById('importZipFile').click()"><i class="fas fa-file-import"></i> é‚„åŸå‚™ä»½</button>
                <input type="file" id="importZipFile" style="display:none" accept=".zip" />
            </div>
        </div>

        <div class="card danger-card">
            <div class="card-title" style="color:#ff3c3c">
                <i class="fas fa-biohazard"></i>  å±éšªå€åŸŸ
            </div>
            <div class="card-desc">
                åˆå§‹åŒ–å°‡æœƒæŠ¹é™¤æ‰€æœ‰äº¤æ˜“ã€è‡ªå®šç¾©åˆ†é¡ä»¥åŠé ç®—è¨­å®šã€‚æ­¤æ“ä½œä¸€æ—¦åŸ·è¡Œï¼Œå­˜å„²æ–¼ç€è¦½å™¨å…§çš„æ•¸æ“šå°‡æ¶ˆæ•£ã€‚
            </div>
            <div class="danger-input-group">
                <label>è«‹åœ¨ä¸‹æ–¹è¼¸å…¥ <b style="color:var(--text-light)">RESET</b> ä»¥è§£é™¤æŒ‰éˆ•é–å®šï¼š</label>
                <input type="text" id="confirmResetInput" placeholder="åœ¨æ­¤è¼¸å…¥..." autocomplete="off">
            </div>
            <button id="finalDeleteBtn" class="danger-btn" style="width:100%; margin-top:15px;" onclick="clearAllData()" disabled>
                <i class="fas fa-skull-crossbones"></i> åŸ·è¡Œç³»çµ±é‡ç½®
            </button>
        </div>
    </div>

    <script>
        const STORAGE_KEYS = { TX:'transactions', CAT:'categoryData', BUD:'budget_settings', IMGS:'receiptImages', CUR:'app_currency' };
        const SYMBOL_MAP = { TWD:'NT$', USD:'$', JPY:'JPÂ¥', EUR:'â‚¬', HKD:'HK$', CNY:'CNÂ¥', GBP:'Â£', AUD:'A$', KRW:'â‚©', SGD:'S$' };
        const FIXED_RATES = { TWD:1, USD:0.032, JPY:4.6, EUR:0.029, HKD:0.24, CNY:0.22, GBP:0.024, AUD:0.046, KRW:41.5, SGD:0.041 };
        const DEFAULT_DATA = { currency:{base:'TWD',symbol:'NT$'}, categories:{} };

        function initCurrencyUI() {
            const buttons = document.querySelectorAll('#currencyArea button');
            const select = document.getElementById('otherCurrency');
            let current = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUR)) || DEFAULT_DATA.currency;

            function updateUI(base){
                buttons.forEach(b=>b.classList.toggle('active',b.dataset.currency===base));
                const isOther = Array.from(select.options).some(o=>o.value===base);
                select.classList.toggle('active',isOther); select.value=isOther?base:"";
            }

            buttons.forEach(b=>b.addEventListener('click',()=>saveCurrency(b.dataset.currency)));
            select.addEventListener('change',()=>saveCurrency(select.value));
            updateUI(current.base);

            function saveCurrency(base){
                const setting={base,symbol:SYMBOL_MAP[base]||base};
                localStorage.setItem(STORAGE_KEYS.CUR,JSON.stringify(setting));
                updateUI(base);
            }
        }

        document.addEventListener('DOMContentLoaded',()=>initCurrencyUI());

        const confirmInput=document.getElementById('confirmResetInput');
        const finalDeleteBtn=document.getElementById('finalDeleteBtn');
        confirmInput.addEventListener('input',()=>{
            const active = confirmInput.value.trim().toUpperCase()==='RESET';
            finalDeleteBtn.disabled = !active;
            finalDeleteBtn.classList.toggle('active',active);
        });

        function clearAllData(){
            if(!confirm('ğŸš¨ æœ€å¾Œè­¦å‘Šï¼šæ•¸æ“šå³å°‡æ°¸ä¹…åˆªé™¤ï¼')) return;
            finalDeleteBtn.innerHTML='<i class="fas fa-skull-crossbones"></i> æ­£åœ¨æŠ¹é™¤æ•¸æ“šæ ¸å¿ƒ...';
            finalDeleteBtn.disabled=true;
            setTimeout(()=>{
                Object.values(STORAGE_KEYS).forEach(k=>localStorage.removeItem(k));
                alert('ğŸ›‘ ç³»çµ±å·²åˆå§‹åŒ–ã€‚æ‰€æœ‰æ•¸æ“šå·²æ­¸é›¶ã€‚');
                location.reload();
            },1500);
        }

        async function exportFullBackup(){
            const zip=new JSZip();
            const txData=JSON.parse(localStorage.getItem(STORAGE_KEYS.TX)||'[]');
            const catData=JSON.parse(localStorage.getItem(STORAGE_KEYS.CAT)||'{}');
            const budData=JSON.parse(localStorage.getItem(STORAGE_KEYS.BUD)||'{}');
            const curData=JSON.parse(localStorage.getItem(STORAGE_KEYS.CUR)||'{}');
            const imgData=JSON.parse(localStorage.getItem(STORAGE_KEYS.IMGS)||'{}');

            const payload={meta:{app:'LumiTrack',version:'1.2',exportedAt:new Date().toISOString()},transactions:txData,categories:catData,budgets:budData,currency:curData,images:imgData};
            zip.file('lumi_data_backup.json',JSON.stringify(payload,null,2));

            const wb=XLSX.utils.book_new();
            const detailRows=txData.map(t=>({
                æ—¥æœŸ:t.date||'',
                é¡å‹:t.type==='income'?'æ”¶å…¥':'æ”¯å‡º',
                ä¸»åˆ†é¡:t.categoryObject?.primary?.name||'æœªåˆ†é¡',
                å­åˆ†é¡:t.categoryObject?.sub?.name||'-',
                é‡‘é¡:Number(t.amount||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}),
                åŸå§‹è²¨å¹£:SYMBOL_MAP[t.currency]||t.currency||curData.base,
                å‚™è¨»:t.note||''
            }));
            XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(detailRows),'äº¤æ˜“æ˜ç´°');

            const summaryMap={};
            txData.forEach(t=>{
                const key=`${t.type}|${t.categoryObject?.primary?.name||'æœªåˆ†é¡'}`;
                if(!summaryMap[key]) summaryMap[key]={é¡å‹:t.type==='income'?'æ”¶å…¥':'æ”¯å‡º',åˆ†é¡:t.categoryObject?.primary?.name||'æœªåˆ†é¡',ç¸½é¡:0,ç­†æ•¸:0};
                summaryMap[key].ç¸½é¡+=Number(t.baseAmount||t.amount||0); summaryMap[key].ç­†æ•¸+=1;
            });
            XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(Object.values(summaryMap)),'åˆ†é¡çµ±è¨ˆåœ–è¡¨æ•¸æ“š');

            const excelBuffer=XLSX.write(wb,{bookType:'xlsx',type:'array'});
            zip.file('æ•¸æ“šåˆ†æå ±è¡¨.xlsx',excelBuffer);

            const content=await zip.generateAsync({type:'blob'});
            const timestamp=new Date().toISOString().replace(/[:.]/g,'-');
            saveAs(content,`LumiTrack_Backup_${timestamp}.zip`);
        }

        /* ===== é‚„åŸå‚™ä»½ ZIP ===== */
        document.getElementById('importZipFile').addEventListener('change', async (e)=>{
            const file=e.target.files[0];
            if(!file) return;
            if(!confirm('âš ï¸ å³å°‡é‚„åŸå‚™ä»½ï¼Œç¾æœ‰æ•¸æ“šå°‡è¢«è¦†è“‹ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
            try{
                const zip = await JSZip.loadAsync(file);
                const jsonFile = zip.file('lumi_data_backup.json');
                if(!jsonFile) { alert('âŒ ZIP ä¸­æ‰¾ä¸åˆ°å‚™ä»½è³‡æ–™'); return; }
                const content = await jsonFile.async('string');
                const data = JSON.parse(content);

                localStorage.setItem(STORAGE_KEYS.TX, JSON.stringify(data.transactions||[]));
                localStorage.setItem(STORAGE_KEYS.CAT, JSON.stringify(data.categories||{}));
                localStorage.setItem(STORAGE_KEYS.BUD, JSON.stringify(data.budgets||{}));
                localStorage.setItem(STORAGE_KEYS.CUR, JSON.stringify(data.currency||{base:'TWD',symbol:'NT$'}));
                localStorage.setItem(STORAGE_KEYS.IMGS, JSON.stringify(data.images||{}));

                alert('âœ… å‚™ä»½å·²æˆåŠŸé‚„åŸï¼');

                // è‡ªå‹•åˆ·æ–°è²¨å¹£ UI
                initCurrencyUI();
            }catch(err){
                console.error(err);
                alert('âŒ é‚„åŸéç¨‹å‡ºç¾éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼');
            }
        });
    </script>
</body>
</html>
